<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Beam Testing Guide</title>
  <meta name="description" content="Apache Beam is an open source, unified model and set of language-specific SDKs for defining and executing data processing workflows, and also data ingestion and integration flows, supporting Enterprise Integration Patterns (EIPs) and Domain Specific Languages (DSLs). Dataflow pipelines simplify the mechanics of large-scale batch and streaming data processing and can run on a number of runtimes like Apache Flink, Apache Spark, and Google Cloud Dataflow (a cloud service). Beam also brings DSL in different languages, allowing users to easily implement their data integration processes.
">
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400" rel="stylesheet">
  <link rel="stylesheet" href="/css/site.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/language-switch.js"></script>
  <link rel="canonical" href="https://beam.apache.org/contribute/testing/" data-proofer-ignore>
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="alternate" type="application/rss+xml" title="Apache Beam" href="https://beam.apache.org/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-73650088-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>

  <body class="body ">
    <nav class="header navbar navbar-fixed-top">
    <div class="navbar-header">
      <a href="/" class="navbar-brand" >
        <img alt="Brand" style="height: 25px" src="/images/beam_logo_navbar.png">
      </a>
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Get Started <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/get-started/beam-overview/">Beam Overview</a></li>
            <li><a href="/get-started/quickstart-java/">Quickstart - Java</a></li>
            <li><a href="/get-started/quickstart-py/">Quickstart - Python</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Example Walkthroughs</li>
            <li><a href="/get-started/wordcount-example/">WordCount</a></li>
            <li><a href="/get-started/mobile-gaming-example/">Mobile Gaming</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Resources</li>
            <li><a href="/get-started/downloads">Downloads</a></li>
            <li><a href="/get-started/support">Support</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/documentation">Using the Documentation</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Beam Concepts</li>
            <li><a href="/documentation/programming-guide/">Programming Guide</a></li>
            <li><a href="/documentation/execution-model/">Execution Model</a></li>
            <li><a href="/documentation/resources/">Additional Resources</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Pipeline Fundamentals</li>
            <li><a href="/documentation/pipelines/design-your-pipeline/">Design Your Pipeline</a></li>
            <li><a href="/documentation/pipelines/create-your-pipeline/">Create Your Pipeline</a></li>
            <li><a href="/documentation/pipelines/test-your-pipeline/">Test Your Pipeline</a></li>
            <li><a href="/documentation/io/io-toc/">Pipeline I/O</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">SDKs</li>
            <li><a href="/documentation/sdks/java/">Java SDK</a></li>
            <li><a href="/documentation/sdks/javadoc/2.1.0/" target="_blank">Java SDK API Reference <img src="/images/external-link-icon.png"
                                                                                                                                               width="14" height="14"
                                                                                                                                                          alt="External link."></a>
            </li>
            <li><a href="/documentation/sdks/python/">Python SDK</a></li>
            <li><a href="/documentation/sdks/pydoc/2.1.0/" target="_blank">Python SDK API Reference <img src="/images/external-link-icon.png"
                                                                                                                                               width="14" height="14"
                                                                                                                                                          alt="External link."></a>
            </li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Runners</li>
            <li><a href="/documentation/runners/capability-matrix/">Capability Matrix</a></li>
            <li><a href="/documentation/runners/direct/">Direct Runner</a></li>
            <li><a href="/documentation/runners/apex/">Apache Apex Runner</a></li>
            <li><a href="/documentation/runners/flink/">Apache Flink Runner</a></li>
            <li><a href="/documentation/runners/gearpump/">Apache Gearpump Runner</a></li>
            <li><a href="/documentation/runners/spark/">Apache Spark Runner</a></li>
            <li><a href="/documentation/runners/dataflow/">Cloud Dataflow Runner</a></li>

            <li role="separator" class="divider"></li>
            <li class="dropdown-header">DSLs</li>
            <li><a href="/documentation/dsls/sql/">SQL</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Contribute <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/contribute">Get Started Contributing</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Guides</li>
            <li><a href="/contribute/contribution-guide/">Contribution Guide</a></li>
            <li><a href="/contribute/testing/">Testing Guide</a></li>
            <li><a href="/contribute/release-guide/">Release Guide</a></li>
            <li><a href="/contribute/ptransform-style-guide/">PTransform Style Guide</a></li>
            <li><a href="/contribute/runner-guide/">Runner Authoring Guide</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Technical References</li>
            <li><a href="/contribute/design-principles/">Design Principles</a></li>
            <li><a href="/contribute/work-in-progress/">Ongoing Projects</a></li>
            <li><a href="/contribute/source-repository/">Source Repository</a></li>
            <li><a href="/contribute/docker-images/">Docker Images</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-header">Promotion</li>
            <li><a href="/contribute/presentation-materials/">Presentation Materials</a></li>
            <li><a href="/contribute/logos/">Logos and Design</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="/contribute/maturity-model/">Maturity Model</a></li>
            <li><a href="/contribute/team/">Team</a></li>
          </ul>
        </li>

        <li><a href="/blog">Blog</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><img src="https://www.apache.org/foundation/press/kit/feather_small.png" alt="Apache Logo" style="height:20px;"><span class="caret"></span></a>
          <ul class="dropdown-menu dropdown-menu-right">
            <li><a href="http://www.apache.org/">ASF Homepage</a></li>
            <li><a href="http://www.apache.org/licenses/">License</a></li>
            <li><a href="http://www.apache.org/security/">Security</a></li>
            <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
            <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
            <li><a href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a></li>
          </ul>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
</nav>

    <div class="body__contained">
      <h1 id="beam-testing-documentation">Beam Testing Documentation</h1>

<ul id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#testing-matrix" id="markdown-toc-testing-matrix">Testing Matrix</a>    <ul>
      <li><a href="#java-sdk" id="markdown-toc-java-sdk">Java SDK</a></li>
      <li><a href="#python-sdk" id="markdown-toc-python-sdk">Python SDK</a></li>
    </ul>
  </li>
  <li><a href="#testing-scenarios" id="markdown-toc-testing-scenarios">Testing Scenarios</a>    <ul>
      <li><a href="#precommit" id="markdown-toc-precommit">Precommit</a></li>
      <li><a href="#postcommit" id="markdown-toc-postcommit">Postcommit</a></li>
    </ul>
  </li>
  <li><a href="#testing-types" id="markdown-toc-testing-types">Testing Types</a>    <ul>
      <li><a href="#unit" id="markdown-toc-unit">Unit</a>        <ul>
          <li><a href="#how-to-run-needsrunner-tests" id="markdown-toc-how-to-run-needsrunner-tests">How to run NeedsRunner tests</a></li>
        </ul>
      </li>
      <li><a href="#validatesrunner" id="markdown-toc-validatesrunner">ValidatesRunner</a></li>
      <li><a href="#e2e" id="markdown-toc-e2e">E2E</a></li>
    </ul>
  </li>
  <li><a href="#testing-systems" id="markdown-toc-testing-systems">Testing Systems</a>    <ul>
      <li><a href="#e2e-testing-framework" id="markdown-toc-e2e-testing-framework">E2E Testing Framework</a></li>
      <li><a href="#validatesrunner-tests" id="markdown-toc-validatesrunner-tests">ValidatesRunner Tests</a></li>
      <li><a href="#effective-use-of-the-testpipeline-junit-rule" id="markdown-toc-effective-use-of-the-testpipeline-junit-rule">Effective use of the TestPipeline JUnit rule</a></li>
      <li><a href="#api-surface-testing" id="markdown-toc-api-surface-testing">API Surface testing</a></li>
    </ul>
  </li>
</ul>

<h2 id="overview">Overview</h2>

<p>Apache Beam is a rapidly-maturing software project with a strong
commitment to testing. Consequently, it has many testing-related needs. It
requires precommit tests to ensure code going into the repository meets a
certain quality bar and it requires ongoing postcommit tests to make sure that
more subtle changes which escape precommit are nonetheless caught. This document
outlines how to write tests, which tests are appropriate where, and when tests
are run, with some additional information about the testing systems at the
bottom.</p>

<p>If you’re writing tests, take a look at the testing matrix first, find what you
want to test, then look into the “Scenarios” and “Types” sections below for more
details on those testing types.</p>

<h2 id="testing-matrix">Testing Matrix</h2>

<h3 id="java-sdk">Java SDK</h3>

<table>
  <tr>
   <td><strong>Component to Test</strong>
   </td>
   <td><strong>Test Scenario</strong>
   </td>
   <td><strong>Tool to Use</strong>
   </td>
   <td><strong>Link to Example</strong>
   </td>
   <td><strong>Type</strong>
   </td>
   <td><strong>Runs In</strong>
   </td>
  </tr>
  <tr>
   <td>DoFn
   </td>
   <td>Correctness on one/few bundles
   </td>
   <td>DoFnTester
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIOTest.java#L1325">BigQueryIOTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit, Postcommit
   </td>
  </tr>
  <tr>
   <td>BoundedSource
   </td>
   <td>Correctly Reads Input
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/SourceTestUtils.java#L128">SourceTestUtils.readFromSource</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/84a0dd1714028370befa80dea16f720edce05252/sdks/java/core/src/test/java/org/apache/beam/sdk/io/TextIOTest.java#L972">TextIOTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit, Postcommit
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>Correct Initial Splitting
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/SourceTestUtils.java#L201">SourceTestUtils.assertSourcesEqualReferenceSource</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/8b1e64a668489297e11926124c4eee6c8f69a3a7/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigtable/BigtableIOTest.java#L339">BigtableTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit, Postcommit
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>Correct Dynamic Splitting
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/SourceTestUtils.java#L541">SourceTestUtils. assertSplitAtFractionExhaustive</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/84a0dd1714028370befa80dea16f720edce05252/sdks/java/core/src/test/java/org/apache/beam/sdk/io/TextIOTest.java#L1021">TextIOTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit, Postcommit
   </td>
  </tr>
  <tr>
   <td>Transform
   </td>
   <td>Correctness
   </td>
   <td>@NeedsRunner Test
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java#L1199">ParDoTest</a>
   </td>
   <td>@NeedsRunner
   </td>
   <td>
   </td>
  </tr>
  <tr>
   <td>Example Pipeline
   </td>
   <td>Verify Behavior on Each Runner
   </td>
   <td>E2E Test
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/examples/java/src/test/java/org/apache/beam/examples/WordCountIT.java#L76">WordCountIT</a>
   </td>
   <td>E2E
   </td>
   <td>Postcommit (Except WordCountIT)
   </td>
  </tr>
  <tr>
   <td>Source/Sink with external resource
   </td>
   <td>External Resource Faked
   </td>
   <td>Unit / @NeedsRunner Test
   </td>
   <td><a href="https://github.com/apache/beam/blob/84a0dd1714028370befa80dea16f720edce05252/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigtable/BigtableIOTest.java#L646">FakeBigtableService in BigtableTest</a>
   </td>
   <td>Unit / @NeedsRunner
   </td>
   <td>Precommit / Postcommit
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>Real Interactions With External Resource
   </td>
   <td>E2E Test
   </td>
   <td><a href="https://github.com/apache/beam/blob/84a0dd1714028370befa80dea16f720edce05252/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigtable/BigtableReadIT.java#L40">BigtableReadIT</a>
   </td>
   <td>E2E
   </td>
   <td>Postcommit
   </td>
  </tr>
  <tr>
   <td>Runner
   </td>
   <td>Correctness
   </td>
   <td>E2E Test, <a href="https://github.com/apache/beam/blob/master/runners/pom.xml#L47">@ValidatesRunner</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/examples/java/src/test/java/org/apache/beam/examples/WordCountIT.java#L78">WordCountIT</a>, <a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/transforms/ParDoTest.java">ParDoTest</a>
   </td>
   <td>E2E, @ValidatesRunner
   </td>
   <td>Postcommit
   </td>
  </tr>
  <tr>
   <td>Coders
   </td>
   <td>Encoding/decoding elements
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/CoderProperties.java">CoderProperties</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/coders/NullableCoderTest.java">NullableCoderTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit / Postcommit
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>Serialization/deserialization of Coder
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/CoderProperties.java">CoderProperties</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/coders/NullableCoderTest.java">NullableCoderTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit / Postcommit
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>Sizing of elements
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/CoderProperties.java">CoderProperties</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/coders/NullableCoderTest.java">NullableCoderTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit / Postcommit
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>Deterministic
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/CoderProperties.java">CoderProperties</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/coders/NullableCoderTest.java">NullableCoderTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit / Postcommit
   </td>
  </tr>
  <tr>
   <td>
   </td>
   <td>Structural value equality
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/CoderProperties.java">CoderProperties</a>
   </td>
   <td><a href="https://github.com/apache/beam/blob/master/sdks/java/core/src/test/java/org/apache/beam/sdk/coders/NullableCoderTest.java">NullableCoderTest</a>
   </td>
   <td>Unit
   </td>
   <td>Precommit / Postcommit
   </td>
  </tr>
</table>

<h3 id="python-sdk">Python SDK</h3>

<p>The Python SDK has postcommit tests by a Jenkins build; precommit testing and a
full testing matrix will be coming soon.</p>

<h2 id="testing-scenarios">Testing Scenarios</h2>

<p>With the tools at our disposal, we have a good set of utilities which we can use
to verify Beam correctness. To ensure an ongoing high quality of code, we use
precommit and postcommit testing.</p>

<h3 id="precommit">Precommit</h3>

<p>For precommit testing, Beam uses
<a href="https://builds.apache.org/view/A-D/view/Beam/">Jenkins</a> and a code coverage tool
called <a href="https://coveralls.io/github/apache/beam">Coveralls</a>, hooked up
to <a href="https://github.com/apache/beam">Github</a>, to ensure that pull
requests meet a certain quality bar. These precommits verify correctness via two
of the below testing tools: unit tests (with coverage monitored by Coveralls)
and E2E tests. We run the full slate of unit tests in precommit, ensuring
correctness at a basic level, and then run the WordCount E2E test in both batch
and streaming (coming soon!) against each supported SDK / runner combination as
a smoke test, to verify that a basic level of functionality exists. We think
that this hits the appropriate tradeoff between a desire for short (ideally
&lt;30m) precommit times and a desire to verify that pull requests going into Beam
function in the way in which they are intended.</p>

<p>Precommit tests are kicked off when a user makes a Pull Request against the
<code class="highlighter-rouge">apache/beam</code> repository and the Jenkins and Coveralls statuses are displayed at
the bottom of the pull request page. Clicking on “Details” will open the status
page in the selected tool; there, test status and output can be viewed.</p>

<h3 id="postcommit">Postcommit</h3>

<p>Running in postcommit removes as stringent of a time constraint, which gives us
the ability to do some more comprehensive testing. In postcommit we have a test
suite running the ValidatesRunner tests against each supported runner, and
another for running the full set of E2E tests against each runner.
Currently-supported runners are Dataflow, Flink, Spark, and Gearpump, with
others soon to follow. Work is ongoing to enable Flink, Spark, and Gearpump in
the E2E framework, with full support targeted for end of August 2016. Postcommit
tests run periodically, with timing defined in their Jenkins configurations.</p>

<p>Adding new postcommit E2E tests is generally as easy as adding a *IT.java file
to the repository - Failsafe will notice it and run it - but if you want to do
more interesting things, take a look at
<a href="https://github.com/apache/beam/blob/master/examples/java/src/test/java/org/apache/beam/examples/WordCountIT.java">WordCountIT.java</a>.</p>

<p>Postcommit test results can be found in
<a href="https://builds.apache.org/view/A-D/view/Beam/">Jenkins</a>.</p>

<h2 id="testing-types">Testing Types</h2>

<h3 id="unit">Unit</h3>

<p>Unit tests are, in Beam as everywhere else, the first line of defense in
ensuring software correctness. As all of the contributors to Beam understand the
importance of testing, Beam has a robust set of unit tests, as well as testing
coverage measurement tools, which protect the codebase from simple to moderate
breakages. Beam Java unit tests are written in JUnit.</p>

<h4 id="how-to-run-needsrunner-tests">How to run NeedsRunner tests</h4>

<p>NeedsRunner is a category of tests that require a Beam runner. A subset of these
tests cannot be executed while building their corresponding modules because all 
runners depend on these modules (e.g. <code class="highlighter-rouge">sdks/java/core</code>) to be built. To break 
the circular dependency, these tests are executed after the Direct Runner is 
built.</p>

<p>To run this subset of the NeedsRunner tests (requires Maven 3.3.1+):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mvn -pl runners/direct-java -am install -DskipTests
$ mvn -pl runners/direct-java surefire:test@validates-runner-tests
</code></pre>
</div>

<p>To run a single NeedsRunner test use the <code class="highlighter-rouge">test</code> property, e.g.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mvn -pl runners/direct-java surefire:test@validates-runner-tests -Dtest=MapElementsTest#testMapBasic
</code></pre>
</div>

<p>will run the <code class="highlighter-rouge">MapElementsTest.testMapBasic()</code> test.</p>

<p>NeedsRunner tests in modules that are not required to build runners (e.g. 
<code class="highlighter-rouge">sdks/java/io/jdbc</code>) can be executed with the <code class="highlighter-rouge">mvn test</code> command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mvn -pl sdks/java/io/jdbc test -Dgroups=org.apache.beam.sdk.testing.NeedsRunner
</code></pre>
</div>

<h3 id="validatesrunner">ValidatesRunner</h3>

<p>ValidatesRunner tests contain components of both component and end-to-end
tests. They fulfill the typical purpose of a component test - they are meant to
test a well-scoped piece of Beam functionality or the interactions between two
such pieces and can be run in a component-test-type fashion against the
DirectRunner. Additionally, they are built with the ability to run in an
end-to-end fashion against a runner, allowing them to verify not only core Beam
functionality, but runner functionality as well. They are more lightweight than
a traditional end-to-end test and, because of their well-scoped nature, provide
good signal as to what exactly is working or broken against a particular runner.</p>

<h3 id="e2e">E2E</h3>

<p>End-to-End tests are meant to verify at the very highest level that the Beam
codebase is working as intended. Because they are implemented as a thin wrapper
around existing pipelines, they can be used to prove that the core Beam
functionality is available. They will be used to verify runner correctness, but
they can also be used for IO connectors and other core functionality.</p>

<h2 id="testing-systems">Testing Systems</h2>

<h3 id="e2e-testing-framework">E2E Testing Framework</h3>

<p>The Beam end-to-end testing framework is a framework designed in a
runner-agnostic fashion to exercise the entire lifecycle of a Beam pipeline. We
run a pipeline as a user would and allow it to run to completion in the same
way, verifying after completion that it behaved how we expected. Using pipelines
from the Beam examples, or custom-built pipelines, the framework will provide
hooks during several pipeline lifecycle events, e.g., pipeline creation,
pipeline success, and pipeline failure, to allow verification of pipeline state.</p>

<p>The E2E testing framework is currently built to hook into the <a href="http://maven.apache.org/surefire/maven-failsafe-plugin/">Maven Failsafe
Integration Test
plugin</a>, which means it
is tightly integrated with the overall build process. Once it is determined how
Python and other future languages will integrate into the overall build/test
system (via Maven or otherwise) we will adjust this. The framework provides a
wrapper around actual Beam pipelines, enabling those pipelines to be run in an
environment which facilitates verification of pipeline results and details.</p>

<p>Verifiers include:</p>

<ul>
  <li>Output verification. Output verifiers ensure that the pipeline has produced
the expected output. Current verifiers check text-based output, but future
verifiers could support other output such as BigQuery and Datastore.</li>
  <li>Aggregator verification. Aggregator verifiers ensure that the user-defined
aggregators present in the pipelines under test finish in the expected
state.</li>
</ul>

<p>The E2E framework will support running on various different configurations of
environments. We currently provide the ability to run against the DirectRunner,
against a local Spark instance, a local Flink instance, and against the Google
Cloud Dataflow service.</p>

<h3 id="validatesrunner-tests">ValidatesRunner Tests</h3>

<p>ValidatesRunner tests are tests built to use the Beam TestPipeline class,
which enables test authors to write simple functionality verification. They are
meant to use some of the built-in utilities of the SDK, namely PAssert, to
verify that the simple pipelines they run end in the correct state.</p>

<h3 id="effective-use-of-the-testpipeline-junit-rule">Effective use of the TestPipeline JUnit rule</h3>

<p><code class="highlighter-rouge">TestPipeline</code> is JUnit rule designed to facilitate testing pipelines. 
In combination with <code class="highlighter-rouge">PAssert</code>, the two can be used for testing and 
writing assertions over pipelines. However, in order for these assertions 
to be effective, the constructed pipeline <strong>must</strong> be run by a pipeline 
runner. If the pipeline is not run (i.e., executed) then the 
constructed <code class="highlighter-rouge">PAssert</code> statements will not be triggered, and will thus 
be ineffective.</p>

<p>To prevent such cases, <code class="highlighter-rouge">TestPipeline</code> has some protection mechanisms in place.</p>

<p><strong>Abandoned node detection (performed automatically)</strong></p>

<p>Abandoned nodes are <code class="highlighter-rouge">PTransforms</code>, <code class="highlighter-rouge">PAsserts</code> included, that were not 
executed by the pipeline runner. Abandoned nodes are most likely to occur 
due to the one of the following scenarios:</p>
<ol>
  <li>Lack of a <code class="highlighter-rouge">pipeline.run()</code> statement at the end of a test.</li>
  <li>Addition of <code class="highlighter-rouge">PTransform</code>s  after the pipeline has already run.</li>
</ol>

<p>Abandoned node detection is <em>automatically enabled</em> when a real pipeline 
runner (i.e. not a <code class="highlighter-rouge">CrashingRunner</code>) and/or a 
<code class="highlighter-rouge">@NeedsRunner</code> / <code class="highlighter-rouge">@ValidatesRunner</code> annotation are detected.</p>

<p>Consider the following test:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// Note the @Rule annotation here</span>
<span class="nd">@Rule</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">transient</span> <span class="n">TestPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>

<span class="nd">@Test</span>
<span class="nd">@Category</span><span class="o">(</span><span class="n">NeedsRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">myPipelineTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

<span class="kd">final</span> <span class="n">PCollection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">pCollection</span> <span class="o">=</span> 
  <span class="n">pipeline</span>
    <span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="s">"Create"</span><span class="o">,</span> <span class="n">Create</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">WORDS</span><span class="o">).</span><span class="na">withCoder</span><span class="o">(</span><span class="n">StringUtf8Coder</span><span class="o">.</span><span class="na">of</span><span class="o">()))</span>
    <span class="o">.</span><span class="na">apply</span><span class="o">(</span>
        <span class="s">"Map1"</span><span class="o">,</span>
        <span class="n">MapElements</span><span class="o">.</span><span class="na">via</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">SimpleFunction</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>

              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="n">String</span> <span class="nf">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">WHATEVER</span><span class="o">;</span>
              <span class="o">}</span>
            <span class="o">}));</span>
            
<span class="n">PAssert</span><span class="o">.</span><span class="na">that</span><span class="o">(</span><span class="n">pCollection</span><span class="o">).</span><span class="na">containsInAnyOrder</span><span class="o">(</span><span class="n">WHATEVER</span><span class="o">);</span>       

<span class="cm">/* ERROR: pipeline.run() is missing, PAsserts are ineffective */</span>
<span class="o">}</span>
</code></pre>
</div>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="c"># Unsupported in Beam's Python SDK.</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">PAssert</code> at the end of this test method will not be executed, since 
<code class="highlighter-rouge">pipeline</code> is never run, making this test ineffective. If this test method 
is run using an actual pipeline runner, an exception will be thrown 
indicating that there was no <code class="highlighter-rouge">run()</code> invocation in the test.</p>

<p>Exceptions that are thrown prior to executing a pipeline, will fail 
the test unless handled by an <code class="highlighter-rouge">ExpectedException</code> rule.</p>

<p>Consider the following test:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// Note the @Rule annotation here</span>
<span class="nd">@Rule</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">transient</span> <span class="n">TestPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReadingFailsTableDoesNotExist</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="n">String</span> <span class="n">table</span> <span class="o">=</span> <span class="s">"TEST-TABLE"</span><span class="o">;</span>

  <span class="n">BigtableIO</span><span class="o">.</span><span class="na">Read</span> <span class="n">read</span> <span class="o">=</span>
      <span class="n">BigtableIO</span><span class="o">.</span><span class="na">read</span><span class="o">()</span>
          <span class="o">.</span><span class="na">withBigtableOptions</span><span class="o">(</span><span class="n">BIGTABLE_OPTIONS</span><span class="o">)</span>
          <span class="o">.</span><span class="na">withTableId</span><span class="o">(</span><span class="n">table</span><span class="o">)</span>
          <span class="o">.</span><span class="na">withBigtableService</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>

  <span class="c1">// Exception will be thrown by read.validate() when read is applied.</span>
  <span class="n">thrown</span><span class="o">.</span><span class="na">expect</span><span class="o">(</span><span class="n">IllegalArgumentException</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">thrown</span><span class="o">.</span><span class="na">expectMessage</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Table %s does not exist"</span><span class="o">,</span> <span class="n">table</span><span class="o">));</span>

  <span class="n">p</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">read</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="c"># Unsupported in Beam's Python SDK.</span>
</code></pre>
</div>

<p>The application of the <code class="highlighter-rouge">read</code> transform throws an exception, which is then 
handled by the <code class="highlighter-rouge">thrown</code> <code class="highlighter-rouge">ExpectedException</code> rule. 
In light of this exception, the fact this test has abandoned nodes 
(the <code class="highlighter-rouge">read</code> transform) does not play a role since the test fails before 
the pipeline would have been executed (had there been a <code class="highlighter-rouge">run()</code> statement).</p>

<p><strong>Auto-add <code class="highlighter-rouge">pipeline.run()</code> (disabled by default)</strong></p>

<p>A <code class="highlighter-rouge">TestPipeline</code> instance can be configured to auto-add a missing <code class="highlighter-rouge">run()</code> 
statement by setting <code class="highlighter-rouge">testPipeline.enableAutoRunIfMissing(true/false)</code>. 
If this feature is enabled, no exception will be thrown in case of a 
missing <code class="highlighter-rouge">run()</code> statement, instead, one will be added automatically.</p>

<h3 id="api-surface-testing">API Surface testing</h3>

<p>The surface of an API is the set of public classes that are exposed to the 
outer world. In order to keep the API tight and avoid unnecessarily exposing 
classes, Beam provides the <code class="highlighter-rouge">ApiSurface</code> utility class. 
Using the <code class="highlighter-rouge">ApiSurface</code> class,  we can assert the API surface against an 
expected set of classes.</p>

<p>Consider the following snippet:</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testMyApiSurface</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
  
    <span class="kd">final</span> <span class="n">Package</span> <span class="n">thisPackage</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getPackage</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">thisClassLoader</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">();</span>
    
    <span class="kd">final</span> <span class="n">ApiSurface</span> <span class="n">apiSurface</span> <span class="o">=</span>
        <span class="n">ApiSurface</span><span class="o">.</span><span class="na">ofPackage</span><span class="o">(</span><span class="n">thisPackage</span><span class="o">,</span> <span class="n">thisClassLoader</span><span class="o">)</span>
            <span class="o">.</span><span class="na">pruningPattern</span><span class="o">(</span><span class="s">"org[.]apache[.]beam[.].*Test.*"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">pruningPattern</span><span class="o">(</span><span class="s">"org[.]apache[.]beam[.].*IT"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">pruningPattern</span><span class="o">(</span><span class="s">"java[.]lang.*"</span><span class="o">);</span>
    
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Matcher</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;&gt;</span> <span class="n">allowed</span> <span class="o">=</span>
        <span class="n">ImmutableSet</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
            <span class="n">classesInPackage</span><span class="o">(</span><span class="s">"org.apache.beam.x"</span><span class="o">),</span>
            <span class="n">classesInPackage</span><span class="o">(</span><span class="s">"org.apache.beam.y"</span><span class="o">),</span>
            <span class="n">classesInPackage</span><span class="o">(</span><span class="s">"org.apache.beam.z"</span><span class="o">),</span>
            <span class="n">Matchers</span><span class="o">.&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span><span class="n">equalTo</span><span class="o">(</span><span class="n">Other</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    
    <span class="n">assertThat</span><span class="o">(</span><span class="n">apiSurface</span><span class="o">,</span> <span class="n">containsOnlyClassesMatching</span><span class="o">(</span><span class="n">allowed</span><span class="o">));</span>
<span class="o">}</span>
</code></pre>
</div>

<div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="c"># Unsupported in Beam's Python SDK.</span>
</code></pre>
</div>

<p>This test will fail if the classes exposed by <code class="highlighter-rouge">getClass().getPackage()</code>, except 
classes which reside under <code class="highlighter-rouge">"org[.]apache[.]beam[.].*Test.*"</code>,<br />
<code class="highlighter-rouge">"org[.]apache[.]beam[.].*IT"</code> or <code class="highlighter-rouge">"java[.]lang.*"</code>, belong to neither
of the packages: <code class="highlighter-rouge">org.apache.beam.x</code>, <code class="highlighter-rouge">org.apache.beam.y</code>, <code class="highlighter-rouge">org.apache.beam.z</code>, 
nor equal to <code class="highlighter-rouge">Other.class</code>.</p>

    </div>
    <footer class="footer">
  <div class="footer__contained">
    <div class="footer__cols">
      <div class="footer__cols__col">
        <div class="footer__cols__col__logo">
          <img src="/images/beam_logo_circle.svg" class="footer__logo" alt="Beam logo">
        </div>
        <div class="footer__cols__col__logo">
          <img src="/images/apache_logo_circle.svg" class="footer__logo" alt="Apache logo">
        </div>
      </div>
      <div class="footer__cols__col footer__cols__col--md">
        <div class="footer__cols__col__title">Start</div>
        <div class="footer__cols__col__link"><a href="/get-started/beam-overview/">Overview</a></div>
        <div class="footer__cols__col__link"><a href="/get-started/quickstart-java/">Quickstart (Java)</a></div>
        <div class="footer__cols__col__link"><a href="/get-started/quickstart-py/">Quickstart (Python)</a></div>
        <div class="footer__cols__col__link"><a href="/get-started/downloads/">Downloads</a></div>
      </div>
      <div class="footer__cols__col footer__cols__col--md">
        <div class="footer__cols__col__title">Docs</div>
        <div class="footer__cols__col__link"><a href="/documentation/programming-guide/">Concepts</a></div>
        <div class="footer__cols__col__link"><a href="/documentation/pipelines/design-your-pipeline/">Pipelines</a></div>
        <div class="footer__cols__col__link"><a href="/documentation/runners/capability-matrix/">Runners</a></div>
      </div>
      <div class="footer__cols__col footer__cols__col--md">
        <div class="footer__cols__col__title">Community</div>
        <div class="footer__cols__col__link"><a href="/contribute/">Contribute</a></div>
        <div class="footer__cols__col__link"><a href="/contribute/team/">Team</a></div>
        <div class="footer__cols__col__link"><a href="/contribute/presentation-materials/">Media</a></div>
      </div>
      <div class="footer__cols__col footer__cols__col--md">
        <div class="footer__cols__col__title">Resources</div>
        <div class="footer__cols__col__link"><a href="/blog/">Blog</a></div>
        <div class="footer__cols__col__link"><a href="/get-started/support/">Support</a></div>
        <div class="footer__cols__col__link"><a href="https://github.com/apache/beam">GitHub</a></div>
      </div>
    </div>
  </div>
  <div class="footer__bottom">
    &copy;
    <a href="http://www.apache.org">The Apache Software Foundation</a>
    | <a href="/privacy_policy">Privacy Policy</a>
    | <a href="/feed.xml">RSS Feed</a>
    <br><br>
    Apache Beam, Apache, Beam, the Beam logo, and the Apache feather logo are
    either registered trademarks or trademarks of The Apache Software
    Foundation. All other products or name brands are trademarks of their
    respective holders, including The Apache Software Foundation.
  </div>
</footer>

  </body>
</html>
