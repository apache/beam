<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>apache_beam.transforms.ptransform_test &#8212; Apache Beam  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Apache Beam  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for apache_beam.transforms.ptransform_test</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="c1"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="c1"># this work for additional information regarding copyright ownership.</span>
<span class="c1"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="c1"># (the &quot;License&quot;); you may not use this file except in compliance with</span>
<span class="c1"># the License.  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;Unit tests for the PTransform and descendants.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">import</span> <span class="nn">hamcrest</span> <span class="k">as</span> <span class="nn">hc</span>
<span class="kn">from</span> <span class="nn">nose.plugins.attrib</span> <span class="k">import</span> <span class="n">attr</span>

<span class="kn">import</span> <span class="nn">apache_beam</span> <span class="k">as</span> <span class="nn">beam</span>
<span class="kn">from</span> <span class="nn">apache_beam.test_pipeline</span> <span class="k">import</span> <span class="n">TestPipeline</span>
<span class="kn">import</span> <span class="nn">apache_beam.pvalue</span> <span class="k">as</span> <span class="nn">pvalue</span>
<span class="kn">import</span> <span class="nn">apache_beam.transforms.combiners</span> <span class="k">as</span> <span class="nn">combine</span>
<span class="kn">from</span> <span class="nn">apache_beam.transforms.display</span> <span class="k">import</span> <span class="n">DisplayData</span><span class="p">,</span> <span class="n">DisplayDataItem</span>
<span class="kn">from</span> <span class="nn">apache_beam.transforms.ptransform</span> <span class="k">import</span> <span class="n">PTransform</span>
<span class="kn">from</span> <span class="nn">apache_beam.transforms.util</span> <span class="k">import</span> <span class="n">assert_that</span><span class="p">,</span> <span class="n">equal_to</span>
<span class="kn">import</span> <span class="nn">apache_beam.typehints</span> <span class="k">as</span> <span class="nn">typehints</span>
<span class="kn">from</span> <span class="nn">apache_beam.typehints</span> <span class="k">import</span> <span class="n">with_input_types</span>
<span class="kn">from</span> <span class="nn">apache_beam.typehints</span> <span class="k">import</span> <span class="n">with_output_types</span>
<span class="kn">from</span> <span class="nn">apache_beam.typehints.typehints_test</span> <span class="k">import</span> <span class="n">TypeHintTestCase</span>
<span class="kn">from</span> <span class="nn">apache_beam.utils.pipeline_options</span> <span class="k">import</span> <span class="n">TypeOptions</span>


<span class="c1"># Disable frequent lint warning due to pipe operator for chaining transforms.</span>
<span class="c1"># pylint: disable=expression-not-assigned</span>


<div class="viewcode-block" id="PTransformTest"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest">[docs]</a><span class="k">class</span> <span class="nc">PTransformTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="PTransformTest.assertStartswith"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.assertStartswith">[docs]</a>  <span class="k">def</span> <span class="nf">assertStartswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span>
                    <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; does not start with &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTest.test_str"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_str">[docs]</a>  <span class="k">def</span> <span class="nf">test_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;&lt;PTransform(PTransform) label=[PTransform]&gt;&#39;</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">PTransform</span><span class="p">()))</span>

    <span class="n">pa</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">|</span> <span class="s1">&#39;ALabel&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;AppliedPTransform(ALabel, Create)&#39;</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">producer</span><span class="p">))</span>

    <span class="n">pc</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">inputs_tr</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">transform</span>
    <span class="n">inputs_tr</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ci&#39;</span><span class="p">,)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;&lt;Create(PTransform) label=[Create] inputs=(&#39;ci&#39;,)&gt;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">inputs_tr</span><span class="p">))</span>

    <span class="n">pd</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">side_tr</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">producer</span><span class="o">.</span><span class="n">transform</span>
    <span class="n">side_tr</span><span class="o">.</span><span class="n">side_inputs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s1">&#39;&lt;Create(PTransform) label=[Create] side_inputs=(4,)&gt;&#39;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">side_tr</span><span class="p">))</span>

    <span class="n">inputs_tr</span><span class="o">.</span><span class="n">side_inputs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;cs&#39;</span><span class="p">,)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;&lt;Create(PTransform) label=[Create] &quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;inputs=(&#39;ci&#39;,) side_inputs=(&#39;cs&#39;,)&gt;&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">inputs_tr</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_do_fn"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_do_fn">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_do_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">AddNDoFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>

      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">addon</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">element</span> <span class="o">+</span> <span class="n">addon</span><span class="p">]</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">AddNDoFn</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_unconstructed_do_fn"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_unconstructed_do_fn">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_unconstructed_do_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">MyDoFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>

      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
      <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">MyDoFn</span><span class="p">)</span>  <span class="c1"># Note the lack of ()&#39;s</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_callable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_callable">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">addon</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">addon</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_side_input_as_arg"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_side_input_as_arg">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_side_input_as_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">side</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Side&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">addon</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">addon</span><span class="p">],</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">AsSingleton</span><span class="p">(</span><span class="n">side</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_side_input_as_keyword_arg"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_side_input_as_keyword_arg">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_side_input_as_keyword_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">side</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Side&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">addon</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">addon</span><span class="p">],</span> <span class="n">addon</span><span class="o">=</span><span class="n">pvalue</span><span class="o">.</span><span class="n">AsSingleton</span><span class="p">(</span><span class="n">side</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_do_fn_returning_string_raises_warning"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_do_fn_returning_string_raises_warning">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_do_fn_returning_string_raises_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">])</span>
    <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="c1"># Since the DoFn directly returns a string we should get an error warning</span>
    <span class="c1"># us.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
      <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">expected_error_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Returning a str from a ParDo or FlatMap &#39;</span>
                             <span class="s1">&#39;is discouraged.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">expected_error_prefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_do_fn_returning_dict_raises_warning"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_do_fn_returning_dict_raises_warning">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_do_fn_returning_dict_raises_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">])</span>
    <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">})</span>

    <span class="c1"># Since the DoFn directly returns a dict we should get an error warning</span>
    <span class="c1"># us.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
      <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">expected_error_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Returning a dict from a ParDo or FlatMap &#39;</span>
                             <span class="s1">&#39;is discouraged.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">expected_error_prefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_with_side_outputs_maintains_unique_name"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_with_side_outputs_maintains_unique_name">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_with_side_outputs_maintains_unique_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;A&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">with_outputs</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;B&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">with_outputs</span><span class="p">(</span><span class="n">main</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;r1&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;r2&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

  <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;ValidatesRunner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PTransformTest.test_par_do_with_multiple_outputs_and_using_yield"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_par_do_with_multiple_outputs_and_using_yield">[docs]</a>  <span class="k">def</span> <span class="nf">test_par_do_with_multiple_outputs_and_using_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">SomeDoFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;A custom DoFn using yield.&quot;&quot;&quot;</span>

      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">element</span>
        <span class="k">if</span> <span class="n">element</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">yield</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">SideOutputValue</span><span class="p">(</span><span class="s1">&#39;even&#39;</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">yield</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">SideOutputValue</span><span class="p">(</span><span class="s1">&#39;odd&#39;</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Some Numbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">nums</span> <span class="o">|</span> <span class="s1">&#39;ClassifyNumbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span>
        <span class="n">SomeDoFn</span><span class="p">())</span><span class="o">.</span><span class="n">with_outputs</span><span class="p">(</span><span class="s1">&#39;odd&#39;</span><span class="p">,</span> <span class="s1">&#39;even&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">odd</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:odd&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">even</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:even&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

  <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;ValidatesRunner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PTransformTest.test_par_do_with_multiple_outputs_and_using_return"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_par_do_with_multiple_outputs_and_using_return">[docs]</a>  <span class="k">def</span> <span class="nf">test_par_do_with_multiple_outputs_and_using_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">some_fn</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">v</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">SideOutputValue</span><span class="p">(</span><span class="s1">&#39;even&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">pvalue</span><span class="o">.</span><span class="n">SideOutputValue</span><span class="p">(</span><span class="s1">&#39;odd&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)]</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Some Numbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">nums</span> <span class="o">|</span> <span class="s1">&#39;ClassifyNumbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span>
        <span class="n">some_fn</span><span class="p">)</span><span class="o">.</span><span class="n">with_outputs</span><span class="p">(</span><span class="s1">&#39;odd&#39;</span><span class="p">,</span> <span class="s1">&#39;even&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">odd</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:odd&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">even</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:even&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

  <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;ValidatesRunner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PTransformTest.test_undeclared_side_outputs"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_undeclared_side_outputs">[docs]</a>  <span class="k">def</span> <span class="nf">test_undeclared_side_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Some Numbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">nums</span> <span class="o">|</span> <span class="s1">&#39;ClassifyNumbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span>
                   <span class="n">pvalue</span><span class="o">.</span><span class="n">SideOutputValue</span><span class="p">(</span><span class="s1">&#39;even&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;odd&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">with_outputs</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">odd</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:odd&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">even</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:even&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

  <span class="nd">@attr</span><span class="p">(</span><span class="s1">&#39;ValidatesRunner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="PTransformTest.test_empty_side_outputs"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_empty_side_outputs">[docs]</a>  <span class="k">def</span> <span class="nf">test_empty_side_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Some Numbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">nums</span> <span class="o">|</span> <span class="s1">&#39;ClassifyNumbers&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span>
                   <span class="n">pvalue</span><span class="o">.</span><span class="n">SideOutputValue</span><span class="p">(</span><span class="s1">&#39;even&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;odd&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">with_outputs</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">odd</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:odd&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">even</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:even&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_requires_do_fn_returning_iterable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_requires_do_fn_returning_iterable">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_requires_do_fn_returning_iterable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># This function is incorrect because it returns an object that isn&#39;t an</span>
    <span class="c1"># iterable.</span>
    <span class="k">def</span> <span class="nf">incorrect_par_do_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="n">incorrect_par_do_fn</span><span class="p">)</span>
    <span class="c1"># It&#39;s a requirement that all user-defined functions to a ParDo return</span>
    <span class="c1"># an iterable.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
      <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">expected_error_prefix</span> <span class="o">=</span> <span class="s1">&#39;FlatMap and ParDo must return an iterable.&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">expected_error_prefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTest.test_do_fn_with_start_finish"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_do_fn_with_start_finish">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_fn_with_start_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">MyDoFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">start_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="s1">&#39;start&#39;</span>

      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">pass</span>

      <span class="k">def</span> <span class="nf">finish_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="s1">&#39;finish&#39;</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Do&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">MyDoFn</span><span class="p">())</span>

    <span class="c1"># May have many bundles, but each has a start and finish.</span>
    <span class="k">def</span>  <span class="nf">matcher</span><span class="p">():</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="n">equal_to</span><span class="p">([</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;finish&#39;</span><span class="p">])(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">actual</span><span class="p">)))</span>
        <span class="n">equal_to</span><span class="p">([</span><span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)])([</span><span class="n">actual</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">)])</span>
      <span class="k">return</span> <span class="n">match</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">matcher</span><span class="p">())</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_filter"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_filter">[docs]</a>  <span class="k">def</span> <span class="nf">test_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Filter&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

  <span class="k">class</span> <span class="nc">_MeanCombineFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">CombineFn</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">create_accumulator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">sum_</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">element</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">sum_</span> <span class="o">+</span> <span class="n">element</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">merge_accumulators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accumulators</span><span class="p">):</span>
      <span class="n">sums</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">accumulators</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sums</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">sum_</span><span class="p">,</span> <span class="n">count</span><span class="p">)):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">sum_</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

<div class="viewcode-block" id="PTransformTest.test_combine_with_combine_fn"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_combine_with_combine_fn">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_with_combine_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Mean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MeanCombineFn</span><span class="p">())</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_combine_with_callable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_combine_with_callable">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_with_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_combine_with_side_input_as_arg"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_combine_with_side_input_as_arg">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_with_side_input_as_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">divisor</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Divisor&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Max&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span>
        <span class="c1"># Multiples of divisor only.</span>
        <span class="k">lambda</span> <span class="n">vals</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">v</span> <span class="o">%</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">pvalue</span><span class="o">.</span><span class="n">AsSingleton</span><span class="p">(</span><span class="n">divisor</span><span class="p">))</span><span class="o">.</span><span class="n">without_defaults</span><span class="p">()</span>
    <span class="n">filt_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">v</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">filt_vals</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_combine_per_key_with_combine_fn"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_combine_per_key_with_combine_fn">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_per_key_with_combine_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">vals_1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">vals_2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals_1</span><span class="p">]</span> <span class="o">+</span>
                                               <span class="p">[(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals_2</span><span class="p">]))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Mean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombinePerKey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MeanCombineFn</span><span class="p">())</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vals_1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals_1</span><span class="p">)),</span>
                                  <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vals_2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals_2</span><span class="p">))]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_combine_per_key_with_callable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_combine_per_key_with_callable">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_per_key_with_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">vals_1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">vals_2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals_1</span><span class="p">]</span> <span class="o">+</span>
                                               <span class="p">[(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals_2</span><span class="p">]))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombinePerKey</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vals_1</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vals_2</span><span class="p">))]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_combine_per_key_with_side_input_as_arg"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_combine_per_key_with_side_input_as_arg">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_per_key_with_side_input_as_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">vals_1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">vals_2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals_1</span><span class="p">]</span> <span class="o">+</span>
                                               <span class="p">[(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals_2</span><span class="p">]))</span>
    <span class="n">divisor</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Divisor&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombinePerKey</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">vals</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">v</span> <span class="o">%</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">pvalue</span><span class="o">.</span><span class="n">AsSingleton</span><span class="p">(</span><span class="n">divisor</span><span class="p">))</span>  <span class="c1"># Multiples of divisor only.</span>
    <span class="n">m_1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals_1</span> <span class="k">if</span> <span class="n">v</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">m_2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals_2</span> <span class="k">if</span> <span class="n">v</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">m_1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">m_2</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_group_by_key"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_group_by_key">[docs]</a>  <span class="k">def</span> <span class="nf">test_group_by_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Group&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_partition_with_partition_fn"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_partition_with_partition_fn">[docs]</a>  <span class="k">def</span> <span class="nf">test_partition_with_partition_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">SomePartitionFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">PartitionFn</span><span class="p">):</span>

      <span class="k">def</span> <span class="nf">partition_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">num_partitions</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">element</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
    <span class="c1"># Attempt nominal partition operation.</span>
    <span class="n">partitions</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Part 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="n">SomePartitionFn</span><span class="p">(),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([]))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Check that a bad partition label will yield an error. For the</span>
    <span class="c1"># DirectRunner, this error manifests as an exception.</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
    <span class="n">partitions</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;Part 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="n">SomePartitionFn</span><span class="p">(),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
      <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_partition_with_callable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_partition_with_callable">[docs]</a>  <span class="k">def</span> <span class="nf">test_partition_with_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
    <span class="n">partitions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;part&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([]))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">partitions</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;p3&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_partition_followed_by_flatten_and_groupbykey"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_partition_followed_by_flatten_and_groupbykey">[docs]</a>  <span class="k">def</span> <span class="nf">test_partition_followed_by_flatten_and_groupbykey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Regression test for an issue with how partitions are handled.&quot;&quot;&quot;</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;A&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
    <span class="n">partitioned</span> <span class="o">=</span> <span class="n">created</span> <span class="o">|</span> <span class="s1">&#39;B&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">flattened</span> <span class="o">=</span> <span class="n">partitioned</span> <span class="o">|</span> <span class="s1">&#39;C&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">flattened</span> <span class="o">|</span> <span class="s1">&#39;D&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">])]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_flatten_pcollections"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_flatten_pcollections">[docs]</a>  <span class="k">def</span> <span class="nf">test_flatten_pcollections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll_1</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">pcoll_2</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcoll_1</span><span class="p">,</span> <span class="n">pcoll_2</span><span class="p">)</span> <span class="o">|</span> <span class="s1">&#39;Flatten&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_flatten_no_pcollections"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_flatten_no_pcollections">[docs]</a>  <span class="k">def</span> <span class="nf">test_flatten_no_pcollections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
      <span class="p">()</span> <span class="o">|</span> <span class="s1">&#39;PipelineArgMissing&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">()</span> <span class="o">|</span> <span class="s1">&#39;Empty&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_flatten_pcollections_in_iterable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_flatten_pcollections_in_iterable">[docs]</a>  <span class="k">def</span> <span class="nf">test_flatten_pcollections_in_iterable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll_1</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">pcoll_2</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">pcoll</span> <span class="k">for</span> <span class="n">pcoll</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pcoll_1</span><span class="p">,</span> <span class="n">pcoll_2</span><span class="p">)]</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_flatten_input_type_must_be_iterable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_flatten_input_type_must_be_iterable">[docs]</a>  <span class="k">def</span> <span class="nf">test_flatten_input_type_must_be_iterable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Inputs to flatten *must* be an iterable.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
      <span class="mi">4</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_flatten_input_type_must_be_iterable_of_pcolls"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_flatten_input_type_must_be_iterable_of_pcolls">[docs]</a>  <span class="k">def</span> <span class="nf">test_flatten_input_type_must_be_iterable_of_pcolls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Inputs to flatten *must* be an iterable of PCollections.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
      <span class="p">{</span><span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">}</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
      <span class="nb">set</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_co_group_by_key_on_list"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_co_group_by_key_on_list">[docs]</a>  <span class="k">def</span> <span class="nf">test_co_group_by_key_on_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll_1</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
    <span class="n">pcoll_2</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcoll_1</span><span class="p">,</span> <span class="n">pcoll_2</span><span class="p">)</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">CoGroupByKey</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])),</span>
                                  <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="p">[])),</span>
                                  <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_co_group_by_key_on_iterable"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_co_group_by_key_on_iterable">[docs]</a>  <span class="k">def</span> <span class="nf">test_co_group_by_key_on_iterable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll_1</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
    <span class="n">pcoll_2</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">pc</span> <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pcoll_1</span><span class="p">,</span> <span class="n">pcoll_2</span><span class="p">)]</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">CoGroupByKey</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])),</span>
                                  <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">([</span><span class="mi">3</span><span class="p">],</span> <span class="p">[])),</span>
                                  <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_co_group_by_key_on_dict"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_co_group_by_key_on_dict">[docs]</a>  <span class="k">def</span> <span class="nf">test_co_group_by_key_on_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll_1</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
    <span class="n">pcoll_2</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start 2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">pcoll_1</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">pcoll_2</span><span class="p">}</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">CoGroupByKey</span><span class="p">()</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]}),</span>
                                  <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="p">[]}),</span>
                                  <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]})]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_group_by_key_input_must_be_kv_pairs"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_group_by_key_input_must_be_kv_pairs">[docs]</a>  <span class="k">def</span> <span class="nf">test_group_by_key_input_must_be_kv_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcolls</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;A&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">pcolls</span> <span class="o">|</span> <span class="s1">&#39;D&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">()</span>
      <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s1">&#39;Input type hint violation at D: expected &#39;</span>
        <span class="s1">&#39;Tuple[TypeVariable[K], TypeVariable[V]]&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTest.test_group_by_key_only_input_must_be_kv_pairs"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_group_by_key_only_input_must_be_kv_pairs">[docs]</a>  <span class="k">def</span> <span class="nf">test_group_by_key_only_input_must_be_kv_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcolls</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;A&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
      <span class="n">pcolls</span> <span class="o">|</span> <span class="s1">&#39;D&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKeyOnly</span><span class="p">()</span>
      <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">expected_error_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Input type hint violation at D: expected &#39;</span>
                             <span class="s1">&#39;Tuple[TypeVariable[K], TypeVariable[V]]&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">expected_error_prefix</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTest.test_keys_and_values"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_keys_and_values">[docs]</a>  <span class="k">def</span> <span class="nf">test_keys_and_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">pcoll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Keys</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">))</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">pcoll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Values</span><span class="p">(</span><span class="s1">&#39;vals&#39;</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:keys&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;assert:vals&#39;</span><span class="p">)</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_kv_swap"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_kv_swap">[docs]</a>  <span class="k">def</span> <span class="nf">test_kv_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">KvSwap</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;swap&#39;</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_remove_duplicates"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_remove_duplicates">[docs]</a>  <span class="k">def</span> <span class="nf">test_remove_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;pleat&#39;</span><span class="p">,</span> <span class="s1">&#39;pleat&#39;</span><span class="p">,</span> <span class="s1">&#39;kazoo&#39;</span><span class="p">,</span> <span class="s1">&#39;navel&#39;</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">RemoveDuplicates</span><span class="p">())</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;pleat&#39;</span><span class="p">,</span> <span class="s1">&#39;kazoo&#39;</span><span class="p">,</span> <span class="s1">&#39;navel&#39;</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_chained_ptransforms"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_chained_ptransforms">[docs]</a>  <span class="k">def</span> <span class="nf">test_chained_ptransforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">()</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ones</span><span class="p">):</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ones</span><span class="p">))))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="n">t</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTest.test_apply_to_list"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_apply_to_list">[docs]</a>  <span class="k">def</span> <span class="nf">test_apply_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="s1">&#39;AddOne&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="s1">&#39;Odd&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                          <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">])</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
    <span class="n">join_input</span> <span class="o">=</span> <span class="p">([(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)],</span>
                  <span class="p">[(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">([(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]))],</span>
                          <span class="n">join_input</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">CoGroupByKey</span><span class="p">())</span></div>

<div class="viewcode-block" id="PTransformTest.test_multi_input_ptransform"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_multi_input_ptransform">[docs]</a>  <span class="k">def</span> <span class="nf">test_multi_input_ptransform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">DisjointUnion</span><span class="p">(</span><span class="n">PTransform</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pcollections</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pcollections</span>
                <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
                <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">()</span>
                <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span> <span class="n">x</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">|</span> <span class="n">DisjointUnion</span><span class="p">()))</span></div>

<div class="viewcode-block" id="PTransformTest.test_apply_to_crazy_pvaluish"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTest.test_apply_to_crazy_pvaluish">[docs]</a>  <span class="k">def</span> <span class="nf">test_apply_to_crazy_pvaluish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">NestedFlatten</span><span class="p">(</span><span class="n">PTransform</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;A PTransform taking and returning nested PValueish.</span>

<span class="sd">      Takes as input a list of dicts, and returns a dict with the corresponding</span>
<span class="sd">      values flattened.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">def</span> <span class="nf">_extract_input_pvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pvalueish</span><span class="p">):</span>
        <span class="n">pvalueish</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pvalueish</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pvalueish</span><span class="p">,</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvalueish</span><span class="p">],</span> <span class="p">[])</span>

      <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pcoll_dicts</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pcoll_dicts</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
          <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pcoll_dicts</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span> <span class="o">|</span> <span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]},</span>
           <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]},</span>
           <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[]}]</span> <span class="o">|</span> <span class="n">NestedFlatten</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([],</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]))</span></div></div>


<span class="nd">@beam</span><span class="o">.</span><span class="n">ptransform_fn</span>
<span class="k">def</span> <span class="nf">SamplePTransform</span><span class="p">(</span><span class="n">pcoll</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Sample transform using the @ptransform_fn decorator.&quot;&quot;&quot;</span>
  <span class="n">map_transform</span> <span class="o">=</span> <span class="s1">&#39;ToPairs&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
  <span class="n">combine_transform</span> <span class="o">=</span> <span class="s1">&#39;Group&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombinePerKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">vs</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
  <span class="n">keys_transform</span> <span class="o">=</span> <span class="s1">&#39;RemoveDuplicates&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Keys</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="n">map_transform</span> <span class="o">|</span> <span class="n">combine_transform</span> <span class="o">|</span> <span class="n">keys_transform</span>


<div class="viewcode-block" id="PTransformLabelsTest"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest">[docs]</a><span class="k">class</span> <span class="nc">PTransformLabelsTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="PTransformLabelsTest.CustomTransform"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.CustomTransform">[docs]</a>  <span class="k">class</span> <span class="nc">CustomTransform</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">PTransform</span><span class="p">):</span>

    <span class="n">pardo</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PTransformLabelsTest.CustomTransform.expand"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.CustomTransform.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pcoll</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">pardo</span> <span class="o">=</span> <span class="s1">&#39;*Do*&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">pardo</span></div></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_chained_ptransforms"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_chained_ptransforms">[docs]</a>  <span class="k">def</span> <span class="nf">test_chained_ptransforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests that chaining gets proper nesting.&quot;&quot;&quot;</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">map1</span> <span class="o">=</span> <span class="s1">&#39;Map1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">gbk</span> <span class="o">=</span> <span class="s1">&#39;Gbk&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">()</span>
    <span class="n">map2</span> <span class="o">=</span> <span class="s1">&#39;Map2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ones</span><span class="p">):</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ones</span><span class="p">)))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">map1</span> <span class="o">|</span> <span class="n">gbk</span> <span class="o">|</span> <span class="n">map2</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="n">t</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;Map1|Gbk|Map2/Map1&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;Map1|Gbk|Map2/Gbk&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;Map1|Gbk|Map2/Map2&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_apply_custom_transform_without_label"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_apply_custom_transform_without_label">[docs]</a>  <span class="k">def</span> <span class="nf">test_apply_custom_transform_without_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;PColl&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">custom</span> <span class="o">=</span> <span class="n">PTransformLabelsTest</span><span class="o">.</span><span class="n">CustomTransform</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom</span><span class="p">,</span> <span class="n">pcoll</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;CustomTransform&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;CustomTransform/*Do*&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_apply_custom_transform_with_label"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_apply_custom_transform_with_label">[docs]</a>  <span class="k">def</span> <span class="nf">test_apply_custom_transform_with_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;PColl&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">custom</span> <span class="o">=</span> <span class="n">PTransformLabelsTest</span><span class="o">.</span><span class="n">CustomTransform</span><span class="p">(</span><span class="s1">&#39;*Custom*&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom</span><span class="p">,</span> <span class="n">pcoll</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;*Custom*&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;*Custom*/*Do*&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_combine_without_label"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_combine_without_label">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_without_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">combine</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="n">combine</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;CombineGlobally(sum)&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_apply_ptransform_using_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_apply_ptransform_using_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_apply_ptransform_using_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;PColl&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="s1">&#39;*Sample*&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">SamplePTransform</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;*Sample*&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;*Sample*/ToPairs&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;*Sample*/Group&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;*Sample*/RemoveDuplicates&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_combine_with_label"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_combine_with_label">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_with_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pcoll</span> <span class="o">=</span> <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">combine</span> <span class="o">=</span> <span class="s1">&#39;*Sum*&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pcoll</span> <span class="o">|</span> <span class="n">combine</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;*Sum*&#39;</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">)]))</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.check_label"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.check_label">[docs]</a>  <span class="k">def</span> <span class="nf">check_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptransform</span><span class="p">,</span> <span class="n">expected_label</span><span class="p">):</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span>
    <span class="n">pipeline</span> <span class="o">|</span> <span class="s1">&#39;Start&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span> <span class="o">|</span> <span class="n">ptransform</span>
    <span class="n">actual_label</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">applied_labels</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;Start&#39;</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_label</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d{3,}&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">actual_label</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_default_labels"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_default_labels">[docs]</a>  <span class="k">def</span> <span class="nf">test_default_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="nb">len</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;Map(len)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">),</span>
                     <span class="sa">r</span><span class="s1">&#39;Map(&lt;lambda at ptransform_test.py:#&gt;)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;FlatMap(list)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">sum</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;Filter(sum)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="nb">sum</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;CombineGlobally(sum)&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">CombinePerKey</span><span class="p">(</span><span class="nb">sum</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;CombinePerKey(sum)&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">MyDoFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">MyDoFn</span><span class="p">()),</span> <span class="sa">r</span><span class="s1">&#39;ParDo(MyDoFn)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformLabelsTest.test_lable_propogation"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformLabelsTest.test_lable_propogation">[docs]</a>  <span class="k">def</span> <span class="nf">test_lable_propogation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="s1">&#39;TestMap&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="nb">len</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;TestMap&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="s1">&#39;TestLambda&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;TestLambda&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="s1">&#39;TestFlatMap&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;TestFlatMap&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="s1">&#39;TestFilter&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">sum</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;TestFilter&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="s1">&#39;TestCG&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="nb">sum</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;TestCG&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="s1">&#39;TestCPK&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombinePerKey</span><span class="p">(</span><span class="nb">sum</span><span class="p">),</span> <span class="sa">r</span><span class="s1">&#39;TestCPK&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">MyDoFn</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">check_label</span><span class="p">(</span><span class="s1">&#39;TestParDo&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">MyDoFn</span><span class="p">()),</span> <span class="sa">r</span><span class="s1">&#39;TestParDo&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PTransformTestDisplayData"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTestDisplayData">[docs]</a><span class="k">class</span> <span class="nc">PTransformTestDisplayData</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="PTransformTestDisplayData.test_map_named_function"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTestDisplayData.test_map_named_function">[docs]</a>  <span class="k">def</span> <span class="nf">test_map_named_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DisplayData</span><span class="o">.</span><span class="n">create_from</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">nspace</span> <span class="o">=</span> <span class="s1">&#39;apache_beam.transforms.core.CallableWrapperDoFn&#39;</span>
    <span class="n">expected_item</span> <span class="o">=</span> <span class="n">DisplayDataItem</span><span class="p">(</span><span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Transform Function&#39;</span><span class="p">,</span>
                                    <span class="n">namespace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">assert_that</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">hc</span><span class="o">.</span><span class="n">has_item</span><span class="p">(</span><span class="n">expected_item</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTestDisplayData.test_map_anonymous_function"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTestDisplayData.test_map_anonymous_function">[docs]</a>  <span class="k">def</span> <span class="nf">test_map_anonymous_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DisplayData</span><span class="o">.</span><span class="n">create_from</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">nspace</span> <span class="o">=</span> <span class="s1">&#39;apache_beam.transforms.core.CallableWrapperDoFn&#39;</span>
    <span class="n">expected_item</span> <span class="o">=</span> <span class="n">DisplayDataItem</span><span class="p">(</span><span class="s1">&#39;&lt;lambda&gt;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Transform Function&#39;</span><span class="p">,</span>
                                    <span class="n">namespace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">assert_that</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">hc</span><span class="o">.</span><span class="n">has_item</span><span class="p">(</span><span class="n">expected_item</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTestDisplayData.test_flatmap_named_function"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTestDisplayData.test_flatmap_named_function">[docs]</a>  <span class="k">def</span> <span class="nf">test_flatmap_named_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DisplayData</span><span class="o">.</span><span class="n">create_from</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">nspace</span> <span class="o">=</span> <span class="s1">&#39;apache_beam.transforms.core.CallableWrapperDoFn&#39;</span>
    <span class="n">expected_item</span> <span class="o">=</span> <span class="n">DisplayDataItem</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Transform Function&#39;</span><span class="p">,</span>
                                    <span class="n">namespace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">assert_that</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">hc</span><span class="o">.</span><span class="n">has_item</span><span class="p">(</span><span class="n">expected_item</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTestDisplayData.test_flatmap_anonymous_function"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTestDisplayData.test_flatmap_anonymous_function">[docs]</a>  <span class="k">def</span> <span class="nf">test_flatmap_anonymous_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DisplayData</span><span class="o">.</span><span class="n">create_from</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">nspace</span> <span class="o">=</span> <span class="s1">&#39;apache_beam.transforms.core.CallableWrapperDoFn&#39;</span>
    <span class="n">expected_item</span> <span class="o">=</span> <span class="n">DisplayDataItem</span><span class="p">(</span><span class="s1">&#39;&lt;lambda&gt;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Transform Function&#39;</span><span class="p">,</span>
                                    <span class="n">namespace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">assert_that</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">hc</span><span class="o">.</span><span class="n">has_item</span><span class="p">(</span><span class="n">expected_item</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTestDisplayData.test_filter_named_function"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTestDisplayData.test_filter_named_function">[docs]</a>  <span class="k">def</span> <span class="nf">test_filter_named_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DisplayData</span><span class="o">.</span><span class="n">create_from</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">nspace</span> <span class="o">=</span> <span class="s1">&#39;apache_beam.transforms.core.CallableWrapperDoFn&#39;</span>
    <span class="n">expected_item</span> <span class="o">=</span> <span class="n">DisplayDataItem</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Transform Function&#39;</span><span class="p">,</span>
                                    <span class="n">namespace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">assert_that</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">hc</span><span class="o">.</span><span class="n">has_item</span><span class="p">(</span><span class="n">expected_item</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTestDisplayData.test_filter_anonymous_function"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTestDisplayData.test_filter_anonymous_function">[docs]</a>  <span class="k">def</span> <span class="nf">test_filter_anonymous_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">DisplayData</span><span class="o">.</span><span class="n">create_from</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="n">nspace</span> <span class="o">=</span> <span class="s1">&#39;apache_beam.transforms.core.CallableWrapperDoFn&#39;</span>
    <span class="n">expected_item</span> <span class="o">=</span> <span class="n">DisplayDataItem</span><span class="p">(</span><span class="s1">&#39;&lt;lambda&gt;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fn&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Transform Function&#39;</span><span class="p">,</span>
                                    <span class="n">namespace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">hc</span><span class="o">.</span><span class="n">assert_that</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">hc</span><span class="o">.</span><span class="n">has_item</span><span class="p">(</span><span class="n">expected_item</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="PTransformTypeCheckTestCase"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase">[docs]</a><span class="k">class</span> <span class="nc">PTransformTypeCheckTestCase</span><span class="p">(</span><span class="n">TypeHintTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.assertStartswith"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.assertStartswith">[docs]</a>  <span class="k">def</span> <span class="nf">assertStartswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span>
                    <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; does not start with &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.setUp"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.setUp">[docs]</a>  <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">TestPipeline</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_do_fn_pipeline_pipeline_type_check_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_do_fn_pipeline_pipeline_type_check_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_fn_pipeline_pipeline_type_check_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="k">class</span> <span class="nc">AddWithFive</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">five</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">element</span> <span class="o">+</span> <span class="n">five</span><span class="p">]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Add&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">AddWithFive</span><span class="p">(),</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_do_fn_pipeline_pipeline_type_check_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_do_fn_pipeline_pipeline_type_check_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_fn_pipeline_pipeline_type_check_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span>
    <span class="k">class</span> <span class="nc">ToUpperCaseWithPrefix</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Upper&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">ToUpperCaseWithPrefix</span><span class="p">(),</span> <span class="s1">&#39;hello&#39;</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;Upper&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;str&#39;&gt; but got &lt;type &#39;int&#39;&gt; for element&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_do_fn_pipeline_runtime_type_check_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_do_fn_pipeline_runtime_type_check_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_fn_pipeline_runtime_type_check_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">AddWithNum</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">element</span> <span class="o">+</span> <span class="n">num</span><span class="p">]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Add&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">AddWithNum</span><span class="p">(),</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_do_fn_pipeline_runtime_type_check_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_do_fn_pipeline_runtime_type_check_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_do_fn_pipeline_runtime_type_check_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="k">class</span> <span class="nc">AddWithNum</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">DoFn</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">element</span> <span class="o">+</span> <span class="n">num</span><span class="p">]</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Add&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">AddWithNum</span><span class="p">(),</span> <span class="mi">5</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;Add&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;int&#39;&gt; but got &lt;type &#39;str&#39;&gt; for element&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pardo_does_not_type_check_using_type_hint_decorators"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pardo_does_not_type_check_using_type_hint_decorators">[docs]</a>  <span class="k">def</span> <span class="nf">test_pardo_does_not_type_check_using_type_hint_decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">int_to_str</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>

    <span class="c1"># The function above is expecting an int for its only parameter. However, it</span>
    <span class="c1"># will receive a str instead, which should result in a raised exception.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;S&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;ToStr&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="n">int_to_str</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;ToStr&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;int&#39;&gt; but got &lt;type &#39;str&#39;&gt; for a&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pardo_properly_type_checks_using_type_hint_decorators"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pardo_properly_type_checks_using_type_hint_decorators">[docs]</a>  <span class="k">def</span> <span class="nf">test_pardo_properly_type_checks_using_type_hint_decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">to_all_upper_case</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>

    <span class="c1"># If this type-checks than no error should be raised.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Case&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="n">to_all_upper_case</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Output type should have been recognized as &#39;str&#39; rather than List[str] to</span>
    <span class="c1"># do the flatten part of FlatMap.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pardo_does_not_type_check_using_type_hint_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pardo_does_not_type_check_using_type_hint_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_pardo_does_not_type_check_using_type_hint_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># The first ParDo outputs pcoll&#39;s of type int, however the second ParDo is</span>
    <span class="c1"># expecting pcoll&#39;s of type str instead.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;S&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Score&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Upper&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;Upper&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;str&#39;&gt; but got &lt;type &#39;int&#39;&gt; for x&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pardo_properly_type_checks_using_type_hint_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pardo_properly_type_checks_using_type_hint_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_pardo_properly_type_checks_using_type_hint_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Pipeline should be created successfully without an error</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;S&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Dup&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="p">])</span>
         <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Upper&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
         <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span> <span class="s1">&#39;EE&#39;</span><span class="p">,</span> <span class="s1">&#39;SS&#39;</span><span class="p">,</span> <span class="s1">&#39;TT&#39;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_map_does_not_type_check_using_type_hints_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_map_does_not_type_check_using_type_hints_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_map_does_not_type_check_using_type_hints_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># The transform before &#39;Map&#39; has indicated that it outputs PCollections with</span>
    <span class="c1"># int&#39;s, while Map is expecting one of str.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;S&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Upper&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
       <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;Upper&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;str&#39;&gt; but got &lt;type &#39;int&#39;&gt; for x&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_map_properly_type_checks_using_type_hints_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_map_properly_type_checks_using_type_hints_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_map_properly_type_checks_using_type_hints_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># No error should be raised if this type-checks properly.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;S&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;ToStr&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
         <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_map_does_not_type_check_using_type_hints_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_map_does_not_type_check_using_type_hints_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_map_does_not_type_check_using_type_hints_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="c1"># Hinted function above expects a str at pipeline construction.</span>
    <span class="c1"># However, &#39;Map&#39; should detect that Create has hinted an int instead.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;S&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Upper&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">upper</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;Upper&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;str&#39;&gt; but got &lt;type &#39;int&#39;&gt; for s&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_map_properly_type_checks_using_type_hints_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_map_properly_type_checks_using_type_hints_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_map_properly_type_checks_using_type_hints_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bool_to_int</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="c1"># If this type-checks than no error should be raised.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;bools&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;to_ints&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">bool_to_int</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_filter_does_not_type_check_using_type_hints_method"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_filter_does_not_type_check_using_type_hints_method">[docs]</a>  <span class="k">def</span> <span class="nf">test_filter_does_not_type_check_using_type_hints_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Filter is expecting an int but instead looks to the &#39;left&#39; and sees a str</span>
    <span class="c1"># incoming.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;Strs&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Lower&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
       <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Below 3&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;Below 3&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;int&#39;&gt; but got &lt;type &#39;str&#39;&gt; for x&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_filter_type_checks_using_type_hints_method"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_filter_type_checks_using_type_hints_method">[docs]</a>  <span class="k">def</span> <span class="nf">test_filter_type_checks_using_type_hints_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># No error should be raised if this type-checks properly.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;ToInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
         <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Below 3&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_filter_does_not_type_check_using_type_hints_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_filter_does_not_type_check_using_type_hints_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_filter_does_not_type_check_using_type_hints_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">more_than_half</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mf">0.50</span>

    <span class="c1"># Func above was hinted to only take a float, yet an int will be passed.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;Ints&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Half&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">more_than_half</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Type hint violation for &#39;Half&#39;: &quot;</span>
                     <span class="s2">&quot;requires &lt;type &#39;float&#39;&gt; but got &lt;type &#39;int&#39;&gt; for a&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_filter_type_checks_using_type_hints_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_filter_type_checks_using_type_hints_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_filter_type_checks_using_type_hints_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">half</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
      <span class="kn">import</span> <span class="nn">random</span>
      <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Filter should deduce that it returns the same type that it takes.</span>
    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
     <span class="o">|</span> <span class="s1">&#39;Str&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
     <span class="o">|</span> <span class="s1">&#39;Half&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="n">half</span><span class="p">)</span>
     <span class="o">|</span> <span class="s1">&#39;ToBool&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
     <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_group_by_key_only_output_type_deduction"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_group_by_key_only_output_type_deduction">[docs]</a>  <span class="k">def</span> <span class="nf">test_group_by_key_only_output_type_deduction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;Str&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Pair&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]))</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKeyOnly</span><span class="p">())</span>

    <span class="c1"># Output type should correctly be deduced.</span>
    <span class="c1"># GBK-only should deduce that KV[A, B] is turned into KV[A, Iterable[B]].</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                          <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_group_by_key_output_type_deduction"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_group_by_key_output_type_deduction">[docs]</a>  <span class="k">def</span> <span class="nf">test_group_by_key_output_type_deduction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;Str&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;PairNegative&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">())</span>

    <span class="c1"># Output type should correctly be deduced.</span>
    <span class="c1"># GBK should deduce that KV[A, B] is turned into KV[A, Iterable[B]].</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                          <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_group_by_key_only_does_not_type_check"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_group_by_key_only_does_not_type_check">[docs]</a>  <span class="k">def</span> <span class="nf">test_group_by_key_only_does_not_type_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># GBK will be passed raw int&#39;s here instead of some form of KV[A, B].</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;F&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKeyOnly</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Input type hint violation at F: &quot;</span>
                     <span class="s2">&quot;expected Tuple[TypeVariable[K], TypeVariable[V]], &quot;</span>
                     <span class="s2">&quot;got &lt;type &#39;int&#39;&gt;&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_group_by_does_not_type_check"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_group_by_does_not_type_check">[docs]</a>  <span class="k">def</span> <span class="nf">test_group_by_does_not_type_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Create is returning a List[int, str], rather than a KV[int, str] that is</span>
    <span class="c1"># aliased to Tuple[int, str].</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
          <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]))</span>
       <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Input type hint violation at T: &quot;</span>
                     <span class="s2">&quot;expected Tuple[TypeVariable[K], TypeVariable[V]], &quot;</span>
                     <span class="s2">&quot;got Iterable[int]&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_checking_pardo_insufficient_type_information"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_checking_pardo_insufficient_type_information">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_checking_pardo_insufficient_type_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">type_check_strictness</span> <span class="o">=</span> <span class="s1">&#39;ALL_REQUIRED&#39;</span>

    <span class="c1"># Type checking is enabled, but &#39;Create&#39; doesn&#39;t pass on any relevant type</span>
    <span class="c1"># information to the ParDo.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;Nums&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
       <span class="o">|</span> <span class="s1">&#39;ModDup&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;Pipeline type checking is enabled, however no output &#39;</span>
                     <span class="s1">&#39;type-hint was found for the PTransform Create(Nums)&#39;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_checking_gbk_insufficient_type_information"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_checking_gbk_insufficient_type_information">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_checking_gbk_insufficient_type_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">type_check_strictness</span> <span class="o">=</span> <span class="s1">&#39;ALL_REQUIRED&#39;</span>
    <span class="c1"># Type checking is enabled, but &#39;Map&#39; doesn&#39;t pass on any relevant type</span>
    <span class="c1"># information to GBK-only.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;Nums&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;ModDup&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKeyOnly</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;Pipeline type checking is enabled, however no output &#39;</span>
                     <span class="s1">&#39;type-hint was found for the PTransform &#39;</span>
                     <span class="s1">&#39;ParDo(ModDup)&#39;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_disable_pipeline_type_check"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_disable_pipeline_type_check">[docs]</a>  <span class="k">def</span> <span class="nf">test_disable_pipeline_type_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># The pipeline below should raise a TypeError, however pipeline type</span>
    <span class="c1"># checking was disabled above.</span>
    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
     <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
     <span class="o">|</span> <span class="s1">&#39;Lower&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
     <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_run_time_type_checking_enabled_type_violation"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_run_time_type_checking_enabled_type_violation">[docs]</a>  <span class="k">def</span> <span class="nf">test_run_time_type_checking_enabled_type_violation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">int_to_string</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Function above has been type-hinted to only accept an int. But in the</span>
    <span class="c1"># pipeline execution it&#39;ll be passed a string due to the output of Create.</span>
    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
     <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;some_string&#39;</span><span class="p">])</span>
     <span class="o">|</span> <span class="s1">&#39;ToStr&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">int_to_string</span><span class="p">))</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within ParDo(ToStr): &quot;</span>
        <span class="s2">&quot;Type-hint for argument: &#39;x&#39; violated. &quot;</span>
        <span class="s2">&quot;Expected an instance of &lt;type &#39;int&#39;&gt;, &quot;</span>
        <span class="s2">&quot;instead found some_string, an instance of &lt;type &#39;str&#39;&gt;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_run_time_type_checking_enabled_types_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_run_time_type_checking_enabled_types_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_run_time_type_checking_enabled_types_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">group_with_upper_ord</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="o">%</span> <span class="mi">5</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="c1"># Pipeline checking is off, but the above function should satisfy types at</span>
    <span class="c1"># run-time.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
              <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">])</span>
              <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
              <span class="o">|</span> <span class="s1">&#39;GenKeys&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">group_with_upper_ord</span><span class="p">)</span>
              <span class="o">|</span> <span class="s1">&#39;O&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">())</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]),</span>
                                  <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]),</span>
                                  <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_checking_satisfied_but_run_time_types_violate"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_checking_satisfied_but_run_time_types_violate">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_checking_satisfied_but_run_time_types_violate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_even_as_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="c1"># Simulate a programming error, should be: return (a % 2 == 0, a)</span>
      <span class="c1"># However this returns KV[int, int]</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
     <span class="o">|</span> <span class="s1">&#39;Nums&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
     <span class="o">|</span> <span class="s1">&#39;IsEven&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">is_even_as_key</span><span class="p">)</span>
     <span class="o">|</span> <span class="s1">&#39;Parity&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">())</span>

    <span class="c1"># Although all the types appear to be correct when checked at pipeline</span>
    <span class="c1"># construction. Runtime type-checking should detect the &#39;is_even_as_key&#39; is</span>
    <span class="c1"># returning Tuple[int, int], instead of Tuple[bool, int].</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within ParDo(IsEven): &quot;</span>
        <span class="s2">&quot;Tuple[bool, int] hint type-constraint violated. &quot;</span>
        <span class="s2">&quot;The type of element #0 in the passed tuple is incorrect. &quot;</span>
        <span class="s2">&quot;Expected an instance of type bool, &quot;</span>
        <span class="s2">&quot;instead received an instance of type int.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_checking_satisfied_run_time_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_checking_satisfied_run_time_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_checking_satisfied_run_time_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_even_as_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="c1"># The programming error in the above test-case has now been fixed.</span>
      <span class="c1"># Everything should properly type-check.</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
              <span class="o">|</span> <span class="s1">&#39;Nums&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
              <span class="o">|</span> <span class="s1">&#39;IsEven&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">is_even_as_key</span><span class="p">)</span>
              <span class="o">|</span> <span class="s1">&#39;Parity&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">())</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_simple_type_input"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_simple_type_input">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_runtime_checking_violation_simple_type_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># The type-hinted applied via the &#39;with_input_types()&#39; method indicates the</span>
    <span class="c1"># ParDo should receive an instance of type &#39;str&#39;, however an &#39;int&#39; will be</span>
    <span class="c1"># passed instead.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;ToInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within ParDo(ToInt): &quot;</span>
        <span class="s2">&quot;Type-hint for argument: &#39;x&#39; violated. &quot;</span>
        <span class="s2">&quot;Expected an instance of &lt;type &#39;str&#39;&gt;, &quot;</span>
        <span class="s2">&quot;instead found 1, an instance of &lt;type &#39;int&#39;&gt;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_composite_type_input"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_composite_type_input">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_runtime_checking_violation_composite_type_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">)])</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Add&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">])</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
      <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within ParDo(Add): &quot;</span>
        <span class="s2">&quot;Type-hint for argument: &#39;y&#39; violated. &quot;</span>
        <span class="s2">&quot;Expected an instance of &lt;type &#39;int&#39;&gt;, &quot;</span>
        <span class="s2">&quot;instead found 3.0, an instance of &lt;type &#39;float&#39;&gt;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_simple_type_output"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_simple_type_output">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_runtime_checking_violation_simple_type_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># The type-hinted applied via the &#39;returns()&#39; method indicates the ParDo</span>
    <span class="c1"># should output an instance of type &#39;int&#39;, however a &#39;float&#39; will be</span>
    <span class="c1"># generated instead.</span>
    <span class="nb">print</span> <span class="s2">&quot;HINTS&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;ToInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span><span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">get_type_hints</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;ToInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
      <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within &quot;</span>
        <span class="s2">&quot;ParDo(ToInt): &quot;</span>
        <span class="s2">&quot;According to type-hint expected output should be &quot;</span>
        <span class="s2">&quot;of type &lt;type &#39;int&#39;&gt;. Instead, received &#39;1.0&#39;, &quot;</span>
        <span class="s2">&quot;an instance of type &lt;type &#39;float&#39;&gt;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_composite_type_output"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_runtime_checking_violation_composite_type_output">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_runtime_checking_violation_composite_type_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># The type-hinted applied via the &#39;returns()&#39; method indicates the ParDo</span>
    <span class="c1"># should return an instance of type: Tuple[float, int]. However, an instance</span>
    <span class="c1"># of &#39;int&#39; will be generated instead.</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">)])</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Swap&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">FlatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">])</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span>
          <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
      <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within &quot;</span>
        <span class="s2">&quot;ParDo(Swap): Tuple type constraint violated. &quot;</span>
        <span class="s2">&quot;Valid object instance must be of type &#39;tuple&#39;. Instead, &quot;</span>
        <span class="s2">&quot;an instance of &#39;float&#39; was received.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipline_runtime_checking_violation_with_side_inputs_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipline_runtime_checking_violation_with_side_inputs_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipline_runtime_checking_violation_with_side_inputs_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span> <span class="o">|</span> <span class="s1">&#39;Add 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within ParDo(Add 1): &quot;</span>
        <span class="s2">&quot;Type-hint for argument: &#39;b&#39; violated. &quot;</span>
        <span class="s2">&quot;Expected an instance of &lt;type &#39;int&#39;&gt;, &quot;</span>
        <span class="s2">&quot;instead found 1.0, an instance of &lt;type &#39;float&#39;&gt;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipline_runtime_checking_violation_with_side_inputs_via_method"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipline_runtime_checking_violation_with_side_inputs_via_method">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipline_runtime_checking_violation_with_side_inputs_via_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Add 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">one</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">one</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
          <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">float</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within ParDo(Add 1): &quot;</span>
        <span class="s2">&quot;Type-hint for argument: &#39;one&#39; violated. &quot;</span>
        <span class="s2">&quot;Expected an instance of &lt;type &#39;int&#39;&gt;, &quot;</span>
        <span class="s2">&quot;instead found 1.0, an instance of &lt;type &#39;float&#39;&gt;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_properly_pipeline_type_checks_using_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_properly_pipeline_type_checks_using_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_properly_pipeline_type_checks_using_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">ints</span><span class="o">=</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">sum_ints</span><span class="p">(</span><span class="n">ints</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Sum&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="n">sum_ints</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">6</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_func_type_hint_does_not_take_iterable_using_decorator"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_func_type_hint_does_not_take_iterable_using_decorator">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_func_type_hint_does_not_take_iterable_using_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bad_combine</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="mi">5</span> <span class="o">+</span> <span class="n">a</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;M&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Add&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="n">bad_combine</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;All functions for a Combine PTransform must accept a &quot;</span>
        <span class="s2">&quot;single argument compatible with: Iterable[Any]. &quot;</span>
        <span class="s2">&quot;Instead a function with input type: &lt;type &#39;int&#39;&gt; was received.&quot;</span><span class="p">,</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_pipeline_type_propagation_using_decorators"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_pipeline_type_propagation_using_decorators">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_pipeline_type_propagation_using_decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">ints</span><span class="o">=</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">sum_ints</span><span class="p">(</span><span class="n">ints</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ints</span><span class="p">)</span>

    <span class="nd">@with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">range_from_zero</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;T&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Sum&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="n">sum_ints</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Range&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">ParDo</span><span class="p">(</span><span class="n">range_from_zero</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_runtime_type_check_satisfied_using_decorators"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_runtime_type_check_satisfied_using_decorators">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_runtime_type_check_satisfied_using_decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">ints</span><span class="o">=</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">iter_mul</span><span class="p">(</span><span class="n">ints</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">ints</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;K&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Mul&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="n">iter_mul</span><span class="p">))</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">625</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_runtime_type_check_violation_using_decorators"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_runtime_type_check_violation_using_decorators">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_runtime_type_check_violation_using_decorators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Combine fn is returning the incorrect type</span>
    <span class="nd">@with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nd">@with_input_types</span><span class="p">(</span><span class="n">ints</span><span class="o">=</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">iter_mul</span><span class="p">(</span><span class="n">ints</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">ints</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;K&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Mul&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="n">iter_mul</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within &quot;</span>
        <span class="s2">&quot;ParDo(Mul/CombinePerKey/LiftedCombinePerKey/ParDo(FinishCombine)): &quot;</span>
        <span class="s2">&quot;Tuple[TypeVariable[K], int] hint type-constraint violated. &quot;</span>
        <span class="s2">&quot;The type of element #1 in the passed tuple is incorrect. &quot;</span>
        <span class="s2">&quot;Expected an instance of type int, &quot;</span>
        <span class="s2">&quot;instead received an instance of type str.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_pipeline_type_check_using_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_pipeline_type_check_using_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_pipeline_type_check_using_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;concat&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="n">equal_to</span><span class="p">(</span><span class="n">expected</span><span class="p">)(</span><span class="nb">list</span><span class="p">(</span><span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
      <span class="k">return</span> <span class="n">match</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">matcher</span><span class="p">(</span><span class="s1">&#39;estt&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_runtime_type_check_using_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_runtime_type_check_using_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_runtime_type_check_using_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Sum&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>

    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">10</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_pipeline_type_check_violation_using_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_pipeline_type_check_violation_using_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_pipeline_type_check_violation_using_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;SortJoin&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Input type hint violation at SortJoin: &quot;</span>
                     <span class="s2">&quot;expected &lt;type &#39;str&#39;&gt;, got &lt;type &#39;int&#39;&gt;&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_runtime_type_check_violation_using_methods"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_runtime_type_check_violation_using_methods">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_runtime_type_check_violation_using_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;SortJoin&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
          <span class="o">.</span><span class="n">with_input_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within &quot;</span>
        <span class="s2">&quot;ParDo(SortJoin/KeyWithVoid): &quot;</span>
        <span class="s2">&quot;Type-hint for argument: &#39;v&#39; violated. &quot;</span>
        <span class="s2">&quot;Expected an instance of &lt;type &#39;str&#39;&gt;, &quot;</span>
        <span class="s2">&quot;instead found 0, an instance of &lt;type &#39;int&#39;&gt;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_combine_insufficient_type_hint_information"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_combine_insufficient_type_hint_information">[docs]</a>  <span class="k">def</span> <span class="nf">test_combine_insufficient_type_hint_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">type_check_strictness</span> <span class="o">=</span> <span class="s1">&#39;ALL_REQUIRED&#39;</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;E&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;SortJoin&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">CombineGlobally</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
       <span class="o">|</span> <span class="s1">&#39;F&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s1">&#39;Pipeline type checking is enabled, &#39;</span>
        <span class="s1">&#39;however no output type-hint was found for the PTransform &#39;</span>
        <span class="s1">&#39;ParDo(&#39;</span>
        <span class="s1">&#39;SortJoin/CombinePerKey/LiftedCombinePerKey/ParDo(FinishCombine))&#39;</span><span class="p">,</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_globally_pipeline_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_globally_pipeline_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_globally_pipeline_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;C&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Mean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">Globally</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">element_type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mf">2.0</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_globally_pipeline_checking_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_globally_pipeline_checking_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_globally_pipeline_checking_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;C&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;test&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Mean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">Globally</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;Type hint violation for &#39;ParDo(PartialGroupByKeyCombiningValues)&#39;: &quot;</span>
        <span class="s2">&quot;requires Tuple[TypeVariable[K], Union[float, int, long]] &quot;</span>
        <span class="s2">&quot;but got Tuple[None, str] for element&quot;</span><span class="p">,</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_globally_runtime_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_globally_runtime_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_globally_runtime_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;C&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Mean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">Globally</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">element_type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mf">2.0</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_globally_runtime_checking_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_globally_runtime_checking_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_globally_runtime_checking_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;C&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Mean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">Globally</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;Runtime type violation detected for transform input &quot;</span>
                       <span class="s2">&quot;when executing ParDoFlatMap(Combine): Tuple[Any, &quot;</span>
                       <span class="s2">&quot;Iterable[Union[int, float]]] hint type-constraint &quot;</span>
                       <span class="s2">&quot;violated. The type of element #1 in the passed tuple &quot;</span>
                       <span class="s2">&quot;is incorrect. Iterable[Union[int, float]] hint &quot;</span>
                       <span class="s2">&quot;type-constraint violated. The type of element #0 in &quot;</span>
                       <span class="s2">&quot;the passed Iterable is incorrect: Union[int, float] &quot;</span>
                       <span class="s2">&quot;type-constraint violated. Expected an instance of one &quot;</span>
                       <span class="s2">&quot;of: (&#39;int&#39;, &#39;float&#39;), received str instead.&quot;</span><span class="p">,</span>
                       <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_per_key_pipeline_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_per_key_pipeline_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_per_key_pipeline_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;EvenGroup&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="s1">&#39;EvenMean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">PerKey</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_per_key_pipeline_checking_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_per_key_pipeline_checking_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_per_key_pipeline_checking_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;UpperPair&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">x</span><span class="p">))</span>
          <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]))</span>
       <span class="o">|</span> <span class="s1">&#39;EvenMean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">PerKey</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;Type hint violation for &#39;ParDo(PartialGroupByKeyCombiningValues)&#39;: &quot;</span>
        <span class="s2">&quot;requires Tuple[TypeVariable[K], Union[float, int, long]] &quot;</span>
        <span class="s2">&quot;but got Tuple[str, str] for element&quot;</span><span class="p">,</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_per_key_runtime_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_per_key_runtime_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_per_key_runtime_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;OddGroup&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="s1">&#39;OddMean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">PerKey</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_mean_per_key_runtime_checking_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_mean_per_key_runtime_checking_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_mean_per_key_runtime_checking_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;OddGroup&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))))</span>
          <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]))</span>
       <span class="o">|</span> <span class="s1">&#39;OddMean&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Mean</span><span class="o">.</span><span class="n">PerKey</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertStartswith</span><span class="p">(</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;Runtime type violation detected within &quot;</span>
        <span class="s2">&quot;ParDo(OddMean/CombinePerKey(MeanCombineFn)/LiftedCombinePerKey/&quot;</span>
        <span class="s2">&quot;ParDo(PartialGroupByKeyCombiningValues)): &quot;</span>
        <span class="s2">&quot;Type-hint for argument: &#39;element&#39; violated: &quot;</span>
        <span class="s2">&quot;Tuple[TypeVariable[K], Union[float, int, long]]&quot;</span>
        <span class="s2">&quot; hint type-constraint violated. &quot;</span>
        <span class="s2">&quot;The type of element #1 in the passed tuple is incorrect. &quot;</span>
        <span class="s2">&quot;Union[float, int, long] type-constraint violated. &quot;</span>
        <span class="s2">&quot;Expected an instance of one of: (&#39;float&#39;, &#39;int&#39;, &#39;long&#39;), &quot;</span>
        <span class="s2">&quot;received str instead.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_globally_pipeline_type_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_globally_pipeline_type_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_globally_pipeline_type_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;P&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;CountInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">Globally</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">element_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">5</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_globally_runtime_type_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_globally_runtime_type_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_globally_runtime_type_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="s1">&#39;P&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;CountInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">Globally</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">element_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([</span><span class="mi">5</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_perkey_pipeline_type_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_perkey_pipeline_type_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_perkey_pipeline_type_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;EvenGroup&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="s1">&#39;CountInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">PerKey</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="kc">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_perkey_pipeline_type_checking_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_perkey_pipeline_type_checking_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_perkey_pipeline_type_checking_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;CountInt&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">PerKey</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;Type hint violation for &#39;ParDo(PartialGroupByKeyCombiningValues)&#39;: &quot;</span>
        <span class="s2">&quot;requires Tuple[TypeVariable[K], Any] &quot;</span>
        <span class="s2">&quot;but got &lt;type &#39;int&#39;&gt; for element&quot;</span><span class="p">,</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_perkey_runtime_type_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_perkey_runtime_type_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_perkey_runtime_type_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;DupKey&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
         <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span>
         <span class="o">|</span> <span class="s1">&#39;CountDups&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">PerKey</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_perelement_pipeline_type_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_perelement_pipeline_type_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_perelement_pipeline_type_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;CountElems&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">PerElement</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_perelement_pipeline_type_checking_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_perelement_pipeline_type_checking_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_perelement_pipeline_type_checking_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">type_check_strictness</span> <span class="o">=</span> <span class="s1">&#39;ALL_REQUIRED&#39;</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="s1">&#39;f&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
       <span class="o">|</span> <span class="s1">&#39;CountElems&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">PerElement</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;Pipeline type checking is enabled, however no output &#39;</span>
                     <span class="s1">&#39;type-hint was found for the PTransform &#39;</span>
                     <span class="s1">&#39;Create(f)&#39;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_count_perelement_runtime_type_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_count_perelement_runtime_type_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_count_perelement_runtime_type_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
         <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;CountElems&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Count</span><span class="o">.</span><span class="n">PerElement</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="kc">False</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_top_of_pipeline_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_top_of_pipeline_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_top_of_pipeline_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Top 3&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Top</span><span class="o">.</span><span class="n">Of</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                          <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_top_of_runtime_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_top_of_runtime_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_top_of_runtime_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;testing&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;AciiTop&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Top</span><span class="o">.</span><span class="n">Of</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_per_key_pipeline_checking_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_per_key_pipeline_checking_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_per_key_pipeline_checking_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Num + 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;TopMod&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Top</span><span class="o">.</span><span class="n">PerKey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;Type hint violation for &#39;ParDo(PartialGroupByKeyCombiningValues)&#39;: &quot;</span>
        <span class="s2">&quot;requires Tuple[TypeVariable[K], TypeVariable[T]] &quot;</span>
        <span class="s2">&quot;but got &lt;type &#39;int&#39;&gt; for element&quot;</span><span class="p">,</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_per_key_pipeline_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_per_key_pipeline_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_per_key_pipeline_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;GroupMod 3&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="s1">&#39;TopMod&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Top</span><span class="o">.</span><span class="n">PerKey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                          <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">99</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">97</span><span class="p">]),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">98</span><span class="p">])]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_per_key_runtime_checking_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_per_key_runtime_checking_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_per_key_runtime_checking_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span>
         <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;GroupMod 3&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">3</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="s1">&#39;TopMod&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Top</span><span class="o">.</span><span class="n">PerKey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                          <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">18</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">19</span><span class="p">]),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">])]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_sample_globally_pipeline_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_sample_globally_pipeline_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_sample_globally_pipeline_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Sample&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">FixedSizeGlobally</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="n">expected_len</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="n">equal_to</span><span class="p">([</span><span class="n">expected_len</span><span class="p">])([</span><span class="nb">len</span><span class="p">(</span><span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
      <span class="k">return</span> <span class="n">match</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">matcher</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_sample_globally_runtime_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_sample_globally_runtime_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_sample_globally_runtime_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="s1">&#39;Sample&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">FixedSizeGlobally</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="n">expected_len</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="n">equal_to</span><span class="p">([</span><span class="n">expected_len</span><span class="p">])([</span><span class="nb">len</span><span class="p">(</span><span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
      <span class="k">return</span> <span class="n">match</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">matcher</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_sample_per_key_pipeline_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_sample_per_key_pipeline_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_sample_per_key_pipeline_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="s1">&#39;Sample&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">FixedSizePerKey</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                          <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="n">expected_len</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">:</span>
          <span class="n">equal_to</span><span class="p">([</span><span class="n">expected_len</span><span class="p">])([</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)])</span>
      <span class="k">return</span> <span class="n">match</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">matcher</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_sample_per_key_runtime_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_sample_per_key_runtime_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_sample_per_key_runtime_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="s1">&#39;Sample&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">combine</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">FixedSizePerKey</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                          <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="n">expected_len</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">:</span>
          <span class="n">equal_to</span><span class="p">([</span><span class="n">expected_len</span><span class="p">])([</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)])</span>
      <span class="k">return</span> <span class="n">match</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">matcher</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_to_list_pipeline_check_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_to_list_pipeline_check_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_to_list_pipeline_check_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
         <span class="o">|</span> <span class="n">combine</span><span class="o">.</span><span class="n">ToList</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="n">equal_to</span><span class="p">(</span><span class="n">expected</span><span class="p">)(</span><span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">match</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">matcher</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_to_list_runtime_check_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_to_list_runtime_check_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_to_list_runtime_check_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">|</span> <span class="n">combine</span><span class="o">.</span><span class="n">ToList</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matcher</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">actual</span><span class="p">):</span>
        <span class="n">equal_to</span><span class="p">(</span><span class="n">expected</span><span class="p">)(</span><span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">match</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">matcher</span><span class="p">([</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_to_dict_pipeline_check_violated"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_to_dict_pipeline_check_violated">[docs]</a>  <span class="k">def</span> <span class="nf">test_to_dict_pipeline_check_violated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="n">combine</span><span class="o">.</span><span class="n">ToDict</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="s2">&quot;Type hint violation for &#39;ParDo(PartialGroupByKeyCombiningValues)&#39;: &quot;</span>
        <span class="s2">&quot;requires &quot;</span>
        <span class="s2">&quot;Tuple[TypeVariable[K], Tuple[TypeVariable[K], TypeVariable[V]]] &quot;</span>
        <span class="s2">&quot;but got Tuple[None, int] for element&quot;</span><span class="p">,</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_to_dict_pipeline_check_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_to_dict_pipeline_check_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_to_dict_pipeline_check_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span>
             <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span>
         <span class="o">|</span> <span class="n">combine</span><span class="o">.</span><span class="n">ToDict</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">4</span><span class="p">}]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_to_dict_runtime_check_satisfied"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_to_dict_runtime_check_satisfied">[docs]</a>  <span class="k">def</span> <span class="nf">test_to_dict_runtime_check_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
         <span class="o">|</span> <span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
            <span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span>
         <span class="o">|</span> <span class="n">combine</span><span class="o">.</span><span class="n">ToDict</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertCompatible</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="n">assert_that</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">equal_to</span><span class="p">([{</span><span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_runtime_type_check_python_type_error"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_runtime_type_check_python_type_error">[docs]</a>  <span class="k">def</span> <span class="nf">test_runtime_type_check_python_type_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_type_check</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
       <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
       <span class="o">|</span> <span class="s1">&#39;Len&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">with_output_types</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Our special type-checking related TypeError shouldn&#39;t have been raised.</span>
    <span class="c1"># Instead the above pipeline should have triggered a regular Python runtime</span>
    <span class="c1"># TypeError.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;object of type &#39;int&#39; has no len() [while running &#39;Len&#39;]&quot;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pardo_type_inference"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pardo_type_inference">[docs]</a>  <span class="k">def</span> <span class="nf">test_pardo_type_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span>
                     <span class="n">beam</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">infer_output_type</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                     <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">infer_output_type</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_gbk_type_inference"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_gbk_type_inference">[docs]</a>  <span class="k">def</span> <span class="nf">test_gbk_type_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
        <span class="n">typehints</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">beam</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">GroupByKeyOnly</span><span class="p">()</span><span class="o">.</span><span class="n">infer_output_type</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]))</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_pipeline_inference"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_pipeline_inference">[docs]</a>  <span class="k">def</span> <span class="nf">test_pipeline_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
    <span class="n">mapped</span> <span class="o">=</span> <span class="n">created</span> <span class="o">|</span> <span class="s1">&#39;pair with 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">mapped</span> <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">created</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">mapped</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">KV</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typehints</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                     <span class="n">grouped</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_inferred_bad_kv_type"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_inferred_bad_kv_type">[docs]</a>  <span class="k">def</span> <span class="nf">test_inferred_bad_kv_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">typehints</span><span class="o">.</span><span class="n">TypeCheckError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span>
           <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
           <span class="o">|</span> <span class="s1">&#39;Ungroupable&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
           <span class="o">|</span> <span class="n">beam</span><span class="o">.</span><span class="n">GroupByKey</span><span class="p">())</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;Input type hint violation at GroupByKey: &#39;</span>
                     <span class="s1">&#39;expected Tuple[TypeVariable[K], TypeVariable[V]], &#39;</span>
                     <span class="s1">&#39;got Tuple[str, int, float]&#39;</span><span class="p">,</span>
                     <span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="PTransformTypeCheckTestCase.test_type_inference_command_line_flag_toggle"><a class="viewcode-back" href="../../../apache_beam.transforms.html#apache_beam.transforms.ptransform_test.PTransformTypeCheckTestCase.test_type_inference_command_line_flag_toggle">[docs]</a>  <span class="k">def</span> <span class="nf">test_type_inference_command_line_flag_toggle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">|</span> <span class="s1">&#39;C1&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">TypeOptions</span><span class="p">)</span><span class="o">.</span><span class="n">pipeline_type_check</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">|</span> <span class="s1">&#39;C2&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">beam</span><span class="o">.</span><span class="n">Create</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">element_type</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Apache Beam  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>