# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Tests for PostCommit Java Nexmark Dataflow V2 with Java 8, 11, and 17
# using dataflow v2 runner

name: PostCommit Java Nexmark Dataflow V2 - JAVA 8,11 and 17

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: ['master', 'release-*']
    tags: 'v*'
permissions: read-all

env:
  BIGQUERYTABLE: nexmark
  BIGQUERYDATASET: nexmark
  PROJECT: apache-beam-testing
  RESOURCENAMEMODE: QUERY_RUNNER_AND_MODE
  EXPORTSUMMARYTOBIGQUERY: true
  TEMPLOCATION: gs://temp-storage-for-perf-tests/nexmark
  INFLUXDATABASE: beam_test_metrics
  INFLUXHOST: http://10.128.0.96:8086 
  BASEINFLUXMEASUREMENT: nexmark
  EXPORTSUMMARYTOINFLUXDB: true
  INFLUXRETENTIONPOLICY: forever
  INFLUXTAGSJAVA8: '{"runnerVersion":"V2","javaVersion":"8"}'
  INFLUXTAGSJAVA11: '{"runnerVersion":"V2","javaVersion":"11"}'
  INFLUXTAGSJAVA17: '{"runnerVersion":"V2","javaVersion":"17"}'  

jobs:
  java-postcommit-nexmark-dataflowv2:
    name: Run PostCommit Java Nexmark - Dataflow V2  - JAVA 8
    runs-on: [self-hosted, ubuntu-20.04]
    strategy:
      fail-fast: true
    timeout-minutes: 240
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          submodules: recursive
      - name: Setup environment
        uses: ./.github/actions/setup-self-hosted-action
      - name: Run *** RUN NEXMARK IN BATCH MODE USING DATAFLOW RUNNER JAVA 8 ***
        uses: ./.github/actions/gradle-command-self-hosted-action
        with:
          gradle-command: >
            :sdks:java:testing:nexmark:run -Pnexmark.runner.version=V2 -Pnexmark.runner=:runners:google-cloud-dataflow-java
            -Pnexmark.args="  
              --bigQueryTable=$BIGQUERYTABLE
              --bigQueryDataset=$BIGQUERYDATASET
              --project=$PROJECT
              --resourceNameMode=$RESOURCENAMEMODE
              --exportSummaryToBigQuery=$EXPORTSUMMARYTOBIGQUERY
              --tempLocation=$TEMPLOCATION
              --influxDatabase=$INFLUXDATABASE
              --influxHost=$INFLUXHOST
              --baseInfluxMeasurement=$BASEINFLUXMEASUREMENT
              --exportSummaryToInfluxDB=$EXPORTSUMMARYTOINFLUXDB
              --influxRetentionPolicy=$INFLUXRETENTIONPOLICY
              --influxTags=$INFLUXTAGSJAVA8
              --region=us-central1 
              --suite=STRESS 
              --numWorkers=4 
              --maxNumWorkers=4 
              --autoscalingAlgorithm=NONE 
              --nexmarkParallel=16 
              --enforceEncodability=true 
              --enforceImmutability=true 
              --runner=DataflowRunner 
              --streaming=false 
              --monitorJobs=true 
              --manageResources=false "
      - name: Run *** RUN NEXMARK IN BATCH MODE USING DATAFLOW RUNNER JAVA 11 ***
        uses: ./.github/actions/gradle-command-self-hosted-action
        with:
          gradle-command: >
            :sdks:java:testing:nexmark:run -Pnexmark.runner.version=V2 -Pnexmark.runner=:runners:google-cloud-dataflow-java
            -Pnexmark.args="  
              --bigQueryTable=$BIGQUERYTABLE
              --bigQueryDataset=$BIGQUERYDATASET
              --project=$PROJECT
              --resourceNameMode=$RESOURCENAMEMODE
              --exportSummaryToBigQuery=$EXPORTSUMMARYTOBIGQUERY
              --tempLocation=$TEMPLOCATION
              --influxDatabase=$INFLUXDATABASE
              --influxHost=$INFLUXHOST
              --baseInfluxMeasurement=$BASEINFLUXMEASUREMENT
              --exportSummaryToInfluxDB=$EXPORTSUMMARYTOINFLUXDB
              --influxRetentionPolicy=$INFLUXRETENTIONPOLICY
              --influxTags=$INFLUXTAGSJAVA11
              --region=us-central1 
              --suite=STRESS 
              --numWorkers=4 
              --maxNumWorkers=4 
              --autoscalingAlgorithm=NONE 
              --nexmarkParallel=16 
              --enforceEncodability=true 
              --enforceImmutability=true 
              --runner=DataflowRunner 
              --streaming=false 
              --monitorJobs=true 
              --manageResources=false "
      - name: Run *** RUN NEXMARK IN BATCH MODE USING DATAFLOW RUNNER JAVA 17 ***
        uses: ./.github/actions/gradle-command-self-hosted-action
        with:
          gradle-command: >
            :sdks:java:testing:nexmark:run -Pnexmark.runner.version=V2 -Pnexmark.runner=:runners:google-cloud-dataflow-java
            -Pnexmark.args="  
              --bigQueryTable=$BIGQUERYTABLE
              --bigQueryDataset=$BIGQUERYDATASET
              --project=$PROJECT
              --resourceNameMode=$RESOURCENAMEMODE
              --exportSummaryToBigQuery=$EXPORTSUMMARYTOBIGQUERY
              --tempLocation=$TEMPLOCATION
              --influxDatabase=$INFLUXDATABASE
              --influxHost=$INFLUXHOST
              --baseInfluxMeasurement=$BASEINFLUXMEASUREMENT
              --exportSummaryToInfluxDB=$EXPORTSUMMARYTOINFLUXDB
              --influxRetentionPolicy=$INFLUXRETENTIONPOLICY
              --influxTags=$INFLUXTAGSJAVA17
              --region=us-central1 
              --suite=STRESS 
              --numWorkers=4 
              --maxNumWorkers=4 
              --autoscalingAlgorithm=NONE 
              --nexmarkParallel=16 
              --enforceEncodability=true 
              --enforceImmutability=true 
              --runner=DataflowRunner 
              --streaming=false 
              --monitorJobs=true 
              --manageResources=false "
      