#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

pipelines:
  - pipeline:
      type: composite
      transforms:
        - type: Create
          config:
            elements:
              - {a: "x", b: 1}
              - {a: "x", b: 2}
              - {a: "x", b: 3}
              - {a: "y", b: 10}

        - type: chain
          name: Filtering
          input: Create
          transforms:

            - type: Sql
              config:
                query: "SELECT * FROM PCOLLECTION WHERE b > 2"

            - type: AssertEqual
              config:
                elements:
                  - {a: "x", b: 3}
                  - {a: "y", b: 10}

        - type: chain
          name: Grouping
          input: Create
          transforms:

            - type: Sql
              config:
                query:
                  "SELECT a, sum(b) as s FROM PCOLLECTION GROUP BY a"

            - type: AssertEqual
              config:
                elements:
                  - {a: "x", s: 6}
                  - {a: "y", s: 10}

        - type: chain
          name: Dialect
          input: Create
          transforms:

            - type: Sql
              config:
                query:
                  "SELECT a, cast(b AS VARCHAR) as s FROM PCOLLECTION"

            - type: AssertEqual
              config:
                elements:
                  - {a: "x", s: "1"}
                  - {a: "x", s: "2"}
                  - {a: "x", s: "3"}
                  - {a: "y", s: "10"}

  - pipeline:
      type: chain
      transforms:
        - type: Create
          name: CreateSampleData
          config:
            elements:
              - { id: 1, name: "John" }
              - { id: 2, name: "Jane" }
        - type: Sql
          name: sql
          config:
            query: >
              SELECT *, CURRENT_TIMESTAMP AS ingest_timestamp FROM PCOLLECTION
        - type: PyTransform
          config:
            constructor: apache_beam.transforms.util.LogElements

  # Test calcite_connection_properties with PostgreSQL functions
  - pipeline:
      type: chain
      transforms:
        - type: Create
          name: CreateEmailData
          config:
            elements:
              - {email: "alice@example.com", id: 1}
              - {email: "bob@test.org", id: 2}
        
        - type: Sql
          name: PostgreSQLFunctions
          options:
            calcite_connection_properties:
              fun: "postgresql"
          config:
            query: |
              SELECT 
                id,
                email,
                SPLIT_PART(email, '@', 1) as username,
                SPLIT_PART(email, '@', 2) as domain
              FROM PCOLLECTION

        - type: AssertEqual
          config:
            elements:
              - {id: 1, email: "alice@example.com", username: "alice", domain: "example.com"}
              - {id: 2, email: "bob@test.org", username: "bob", domain: "test.org"}  # Test calcite_connection_properties with BigQuery syntax
  - pipeline:
      type: chain
      transforms:
        - type: Create
          name: CreateArrayData
          config:
            elements:
              - {id: 1, tags: ["tag1", "tag2", "tag3"]}
              - {id: 2, tags: ["tagA", "tagB"]}
        
        - type: Sql
          name: BigQueryArrayFunctions
          options:
            calcite_connection_properties:
              fun: "bigquery"
              lex: "big_query"
          config:
            query: |
              SELECT 
                id,
                ARRAY_TO_STRING(tags, '|') as tags_string,
                ARRAY_LENGTH(tags) as tag_count
              FROM PCOLLECTION

        - type: AssertEqual
          config:
            elements:
              - {id: 1, tags_string: "tag1|tag2|tag3", tag_count: 3}
              - {id: 2, tags_string: "tagA|tagB", tag_count: 2}

  # Test calcite_connection_properties with case sensitivity settings
  - pipeline:
      type: chain
      transforms:
        - type: Create
          name: CreateCaseTestData
          config:
            elements:
              - {ID: 1, Name: "Alice", Email: "alice@test.com"}
              - {ID: 2, Name: "Bob", Email: "bob@test.com"}
        
        - type: Sql
          name: CaseSensitiveSQL
          options:
            calcite_connection_properties:
              caseSensitive: "false"
              unquotedCasing: "TO_LOWER"
          config:
            query: |
              SELECT 
                id as lower_id,
                name as lower_name,
                email as lower_email
              FROM PCOLLECTION

        - type: AssertEqual
          config:
            elements:
              - {lower_id: 1, lower_name: "Alice", lower_email: "alice@test.com"}
              - {lower_id: 2, lower_name: "Bob", lower_email: "bob@test.com"}