<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Apache Spark Runner</title><meta name=description content="Apache Beam is an open source, unified model and set of language-specific SDKs for defining and executing data processing workflows, and also data ingestion and integration flows, supporting Enterprise Integration Patterns (EIPs) and Domain Specific Languages (DSLs). Dataflow pipelines simplify the mechanics of large-scale batch and streaming data processing and can run on a number of runtimes like Apache Flink, Apache Spark, and Google Cloud Dataflow (a cloud service). Beam also brings DSL in different languages, allowing users to easily implement their data integration processes."><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400" rel=stylesheet><link rel=preload href=/scss/main.min.7bfa213b38fe814e9a5d5af502d4d2e0d4e9e7dfe8a528843e32a858c6c92bc2.css as=style><link href=/scss/main.min.7bfa213b38fe814e9a5d5af502d4d2e0d4e9e7dfe8a528843e32a858c6c92bc2.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-2.2.4.min.js></script><style>.body__contained img{max-width:100%}</style><script src=/js/bootstrap.min.js></script><script src=/js/language-switch.js></script><script src=/js/fix-menu.js></script><script src=/js/section-nav.js></script><script src=/js/page-nav.js></script><link rel=alternate type=application/rss+xml title="Apache Beam" href=/feed.xml><link rel=canonical href=/documentation/runners/spark/ data-proofer-ignore><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.4.1/css/all.css integrity=sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz crossorigin=anonymous><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-73650088-1','auto');ga('send','pageview');</script></head><body class=body data-spy=scroll data-target=.page-nav data-offset=0><nav class="header navbar navbar-fixed-top"><div class=navbar-header><button type=button class=navbar-toggle aria-expanded=false aria-controls=navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a href=/ class=navbar-brand><img alt=Brand style=height:25px src=/images/beam_logo_navbar.png></a></div><div class="navbar-mask closed"></div><div id=navbar class="navbar-container closed"><ul class="nav navbar-nav"><li><a href=/get-started/beam-overview/>Get Started</a></li><li><a href=/documentation/>Documentation</a></li><li><a href=/documentation/sdks/java/>Languages</a></li><li><a href=/documentation/runners/capability-matrix/>RUNNERS</a></li><li><a href=/roadmap/>Roadmap</a></li><li><a href=/contribute/>Contribute</a></li><li><a href=/community/contact-us/>Community</a></li><li><a href=/blog/>Blog</a></li></ul><ul class="nav navbar-nav navbar-right"><li><div style=width:300px><script>(function(){var cx='012923275103528129024:4emlchv9wzi';var gcse=document.createElement('script');gcse.type='text/javascript';gcse.async=true;gcse.src='https://cse.google.com/cse.js?cx='+cx;var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(gcse,s);})();</script><gcse:search></gcse:search></div></li><li class=dropdown><a href=# class=dropdown-toggle data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px><span class=caret></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a href=http://www.apache.org/>ASF Homepage</a></li><li><a href=http://www.apache.org/licenses/>License</a></li><li><a href=http://www.apache.org/security/>Security</a></li><li><a href=http://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li><li><a href=https://github.com/apache/beam/edit/master/website/www/site/content/en/documentation/runners/spark.md data-proofer-ignore><i class="far fa-edit fa-lg" alt="Edit on GitHub" title="Edit on GitHub"></i></a></li></ul></div></nav><div class="clearfix container-main-content"><div class="section-nav closed" data-offset-top=90 data-offset-bottom=500><span class="section-nav-back glyphicon glyphicon-menu-left"></span><nav><ul class=section-nav-list data-section-nav><li><span class=section-nav-list-main-title>Runners</span></li><li><a href=/documentation/runners/capability-matrix/>Capability Matrix</a></li><li><a href=/documentation/runners/direct/>Direct Runner</a></li><li><a href=/documentation/runners/flink/>Apache Flink</a></li><li><a href=/documentation/runners/nemo/>Apache Nemo</a></li><li><a href=/documentation/runners/samza/>Apache Samza</a></li><li><a href=/documentation/runners/spark/>Apache Spark</a></li><li><a href=/documentation/runners/dataflow/>Google Cloud Dataflow</a></li><li><a href=/documentation/runners/jet/>Hazelcast Jet</a></li><li><a href=/documentation/runners/twister2/>Twister2</a></li></ul></nav></div><nav class="page-nav clearfix" data-offset-top=90 data-offset-bottom=500><nav id=TableOfContents><ul><li><a href=#three-flavors-of-the-spark-runner>Three flavors of the Spark runner</a></li><li><a href=#which-runner-to-use-portable-or-non-portable-runner>Which runner to use: portable or non portable runner?</a></li><li><a href=#spark-runner-prerequisites-and-setup>Spark Runner prerequisites and setup</a><ul><li><a href=#deploying-spark-with-your-application>Deploying Spark with your application</a></li><li><a href=#running-on-a-pre-deployed-spark-cluster>Running on a pre-deployed Spark cluster</a></li></ul></li><li><a href=#pipeline-options-for-the-spark-runner>Pipeline options for the Spark Runner</a></li><li><a href=#additional-notes>Additional notes</a><ul><li><a href=#using-spark-submit>Using spark-submit</a></li><li><a href=#monitoring-your-job>Monitoring your job</a></li><li><a href=#streaming-execution>Streaming Execution</a></li><li><a href=#using-a-provided-sparkcontext-and-streaminglisteners>Using a provided SparkContext and StreamingListeners</a></li></ul></li></ul></nav></nav><div class="body__contained body__section-nav"><h1 id=using-the-apache-spark-runner>Using the Apache Spark Runner</h1><p>The Apache Spark Runner can be used to execute Beam pipelines using <a href=https://spark.apache.org/>Apache Spark</a>.
The Spark Runner can execute Spark pipelines just like a native Spark application; deploying a self-contained application for local mode, running on Spark&rsquo;s Standalone RM, or using YARN or Mesos.</p><p>The Spark Runner executes Beam pipelines on top of Apache Spark, providing:</p><ul><li>Batch and streaming (and combined) pipelines.</li><li>The same fault-tolerance <a href=https://spark.apache.org/docs/latest/streaming-programming-guide.html#fault-tolerance-semantics>guarantees</a> as provided by RDDs and DStreams.</li><li>The same <a href=https://spark.apache.org/docs/latest/security.html>security</a> features Spark provides.</li><li>Built-in metrics reporting using Spark&rsquo;s metrics system, which reports Beam Aggregators as well.</li><li>Native support for Beam side-inputs via spark&rsquo;s Broadcast variables.</li></ul><p>The <a href=/documentation/runners/capability-matrix/>Beam Capability Matrix</a> documents the currently supported capabilities of the Spark Runner.</p><h2 id=three-flavors-of-the-spark-runner>Three flavors of the Spark runner</h2><p>The Spark runner comes in three flavors:</p><ol><li>A <em>legacy Runner</em> which supports only Java (and other JVM-based languages) and that is based on Spark RDD/DStream</li><li>An <em>Structured Streaming Spark Runner</em> which supports only Java (and other JVM-based languages) and that is based on Spark Datasets and the <a href=https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html>Apache Spark Structured Streaming</a> framework.</li></ol><blockquote><p><strong>Note:</strong> It is still experimental, its coverage of the Beam model is partial. As for now it only supports batch mode.</p></blockquote><ol start=3><li>A <em>portable Runner</em> which supports Java, Python, and Go</li></ol><p>This guide is split into two parts to document the non-portable and
the portable functionality of the Spark Runner. Please use the switcher below to
select the appropriate Runner:</p><h2 id=which-runner-to-use-portable-or-non-portable-runner>Which runner to use: portable or non portable runner?</h2><p>Beam and its Runners originally only supported JVM-based languages
(e.g. Java/Scala/Kotlin). Python and Go SDKs were added later on. The
architecture of the Runners had to be changed significantly to support executing
pipelines written in other languages.</p><p>If your applications only use Java, then you should currently go with one of the java based runners.
If you want to run Python or Go pipelines with Beam on Spark, you need to use
the portable Runner. For more information on portability, please visit the
<a href=/roadmap/portability/>Portability page</a>.</p><nav class=language-switcher><strong>Adapt for:</strong><ul><li data-type=language-java>Non portable (Java)</li><li data-type=language-py>Portable (Java/Python/Go)</li></ul></nav><h2 id=spark-runner-prerequisites-and-setup>Spark Runner prerequisites and setup</h2><p>The Spark runner currently supports Spark&rsquo;s 2.x branch, and more specifically any version greater than 2.4.0.</p><p class=language-java>You can add a dependency on the latest version of the Spark runner by adding to your pom.xml the following:</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>beam</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>beam</span><span class=o>-</span><span class=n>runners</span><span class=o>-</span><span class=n>spark</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>version</span><span class=o>&gt;</span><span class=n>2</span><span class=o>.</span><span class=na>24</span><span class=o>.</span><span class=na>0</span><span class=o>&lt;/</span><span class=n>version</span><span class=o>&gt;</span>
<span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span></code></pre></div></div><h3 id=deploying-spark-with-your-application>Deploying Spark with your application</h3><p class=language-java>In some cases, such as running in local mode/Standalone, your (self-contained) application would be required to pack Spark by explicitly adding the following dependencies in your pom.xml:</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>spark</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>spark</span><span class=o>-</span><span class=n>core_2</span><span class=o>.</span><span class=na>11</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>version</span><span class=o>&gt;</span><span class=n>$</span><span class=o>{</span><span class=n>spark</span><span class=o>.</span><span class=na>version</span><span class=o>}&lt;/</span><span class=n>version</span><span class=o>&gt;</span>
<span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span>

<span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>spark</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>spark</span><span class=o>-</span><span class=n>streaming_2</span><span class=o>.</span><span class=na>11</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>version</span><span class=o>&gt;</span><span class=n>$</span><span class=o>{</span><span class=n>spark</span><span class=o>.</span><span class=na>version</span><span class=o>}&lt;/</span><span class=n>version</span><span class=o>&gt;</span>
<span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span></code></pre></div></div><p class=language-java>And shading the application jar using the maven shade plugin:</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=o>&lt;</span><span class=n>plugin</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>maven</span><span class=o>.</span><span class=na>plugins</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>maven</span><span class=o>-</span><span class=n>shade</span><span class=o>-</span><span class=n>plugin</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>configuration</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=n>createDependencyReducedPom</span><span class=o>&gt;</span><span class=kc>false</span><span class=o>&lt;/</span><span class=n>createDependencyReducedPom</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=n>filters</span><span class=o>&gt;</span>
      <span class=o>&lt;</span><span class=n>filter</span><span class=o>&gt;</span>
        <span class=o>&lt;</span><span class=n>artifact</span><span class=o>&gt;*:*&lt;/</span><span class=n>artifact</span><span class=o>&gt;</span>
        <span class=o>&lt;</span><span class=n>excludes</span><span class=o>&gt;</span>
          <span class=o>&lt;</span><span class=n>exclude</span><span class=o>&gt;</span><span class=n>META</span><span class=o>-</span><span class=n>INF</span><span class=o>/*.</span><span class=na>SF</span><span class=o>&lt;/</span><span class=n>exclude</span><span class=o>&gt;</span>
          <span class=o>&lt;</span><span class=n>exclude</span><span class=o>&gt;</span><span class=n>META</span><span class=o>-</span><span class=n>INF</span><span class=o>/*.</span><span class=na>DSA</span><span class=o>&lt;/</span><span class=n>exclude</span><span class=o>&gt;</span>
          <span class=o>&lt;</span><span class=n>exclude</span><span class=o>&gt;</span><span class=n>META</span><span class=o>-</span><span class=n>INF</span><span class=o>/*.</span><span class=na>RSA</span><span class=o>&lt;/</span><span class=n>exclude</span><span class=o>&gt;</span>
        <span class=o>&lt;/</span><span class=n>excludes</span><span class=o>&gt;</span>
      <span class=o>&lt;/</span><span class=n>filter</span><span class=o>&gt;</span>
    <span class=o>&lt;/</span><span class=n>filters</span><span class=o>&gt;</span>
  <span class=o>&lt;/</span><span class=n>configuration</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=n>executions</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=n>execution</span><span class=o>&gt;</span>
      <span class=o>&lt;</span><span class=n>phase</span><span class=o>&gt;</span><span class=n>package</span><span class=o>&lt;/</span><span class=n>phase</span><span class=o>&gt;</span>
      <span class=o>&lt;</span><span class=n>goals</span><span class=o>&gt;</span>
        <span class=o>&lt;</span><span class=n>goal</span><span class=o>&gt;</span><span class=n>shade</span><span class=o>&lt;/</span><span class=n>goal</span><span class=o>&gt;</span>
      <span class=o>&lt;/</span><span class=n>goals</span><span class=o>&gt;</span>
      <span class=o>&lt;</span><span class=n>configuration</span><span class=o>&gt;</span>
        <span class=o>&lt;</span><span class=n>shadedArtifactAttached</span><span class=o>&gt;</span><span class=kc>true</span><span class=o>&lt;/</span><span class=n>shadedArtifactAttached</span><span class=o>&gt;</span>
        <span class=o>&lt;</span><span class=n>shadedClassifierName</span><span class=o>&gt;</span><span class=n>shaded</span><span class=o>&lt;/</span><span class=n>shadedClassifierName</span><span class=o>&gt;</span>
        <span class=o>&lt;</span><span class=n>transformers</span><span class=o>&gt;</span>
          <span class=o>&lt;</span><span class=n>transformer</span>
            <span class=n>implementation</span><span class=o>=</span><span class=s>&#34;org.apache.maven.plugins.shade.resource.ServicesResourceTransformer&#34;</span><span class=o>/&gt;</span>
        <span class=o>&lt;/</span><span class=n>transformers</span><span class=o>&gt;</span>
      <span class=o>&lt;/</span><span class=n>configuration</span><span class=o>&gt;</span>
    <span class=o>&lt;/</span><span class=n>execution</span><span class=o>&gt;</span>
  <span class=o>&lt;/</span><span class=n>executions</span><span class=o>&gt;</span>
<span class=o>&lt;/</span><span class=n>plugin</span><span class=o>&gt;</span></code></pre></div></div><p class=language-java>After running <code>mvn package</code>, run <code>ls target</code> and you should see (assuming your artifactId is <code>beam-examples</code> and the version is <code>1.0.0</code>):</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>beam</span><span class=o>-</span><span class=n>examples</span><span class=o>-</span><span class=n>1</span><span class=o>.</span><span class=na>0</span><span class=o>.</span><span class=na>0</span><span class=o>-</span><span class=n>shaded</span><span class=o>.</span><span class=na>jar</span></code></pre></div></div><p class=language-java>To run against a Standalone cluster simply run:</p><p class=language-java><br><b>For RDD/DStream based runner:</b><br></p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>spark</span><span class=o>-</span><span class=n>submit</span> <span class=o>--</span><span class=kd>class</span> <span class=nc>com</span><span class=o>.</span><span class=na>beam</span><span class=o>.</span><span class=na>examples</span><span class=o>.</span><span class=na>BeamPipeline</span> <span class=o>--</span><span class=n>master</span> <span class=n>spark</span><span class=o>://</span><span class=n>HOST</span><span class=o>:</span><span class=n>PORT</span> <span class=n>target</span><span class=o>/</span><span class=n>beam</span><span class=o>-</span><span class=n>examples</span><span class=o>-</span><span class=n>1</span><span class=o>.</span><span class=na>0</span><span class=o>.</span><span class=na>0</span><span class=o>-</span><span class=n>shaded</span><span class=o>.</span><span class=na>jar</span> <span class=o>--</span><span class=n>runner</span><span class=o>=</span><span class=n>SparkRunner</span></code></pre></div></div><p class=language-java><br><b>For Structured Streaming based runner:</b><br></p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>spark</span><span class=o>-</span><span class=n>submit</span> <span class=o>--</span><span class=kd>class</span> <span class=nc>com</span><span class=o>.</span><span class=na>beam</span><span class=o>.</span><span class=na>examples</span><span class=o>.</span><span class=na>BeamPipeline</span> <span class=o>--</span><span class=n>master</span> <span class=n>spark</span><span class=o>://</span><span class=n>HOST</span><span class=o>:</span><span class=n>PORT</span> <span class=n>target</span><span class=o>/</span><span class=n>beam</span><span class=o>-</span><span class=n>examples</span><span class=o>-</span><span class=n>1</span><span class=o>.</span><span class=na>0</span><span class=o>.</span><span class=na>0</span><span class=o>-</span><span class=n>shaded</span><span class=o>.</span><span class=na>jar</span> <span class=o>--</span><span class=n>runner</span><span class=o>=</span><span class=n>SparkStructuredStreamingRunner</span></code></pre></div></div><p class=language-py>You will need Docker to be installed in your execution environment. To develop
Apache Beam with Python you have to install the Apache Beam Python SDK: <code>pip install apache_beam</code>. Please refer to the <a href=/documentation/sdks/python/>Python documentation</a>
on how to create a Python pipeline.</p><div class=language-py><div class=highlight><pre class=chroma><code class=language-py data-lang=py><span class=n>pip</span> <span class=n>install</span> <span class=n>apache_beam</span></code></pre></div></div><p class=language-py>Starting from Beam 2.20.0, pre-built Spark Job Service Docker images are available at
<a href=https://hub.docker.com/r/apache/beam_spark_job_server>Docker Hub</a>.</p><p class=language-py>For older Beam versions, you will need a copy of Apache Beam&rsquo;s source code. You can
download it on the <a href=/get-started/downloads/>Downloads page</a>.</p><p class=language-py><ol><li>Start the JobService endpoint:<ul><li>with Docker (preferred): <code>docker run --net=host apache/beam_spark_job_server:latest</code></li><li>or from Beam source code: <code>./gradlew :runners:spark:job-server:runShadow</code></li></ul></li></ol></p><p class=language-py>The JobService is the central instance where you submit your Beam pipeline.
The JobService will create a Spark job for the pipeline and execute the
job. To execute the job on a Spark cluster, the Beam JobService needs to be
provided with the Spark master address.</p><p class=language-py><ol start=2><li>Submit the Python pipeline to the above endpoint by using the <code>PortableRunner</code>, <code>job_endpoint</code> set to <code>localhost:8099</code> (this is the default address of the JobService), and <code>environment_type</code> set to <code>LOOPBACK</code>. For example:</li></ol></p><div class=language-py><div class=highlight><pre class=chroma><code class=language-py data-lang=py><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=kn>as</span> <span class=nn>beam</span>
<span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>PipelineOptions</span>

<span class=n>options</span> <span class=o>=</span> <span class=n>PipelineOptions</span><span class=p>([</span>
    <span class=s2>&#34;--runner=PortableRunner&#34;</span><span class=p>,</span>
    <span class=s2>&#34;--job_endpoint=localhost:8099&#34;</span><span class=p>,</span>
    <span class=s2>&#34;--environment_type=LOOPBACK&#34;</span>
<span class=p>])</span>
<span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
    <span class=o>...</span></code></pre></div></div><h3 id=running-on-a-pre-deployed-spark-cluster>Running on a pre-deployed Spark cluster</h3><p>Deploying your Beam pipeline on a cluster that already has a Spark deployment (Spark classes are available in container classpath) does not require any additional dependencies.
For more details on the different deployment modes see: <a href=https://spark.apache.org/docs/latest/spark-standalone.html>Standalone</a>, <a href=https://spark.apache.org/docs/latest/running-on-yarn.html>YARN</a>, or <a href=https://spark.apache.org/docs/latest/running-on-mesos.html>Mesos</a>.</p><p class=language-py><ol><li>Start a Spark cluster which exposes the master on port 7077 by default.</li></ol></p><p class=language-py><ol start=2><li>Start JobService that will connect with the Spark master:<ul><li>with Docker (preferred): <code>docker run --net=host apache/beam_spark_job_server:latest --spark-master-url=spark://localhost:7077</code></li><li>or from Beam source code: <code>./gradlew :runners:spark:job-server:runShadow -PsparkMasterUrl=spark://localhost:7077</code></li></ul></li></ol></p><p class=language-py><ol start=3><li>Submit the pipeline as above.
Note however that <code>environment_type=LOOPBACK</code> is only intended for local testing.
See <a href=/roadmap/portability/#sdk-harness-config>here</a> for details.</li></ol></p><p class=language-py>(Note that, depending on your cluster setup, you may need to change the <code>environment_type</code> option.
See <a href=/roadmap/portability/#sdk-harness-config>here</a> for details.)</p><h2 id=pipeline-options-for-the-spark-runner>Pipeline options for the Spark Runner</h2><p>When executing your pipeline with the Spark Runner, you should consider the following pipeline options.</p><p class=language-java><br><b>For RDD/DStream based runner:</b><br></p><table class="language-java table table-bordered"><tr><th>Field</th><th>Description</th><th>Default Value</th></tr><tr><td><code>runner</code></td><td>The pipeline runner to use. This option allows you to determine the pipeline runner at runtime.</td><td>Set to <code>SparkRunner</code> to run using Spark.</td></tr><tr><td><code>sparkMaster</code></td><td>The url of the Spark Master. This is the equivalent of setting <code>SparkConf#setMaster(String)</code> and can either be <code>local[x]</code> to run local with x cores, <code>spark://host:port</code> to connect to a Spark Standalone cluster, <code>mesos://host:port</code> to connect to a Mesos cluster, or <code>yarn</code> to connect to a yarn cluster.</td><td><code>local[4]</code></td></tr><tr><td><code>storageLevel</code></td><td>The <code>StorageLevel</code> to use when caching RDDs in batch pipelines. The Spark Runner automatically caches RDDs that are evaluated repeatedly. This is a batch-only property as streaming pipelines in Beam are stateful, which requires Spark DStream's <code>StorageLevel</code> to be <code>MEMORY_ONLY</code>.</td><td>MEMORY_ONLY</td></tr><tr><td><code>batchIntervalMillis</code></td><td>The <code>StreamingContext</code>'s <code>batchDuration</code> - setting Spark's batch interval.</td><td><code>1000</code></td></tr><tr><td><code>enableSparkMetricSinks</code></td><td>Enable reporting metrics to Spark's metrics Sinks.</td><td>true</td></tr><tr><td><code>cacheDisabled</code></td><td>Disable caching of reused PCollections for whole Pipeline. It's useful when it's faster to recompute RDD rather than save.</td><td>false</td></tr></table><p class=language-java><br><b>For Structured Streaming based runner:</b><br></p><table class="language-java table table-bordered"><tr><th>Field</th><th>Description</th><th>Default Value</th></tr><tr><td><code>runner</code></td><td>The pipeline runner to use. This option allows you to determine the pipeline runner at runtime.</td><td>Set to <code>SparkStructuredStreamingRunner</code> to run using Spark Structured Streaming.</td></tr><tr><td><code>sparkMaster</code></td><td>The url of the Spark Master. This is the equivalent of setting <code>SparkConf#setMaster(String)</code> and can either be <code>local[x]</code> to run local with x cores, <code>spark://host:port</code> to connect to a Spark Standalone cluster, <code>mesos://host:port</code> to connect to a Mesos cluster, or <code>yarn</code> to connect to a yarn cluster.</td><td><code>local[4]</code></td></tr><tr><td><code>testMode</code></td><td>Enable test mode that gives useful debugging information: catalyst execution plans and Beam DAG printing</td><td>false</td></tr><tr><td><code>enableSparkMetricSinks</code></td><td>Enable reporting metrics to Spark's metrics Sinks.</td><td>true</td></tr><tr><td><code>checkpointDir</code></td><td>A checkpoint directory for streaming resilience, ignored in batch. For durability, a reliable filesystem such as HDFS/S3/GS is necessary.</td><td>local dir in /tmp</td></tr><tr><td><code>filesToStage</code></td><td>Jar-Files to send to all workers and put on the classpath.</td><td>all files from the classpath</td></tr><tr><td><code>EnableSparkMetricSinks</code></td><td>Enable/disable sending aggregator values to Spark's metric sinks</td><td>true</td></tr></table><table class="language-py table table-bordered"><tr><th>Field</th><th>Description</th><th>Value</th></tr><tr><td><code>--runner</code></td><td>The pipeline runner to use. This option allows you to determine the pipeline runner at runtime.</td><td>Set to <code>PortableRunner</code> to run using Spark.</td></tr><tr><td><code>--job_endpoint</code></td><td>Job service endpoint to use. Should be in the form hostname:port, e.g. localhost:3000</td><td>Set to match your job service endpoint (localhost:8099 by default)</td></tr></table><h2 id=additional-notes>Additional notes</h2><h3 id=using-spark-submit>Using spark-submit</h3><p>When submitting a Spark application to cluster, it is common (and recommended) to use the <code>spark-submit</code> script that is provided with the spark installation.
The <code>PipelineOptions</code> described above are not to replace <code>spark-submit</code>, but to complement it.
Passing any of the above mentioned options could be done as one of the <code>application-arguments</code>, and setting <code>&ndash;master</code> takes precedence.
For more on how to generally use <code>spark-submit</code> checkout Spark <a href=https://spark.apache.org/docs/latest/submitting-applications.html#launching-applications-with-spark-submit>documentation</a>.</p><h3 id=monitoring-your-job>Monitoring your job</h3><p>You can monitor a running Spark job using the Spark <a href=https://spark.apache.org/docs/latest/monitoring.html#web-interfaces>Web Interfaces</a>. By default, this is available at port <code>4040</code> on the driver node. If you run Spark on your local machine that would be <code>http://localhost:4040</code>.
Spark also has a history server to <a href=https://spark.apache.org/docs/latest/monitoring.html#viewing-after-the-fact>view after the fact</a>.<p class=language-java>Metrics are also available via <a href=https://spark.apache.org/docs/latest/monitoring.html#rest-api>REST API</a>.
Spark provides a <a href=https://spark.apache.org/docs/latest/monitoring.html#metrics>metrics system</a> that allows reporting Spark metrics to a variety of Sinks. The Spark runner reports user-defined Beam Aggregators using this same metrics system and currently supports <code>GraphiteSink</code> and <code>CSVSink</code>, and providing support for additional Sinks supported by Spark is easy and straight-forward.</p><p class=language-py>Spark metrics are not yet supported on the portable runner.</p></p><h3 id=streaming-execution>Streaming Execution</h3><p class=language-java><br><b>For RDD/DStream based runner:</b><br>If your pipeline uses an <code>UnboundedSource</code> the Spark Runner will automatically set streaming mode. Forcing streaming mode is mostly used for testing and is not recommended.<br><br><b>For Structured Streaming based runner:</b><br>Streaming mode is not implemented yet in the Spark Structured Streaming runner.</p><p class=language-py>Streaming is not yet supported on the Spark portable runner.</p><h3 id=using-a-provided-sparkcontext-and-streaminglisteners>Using a provided SparkContext and StreamingListeners</h3><p class=language-java><br><b>For RDD/DStream based runner:</b><br>If you would like to execute your Spark job with a provided <code>SparkContext</code>, such as when using the <a href=https://github.com/spark-jobserver/spark-jobserver>spark-jobserver</a>, or use <code>StreamingListeners</code>, you can&rsquo;t use <code>SparkPipelineOptions</code> (the context or a listener cannot be passed as a command-line argument anyway).
Instead, you should use <code>SparkContextOptions</code> which can only be used programmatically and is not a common <code>PipelineOptions</code> implementation.<br><br><b>For Structured Streaming based runner:</b><br>Provided SparkSession and StreamingListeners are not supported on the Spark Structured Streaming runner</p><p class=language-py>Provided SparkContext and StreamingListeners are not supported on the Spark portable runner.</p></div></div><footer class=footer><div class=footer__contained><div class=footer__cols><div class=footer__cols__col><div class=footer__cols__col__logo><img src=/images/beam_logo_circle.svg class=footer__logo alt="Beam logo"></div><div class=footer__cols__col__logo><img src=/images/apache_logo_circle.svg class=footer__logo alt="Apache logo"></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Start</div><div class=footer__cols__col__link><a href=/get-started/beam-overview/>Overview</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-java/>Quickstart (Java)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-py/>Quickstart (Python)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-go/>Quickstart (Go)</a></div><div class=footer__cols__col__link><a href=/get-started/downloads/>Downloads</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Docs</div><div class=footer__cols__col__link><a href=/documentation/programming-guide/>Concepts</a></div><div class=footer__cols__col__link><a href=/documentation/pipelines/design-your-pipeline/>Pipelines</a></div><div class=footer__cols__col__link><a href=/documentation/runners/capability-matrix/>Runners</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Community</div><div class=footer__cols__col__link><a href=/contribute/>Contribute</a></div><div class=footer__cols__col__link><a href=https://projects.apache.org/committee.html?beam target=_blank>Team<img src=/images/external-link-icon.png width=14 height=14 alt="External link."></a></div><div class=footer__cols__col__link><a href=/community/presentation-materials/>Media</a></div><div class=footer__cols__col__link><a href=/community/in-person/>Events/Meetups</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Resources</div><div class=footer__cols__col__link><a href=/blog/>Blog</a></div><div class=footer__cols__col__link><a href=/community/contact-us/>Contact Us</a></div><div class=footer__cols__col__link><a href=https://github.com/apache/beam>GitHub</a></div></div></div></div><div class=footer__bottom>&copy;
<a href=http://www.apache.org>The Apache Software Foundation</a>
| <a href=/privacy_policy>Privacy Policy</a>
| <a href=/feed.xml>RSS Feed</a><br><br>Apache Beam, Apache, Beam, the Beam logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation. All other products or name brands are trademarks of their respective holders, including The Apache Software Foundation.</div></footer></body></html>