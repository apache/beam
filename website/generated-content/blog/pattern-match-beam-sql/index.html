<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Pattern Matching with Beam SQL</title><meta name=description content="Apache Beam is an open source, unified model and set of language-specific SDKs for defining and executing data processing workflows, and also data ingestion and integration flows, supporting Enterprise Integration Patterns (EIPs) and Domain Specific Languages (DSLs). Dataflow pipelines simplify the mechanics of large-scale batch and streaming data processing and can run on a number of runtimes like Apache Flink, Apache Spark, and Google Cloud Dataflow (a cloud service). Beam also brings DSL in different languages, allowing users to easily implement their data integration processes."><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400" rel=stylesheet><link rel=preload href=/scss/main.min.7bfa213b38fe814e9a5d5af502d4d2e0d4e9e7dfe8a528843e32a858c6c92bc2.css as=style><link href=/scss/main.min.7bfa213b38fe814e9a5d5af502d4d2e0d4e9e7dfe8a528843e32a858c6c92bc2.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-2.2.4.min.js></script><style>.body__contained img{max-width:100%}</style><script src=/js/bootstrap.min.js></script><script src=/js/language-switch.js></script><script src=/js/fix-menu.js></script><script src=/js/section-nav.js></script><script src=/js/page-nav.js></script><link rel=alternate type=application/rss+xml title="Apache Beam" href=/feed.xml><link rel=canonical href=/blog/pattern-match-beam-sql/ data-proofer-ignore><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.4.1/css/all.css integrity=sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz crossorigin=anonymous><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-73650088-1','auto');ga('send','pageview');</script></head><body class=body><nav class="header navbar navbar-fixed-top"><div class=navbar-header><button type=button class=navbar-toggle aria-expanded=false aria-controls=navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a href=/ class=navbar-brand><img alt=Brand style=height:25px src=/images/beam_logo_navbar.png></a></div><div class="navbar-mask closed"></div><div id=navbar class="navbar-container closed"><ul class="nav navbar-nav"><li><a href=/get-started/beam-overview/>Get Started</a></li><li><a href=/documentation/>Documentation</a></li><li><a href=/documentation/sdks/java/>Languages</a></li><li><a href=/documentation/runners/capability-matrix/>RUNNERS</a></li><li><a href=/roadmap/>Roadmap</a></li><li><a href=/contribute/>Contribute</a></li><li><a href=/community/contact-us/>Community</a></li><li><a href=/blog/>Blog</a></li></ul><ul class="nav navbar-nav navbar-right"><li><div style=width:300px><script>(function(){var cx='012923275103528129024:4emlchv9wzi';var gcse=document.createElement('script');gcse.type='text/javascript';gcse.async=true;gcse.src='https://cse.google.com/cse.js?cx='+cx;var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(gcse,s);})();</script><gcse:search></gcse:search></div></li><li class=dropdown><a href=# class=dropdown-toggle data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px><span class=caret></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a href=http://www.apache.org/>ASF Homepage</a></li><li><a href=http://www.apache.org/licenses/>License</a></li><li><a href=http://www.apache.org/security/>Security</a></li><li><a href=http://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li><li><a href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/pattern-match-beam-sql.md data-proofer-ignore><i class="far fa-edit fa-lg" alt="Edit on GitHub" title="Edit on GitHub"></i></a></li></ul></div></nav><div class=body__contained><article class=post itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Pattern Matching with Beam SQL</h1><p class=post-meta><time datetime=2020-08-27T00:00:01+08:00 itemprop=datePublished>Aug 27, 2020</time>
â€¢</p></header><div class=post-content itemprop=articleBody><h2 id=introduction>Introduction</h2><p>SQL is becoming increasingly powerful and useful in the field of data analysis. MATCH_RECOGNIZE,
a new SQL component introduced in 2016, brings extra analytical functionality. This project,
as part of Google Summer of Code, aims to support basic MATCH_RECOGNIZE functionality. A basic MATCH_RECOGNIZE
query would be something like this:<div class=language-sql><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=n>T</span><span class=p>.</span><span class=n>aid</span><span class=p>,</span> <span class=n>T</span><span class=p>.</span><span class=n>bid</span><span class=p>,</span> <span class=n>T</span><span class=p>.</span><span class=n>cid</span>
<span class=k>FROM</span> <span class=n>MyTable</span>
    <span class=n>MATCH_RECOGNIZE</span> <span class=p>(</span>
      <span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>userid</span>
      <span class=k>ORDER</span> <span class=k>BY</span> <span class=n>proctime</span>
      <span class=n>MEASURES</span>
        <span class=n>A</span><span class=p>.</span><span class=n>id</span> <span class=k>AS</span> <span class=n>aid</span><span class=p>,</span>
        <span class=n>B</span><span class=p>.</span><span class=n>id</span> <span class=k>AS</span> <span class=n>bid</span><span class=p>,</span>
        <span class=k>C</span><span class=p>.</span><span class=n>id</span> <span class=k>AS</span> <span class=n>cid</span>
      <span class=n>PATTERN</span> <span class=p>(</span><span class=n>A</span> <span class=n>B</span> <span class=k>C</span><span class=p>)</span>
      <span class=n>DEFINE</span>
        <span class=n>A</span> <span class=k>AS</span> <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=p>,</span>
        <span class=n>B</span> <span class=k>AS</span> <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span>
        <span class=k>C</span> <span class=k>AS</span> <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;c&#39;</span>
    <span class=p>)</span> <span class=k>AS</span> <span class=n>T</span></code></pre></div></div></p><p>The above query finds out ordered sets of events that have names &lsquo;a&rsquo;, &lsquo;b&rsquo; and &lsquo;c&rsquo;. Apart from this basic usage of
MATCH_RECOGNIZE, I supported a few of other crucial features such as quantifiers and row pattern navigation. I will spell out
the details in later sections.</p><h2 id=approach--discussion>Approach & Discussion</h2><p>The implementation is strongly based on BEAM core transforms. Specifically, one MATCH_RECOGNIZE execution composes the
following series of transforms:</p><ol><li>A <code>ParDo</code> transform and then a <code>GroupByKey</code> transform that build up the partitions (PARTITION BY).</li><li>A <code>ParDo</code> transform that sorts within each partition (ORDER BY).</li><li>A <code>ParDo</code> transform that applies pattern-match in each sorted partition.</li></ol><p>A pattern-match operation was first done with the java regex library. That is, I first transform rows within a partition into
a string and then apply regex pattern-match routines. If a row satisfies a condition, then I output the corresponding pattern variable.
This is ok under the assumption that the pattern definitions are mutually exclusive. That is, a pattern definition like <code>A AS A.price > 0, B AS b.price &lt; 0</code> is allowed while
a pattern definition like <code>A AS A.price > 0, B AS B.proctime > 0</code> might results in an incomplete match. For the latter case,
an event can satisfy the conditions A and B at the same time. Mutually exclusive conditions gives deterministic pattern-match:
each event can only belong to at most one pattern class.</p><p>As specified in the SQL 2016 document, MATCH_RECOGNIZE defines a richer set of expression than regular expression. Specifically,
it introduces <em>Row Pattern Navigation Operations</em> such as <code>PREV</code> and <code>NEXT</code>. This is perhaps one of the most intriguing feature of
MATCH_RECOGNIZE. A regex library would no longer suffice the need since the pattern definition could be back-referencing (<code>PREV</code>) or
forward-referencing (<code>NEXT</code>). So for the second version of implementation, we chose to use an NFA regex engine. An NFA brings more flexibility
in terms of non-determinism (see Chapter 6 of SQL 2016 Part 5 for a more thorough discussion). My proposed NFA is based on a paper of UMASS.</p><p>This is a working project. Many of the components are still not supported. I will list some unimplemented work in the section
of future work.</p><h2 id=usages>Usages</h2><p>For now, the components I supported are:</p><ul><li>PARTITION BY</li><li>ORDER BY</li><li>MEASURES<ol><li>LAST</li><li>FIRST</li></ol></li><li>ONE ROW PER MATCH/ALL ROWS PER MATCH</li><li>DEFINE<ol><li>Left side of the condition<ol><li>LAST</li></ol></li><li>Right side of the condition<ol><li>PREV</li></ol></li></ol></li><li>Quantifier<ol><li>Kleene plus</li></ol></li></ul><p>The pattern definition evaluation is hard coded. To be more specific, it expects the column reference of the incoming row
to be on the left side of a comparator. Additionally, PREV function can only appear on the right side of the comparator.</p><p>With these limited tools, we could already write some slightly more complicated queries. Imagine we have the following
table:</p><table><thead><tr><th align=center>transTime</th><th align=center>price</th></tr></thead><tbody><tr><td align=center>1</td><td align=center>3</td></tr><tr><td align=center>2</td><td align=center>2</td></tr><tr><td align=center>3</td><td align=center>1</td></tr><tr><td align=center>4</td><td align=center>5</td></tr><tr><td align=center>5</td><td align=center>6</td></tr></tbody></table><p>This table reflects the price changes of a product with respect to the transaction time. We could write the following
query:</p><div class=language-sql><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=o>*</span>
<span class=k>FROM</span> <span class=n>MyTable</span>
    <span class=n>MATCH_RECOGNIZE</span> <span class=p>(</span>
      <span class=k>ORDER</span> <span class=k>BY</span> <span class=n>transTime</span>
      <span class=n>MEASURES</span>
        <span class=k>LAST</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>price</span><span class=p>)</span> <span class=k>AS</span> <span class=n>beforePrice</span><span class=p>,</span>
        <span class=k>FIRST</span><span class=p>(</span><span class=n>B</span><span class=p>.</span><span class=n>price</span><span class=p>)</span> <span class=k>AS</span> <span class=n>afterPrice</span>
      <span class=n>PATTERN</span> <span class=p>(</span><span class=n>A</span><span class=o>+</span> <span class=n>B</span><span class=o>+</span><span class=p>)</span>
      <span class=n>DEFINE</span>
        <span class=n>A</span> <span class=k>AS</span> <span class=n>price</span> <span class=o>&lt;</span> <span class=n>PREV</span><span class=p>(</span><span class=n>A</span><span class=p>.</span><span class=n>price</span><span class=p>),</span>
        <span class=n>B</span> <span class=k>AS</span> <span class=n>price</span> <span class=o>&gt;</span> <span class=n>PREV</span><span class=p>(</span><span class=n>B</span><span class=p>.</span><span class=n>price</span><span class=p>)</span>
    <span class=p>)</span> <span class=k>AS</span> <span class=n>T</span></code></pre></div></div><p>This will find the local minimum price and the price after it. For the example dataset, the first 3 rows will be
mapped to A and the rest of the rows will be mapped to B. Thus, we will have (1, 5) as the result.</p><blockquote><p>Very important: For my NFA implementation, it slightly breaks the rule in the SQL standard. Since the buffered NFA
only stores an event to the buffer if the event is a match to some pattern class, There would be no way to get the
previous event back if the previous row is discarded. So the first row would always be a match (different from the standard)
if PREV is used.</p></blockquote><h2 id=progress>Progress</h2><ol><li>PRs<ol><li><a href=https://github.com/apache/beam/pull/12232>Support MATCH_RECOGNIZE using regex library</a> (merged)</li><li><a href=https://github.com/apache/beam/pull/12532>Support MATCH_RECOGNIZE using NFA</a> (pending)</li></ol></li><li>Commits<ol><li>partition by: <a href=https://github.com/apache/beam/pull/12232/commits/064ada7257970bcb1d35530be1b88cb3830f242b>commit 064ada7</a></li><li>order by: <a href=https://github.com/apache/beam/pull/12232/commits/9cd1a82bec7b2f7c44aacfbd72f5f775bb58b650>commit 9cd1a82</a></li><li>regex pattern match: <a href=https://github.com/apache/beam/pull/12232/commits/8d6ffcc213e30999fc495c119b68da4f62fad258>commit 8d6ffcc</a></li><li>support quantifiers: <a href=https://github.com/apache/beam/pull/12232/commits/f529b876a2c2e43d012c71b3a83ebd55eb16f4ff>commit f529b87</a></li><li>measures: <a href=https://github.com/apache/beam/pull/12232/commits/87935746647611aa139d664ebed10c8e638bb024>commit 8793574</a></li><li>added NFA implementation: <a href=https://github.com/apache/beam/pull/12532/commits/fc731f2b0699d11853e7b76da86456427d434a2a>commit fc731f2</a></li><li>implemented functions PREV and LAST: <a href=https://github.com/apache/beam/pull/12532/commits/fc731f2b0699d11853e7b76da86456427d434a2a>commit 35323da</a></li></ol></li></ol><h2 id=future-work>Future Work</h2><ul><li>Support FINAL/RUNNING keywords.</li><li>Support more quantifiers.</li><li>Add optimization to the NFA.</li><li>A better way to realize MATCH_RECOGNIZE might be having a Complex Event Processing library at BEAM core (rather than using BEAM transforms).</li></ul><h2 id=references>References</h2><ul><li><a href="https://drive.google.com/file/d/1ZuFZV4dCFVPZW_-RiqbU0w-vShaZh_jX/view?usp=sharing">Project Proposal</a></li><li><a href=https://s.apache.org/beam-sql-pattern-recognization>Design Documentation</a></li><li><a href=https://www.iso.org/standard/65143.html>SQL 2016 documentation Part 5</a></li><li><a href=https://dl.acm.org/doi/10.1145/1376616.1376634>UMASS paper on NFA with shared buffer</a></li></ul></div></article></div><footer class=footer><div class=footer__contained><div class=footer__cols><div class=footer__cols__col><div class=footer__cols__col__logo><img src=/images/beam_logo_circle.svg class=footer__logo alt="Beam logo"></div><div class=footer__cols__col__logo><img src=/images/apache_logo_circle.svg class=footer__logo alt="Apache logo"></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Start</div><div class=footer__cols__col__link><a href=/get-started/beam-overview/>Overview</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-java/>Quickstart (Java)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-py/>Quickstart (Python)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-go/>Quickstart (Go)</a></div><div class=footer__cols__col__link><a href=/get-started/downloads/>Downloads</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Docs</div><div class=footer__cols__col__link><a href=/documentation/programming-guide/>Concepts</a></div><div class=footer__cols__col__link><a href=/documentation/pipelines/design-your-pipeline/>Pipelines</a></div><div class=footer__cols__col__link><a href=/documentation/runners/capability-matrix/>Runners</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Community</div><div class=footer__cols__col__link><a href=/contribute/>Contribute</a></div><div class=footer__cols__col__link><a href=https://projects.apache.org/committee.html?beam target=_blank>Team<img src=/images/external-link-icon.png width=14 height=14 alt="External link."></a></div><div class=footer__cols__col__link><a href=/community/presentation-materials/>Media</a></div><div class=footer__cols__col__link><a href=/community/in-person/>Events/Meetups</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Resources</div><div class=footer__cols__col__link><a href=/blog/>Blog</a></div><div class=footer__cols__col__link><a href=/community/contact-us/>Contact Us</a></div><div class=footer__cols__col__link><a href=https://github.com/apache/beam>GitHub</a></div></div></div></div><div class=footer__bottom>&copy;
<a href=http://www.apache.org>The Apache Software Foundation</a>
| <a href=/privacy_policy>Privacy Policy</a>
| <a href=/feed.xml>RSS Feed</a><br><br>Apache Beam, Apache, Beam, the Beam logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation. All other products or name brands are trademarks of their respective holders, including The Apache Software Foundation.</div></footer></body></html>