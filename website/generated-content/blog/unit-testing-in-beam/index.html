<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Unit Testing in Beam: An opinionated guide</title><meta name=description content="Apache Beam is an open source, unified model and set of language-specific SDKs for defining and executing data processing workflows, and also data ingestion and integration flows, supporting Enterprise Integration Patterns (EIPs) and Domain Specific Languages (DSLs). Dataflow pipelines simplify the mechanics of large-scale batch and streaming data processing and can run on a number of runtimes like Apache Flink, Apache Spark, and Google Cloud Dataflow (a cloud service). Beam also brings DSL in different languages, allowing users to easily implement their data integration processes."><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel=stylesheet><link rel=preload href=/scss/main.min.408fddfe3e8a45f87a5a8c9a839d77db667c1c534e5e5cd0d957ffc3dd6c14cf.css as=style><link href=/scss/main.min.408fddfe3e8a45f87a5a8c9a839d77db667c1c534e5e5cd0d957ffc3dd6c14cf.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-2.2.4.min.js></script><style>.body__contained img{max-width:100%}</style><script type=text/javascript src=/js/bootstrap.min.2979f9a6e32fc42c3e7406339ee9fe76b31d1b52059776a02b4a7fa6a4fd280a.js defer></script>
<script type=text/javascript src=/js/language-switch-v2.min.121952b7980b920320ab229551857669209945e39b05ba2b433a565385ca44c6.js defer></script>
<script type=text/javascript src=/js/fix-menu.min.039174b67107465f2090a493f91e126f7aa797f29420f9edab8a54d9dd4b3d2d.js defer></script>
<script type=text/javascript src=/js/section-nav.min.1405fd5e70fab5f6c54037c269b1d137487d8f3d1b3009032525f6db3fbce991.js defer></script>
<script type=text/javascript src=/js/page-nav.min.af231204c9c52c5089d53a4c02739eacbb7f939e3be1c6ffcc212e0ac4dbf879.js defer></script>
<script type=text/javascript src=/js/expandable-list.min.75a4526624a3b8898fe7fb9e3428c205b581f8b38c7926922467aef17eac69f2.js defer></script>
<script type=text/javascript src=/js/copy-to-clipboard.min.364c06423d7e8993fc42bb4abc38c03195bc8386db26d18774ce775d08d5b18d.js defer></script>
<script type=text/javascript src=/js/calendar.min.336664054fa0f52b08bbd4e3c59b5cb6d63dcfb2b4d602839746516b0817446b.js defer></script>
<script type=text/javascript src=/js/fix-playground-nested-scroll.min.0283f1037cb1b9d5074c6eaf041292b524a8148a7cdb803d5ccd6d1fc4eb3253.js defer></script>
<script type=text/javascript src=/js/anchor-content-jump-fix.min.22d3240f81632e4c11179b9d2aaf37a40da9414333c43aa97344e8b21a7df0e4.js defer></script>
<link rel=alternate type=application/rss+xml title="Apache Beam" href=/feed.xml><link rel=canonical href=/blog/unit-testing-in-beam/ data-proofer-ignore><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.4.1/css/all.css integrity=sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz crossorigin=anonymous><link rel=stylesheet href=https://unpkg.com/swiper@8/swiper-bundle.min.css><script async src=https://platform.twitter.com/widgets.js></script>
<script>(function(e,t,n,s,o,i){e.hj=e.hj||function(){(e.hj.q=e.hj.q||[]).push(arguments)},e._hjSettings={hjid:2182187,hjsv:6},o=t.getElementsByTagName("head")[0],i=t.createElement("script"),i.async=1,i.src=n+e._hjSettings.hjid+s+e._hjSettings.hjsv,o.appendChild(i)})(window,document,"https://static.hotjar.com/c/hotjar-",".js?sv=")</script></head><body class=body><nav class="navigation-bar-mobile header navbar navbar-fixed-top"><div class=navbar-header><a href=/ class=navbar-brand><img alt=Brand style=height:46px;width:43px src=/images/beam_logo_navbar_mobile.png></a>
<a class=navbar-link href=/get-started/>Get Started</a>
<a class=navbar-link href=/documentation/>Documentation</a>
<button type=button class="navbar-toggle menu-open" aria-expanded=false aria-controls=navbar onclick=openMenu()>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="navbar-mask closed"></div><div id=navbar class="navbar-container closed"><button type=button class=navbar-toggle aria-expanded=false aria-controls=navbar id=closeMenu>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button><ul class="nav navbar-nav"><li><div class=searchBar-mobile><script>(function(){var t,n="012923275103528129024:4emlchv9wzi",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><gcse:search></gcse:search></div></li><li><a class=navbar-link href=/about>About</a></li><li><a class=navbar-link href=/get-started/>Get Started</a></li><li><span class=navbar-link>Documentation</span><ul><li><a href=/documentation/>General</a></li><li><a href=/documentation/sdks/java/>Languages</a></li><li><a href=/documentation/runners/capability-matrix/>Runners</a></li><li><a href=/documentation/io/connectors/>I/O Connectors</a></li></ul></li><li><a class=navbar-link href=/roadmap/>Roadmap</a></li><li><a class=navbar-link href=/community/>Community</a></li><li><a class=navbar-link href=/contribute/>Contribute</a></li><li><a class=navbar-link href=/blog/>Blog</a></li><li><a class=navbar-link href=/case-studies/>Case Studies</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/unit-testing-in-beam.md data-proofer-ignore><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M4.543 20h4l10.5-10.5c.53-.53.828-1.25.828-2s-.298-1.47-.828-2-1.25-.828-2-.828-1.47.298-2 .828L4.543 16v4zm9.5-13.5 4 4"/></svg></a></li><li class=dropdown><a href=# class=dropdown-toggle id=apache-dropdown data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px>
&nbsp;Apache
<span class=arrow-icon><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#ff6d00"/><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.535 5.28l4.573 4.818-4.573 4.403"/></svg></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a target=_blank href=https://www.apache.org/>ASF Homepage</a></li><li><a target=_blank href=https://www.apache.org/licenses/>License</a></li><li><a target=_blank href=https://www.apache.org/security/>Security</a></li><li><a target=_blank href=https://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a target=_blank href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a target=_blank href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li></ul></div></nav><nav class=navigation-bar-desktop><a href=/ class=navbar-logo><img src=/images/beam_logo_navbar.png alt="Beam Logo"></a><div class=navbar-bar-left><div class=navbar-links><a class=navbar-link href=/about>About</a>
<a class=navbar-link href=/get-started/>Get Started</a><li class="dropdown navbar-dropdown navbar-dropdown-documentation"><a href=# class="dropdown-toggle navbar-link" role=button aria-haspopup=true aria-expanded=false>Documentation
<span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="11" fill="none" viewBox="0 0 12 11"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.666 4.535 5.847 9.108 1.444 4.535"/></svg></span></a><ul class=dropdown-menu><li><a class=navbar-dropdown-menu-link href=/documentation/>General</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/sdks/java/>Languages</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/runners/capability-matrix/>Runners</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/io/connectors/>I/O Connectors</a></li></ul></li><a class=navbar-link href=/roadmap/>Roadmap</a>
<a class=navbar-link href=/community/>Community</a>
<a class=navbar-link href=/contribute/>Contribute</a>
<a class=navbar-link href=/blog/>Blog</a>
<a class=navbar-link href=/case-studies/>Case Studies</a></div><div id=iconsBar><a type=button onclick=showSearch()><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M10.191 17c3.866.0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm11 4-6-6"/></svg></a><a target=_blank href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/unit-testing-in-beam.md data-proofer-ignore><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M4.543 20h4l10.5-10.5c.53-.53.828-1.25.828-2s-.298-1.47-.828-2-1.25-.828-2-.828-1.47.298-2 .828L4.543 16v4zm9.5-13.5 4 4"/></svg></a><li class="dropdown navbar-dropdown navbar-dropdown-apache"><a href=# class=dropdown-toggle role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px>
&nbsp;Apache
<span class=arrow-icon><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#ff6d00"/><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.535 5.28l4.573 4.818-4.573 4.403"/></svg></span></a><ul class=dropdown-menu><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/>ASF Homepage</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/licenses/>License</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/security/>Security</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li></div><div class="searchBar disappear"><script>(function(){var t,n="012923275103528129024:4emlchv9wzi",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><gcse:search></gcse:search>
<a type=button onclick=endSearch()><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M21.122 20.827 4.727 4.432M21.122 4.43 4.727 20.827"/></svg></a></div></div></nav><div class=header-push></div><div class="top-banners swiper"><div class=swiper-wrapper><div class=swiper-slide><a href=https://tour.beam.apache.org><img class=banner-img-desktop src=/images/banners/tour-of-beam/tour-of-beam-desktop.png alt="Start Tour of Beam">
<img class=banner-img-mobile src=/images/banners/tour-of-beam/tour-of-beam-mobile.png alt="Start Tour of Beam"></a></div><div class=swiper-slide><a href=https://beam.apache.org/documentation/ml/overview/><img class=banner-img-desktop src=/images/banners/machine-learning/machine-learning-desktop.jpg alt="Machine Learning">
<img class=banner-img-mobile src=/images/banners/machine-learning/machine-learning-mobile.jpg alt="Machine Learning"></a></div></div><div class=swiper-pagination></div><div class=swiper-button-prev></div><div class=swiper-button-next></div></div><script src=/js/swiper-bundle.min.min.e0e8f81b0b15728d35ff73c07f42ddbb17a108d6f23df4953cb3e60df7ade675.js></script>
<script src=/js/sliders/top-banners.min.afa7d0a19acf7a3b28ca369490b3d401a619562a2a4c9612577be2f66a4b9855.js></script>
<script>function showSearch(){addPlaceholder();var e,t=document.querySelector(".searchBar");t.classList.remove("disappear"),e=document.querySelector("#iconsBar"),e.classList.add("disappear")}function addPlaceholder(){$("input:text").attr("placeholder","What are you looking for?")}function endSearch(){var e,t=document.querySelector(".searchBar");t.classList.add("disappear"),e=document.querySelector("#iconsBar"),e.classList.remove("disappear")}function blockScroll(){$("body").toggleClass("fixedPosition")}function openMenu(){addPlaceholder(),blockScroll()}</script><div class="body__contained center no__padding content-up"><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class=post-content><div class=post-info><p>blog</p><p>2024/09/13</p></div><header class=post-header><h2 itemprop="name headline">Unit Testing in Beam: An opinionated guide</h1><div class=post-info><span>Svetak Sundhar [<a href=https://twitter.com/svetaksundhar>@svetaksundhar</a>]</span></div></header><div class="arrow-list header-top-margin" itemprop=articleBody><p>Testing remains one of the most fundamental components of software engineering. In this blog post, we shed light on some of the constructs that Apache Beam provides for testing.
We cover an opinionated set of best practices to write unit tests for your data pipeline. This post doesn&rsquo;t include integration tests, and you need to author those separately.
All snippets in this post are included in <a href=https://github.com/apache/beam/blob/master/examples/notebooks/blog/unittests_in_beam.ipynb>this notebook</a>. Additionally, to see tests that exhibit best practices, look at the <a href=https://beam.apache.org/blog/beam-starter-projects/>Beam starter projects</a>, which contain tests that exhibit best practices.</p><h2 id=best-practices>Best practices</h2><p>When testing Beam pipelines, we recommend the following best practices:</p><ol><li><p>Don&rsquo;t write unit tests for the already supported connectors in the Beam Library, such as <code>ReadFromBigQuery</code> and <code>WriteToText</code>. These connectors are already tested in Beam’s test suite to ensure correct functionality. They add unnecessary cost and dependencies to a unit test.</p></li><li><p>Ensure that your function is well tested when using it with <code>Map</code>, <code>FlatMap</code>, or <code>Filter</code>. You can assume your function will work as intended when using <code>Map(your_function)</code>.</p></li><li><p>For more complex transforms such as <code>ParDo</code>’s, side inputs, timestamp inspection, etc., treat the entire transform as a unit, and test it.</p></li><li><p>If needed, use mocking to mock any API calls that might be present in your DoFn. The purpose of mocking is to test your functionality extensively, even if this testing requires a specific response from an API call.</p><ol><li>Be sure to modularize your API calls in separate functions, rather than making the API call directly in the <code>DoFn</code>. This step provides a cleaner experience when mocking the external API calls.</li></ol></li></ol><h2 id=example-1>Example 1</h2><p>Use the following pipeline as an example. You don&rsquo;t have to write a separate unit test to test this function in the context of this pipeline, assuming the function <code>median_house_value_per_bedroom</code> is unit tested elsewhere in the code. You can trust that the <code>Map</code> primitive works as expected (this illustrates point #2 noted previously).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># The following code computes the median house value per bedroom.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>()</span> <span class=k>as</span> <span class=n>p1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=n>result</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>       <span class=n>p1</span>
</span></span><span class=line><span class=cl>       <span class=o>|</span> <span class=n>ReadFromText</span><span class=p>(</span><span class=s2>&#34;/content/sample_data/california_housing_test.csv&#34;</span><span class=p>,</span><span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>median_house_value_per_bedroom</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=o>|</span> <span class=n>WriteToText</span><span class=p>(</span><span class=s2>&#34;/content/example2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>)</span>
</span></span></code></pre></div><h2 id=example-2>Example 2</h2><p>Use the following function as the example. The functions <code>median_house_value_per_bedroom</code> and <code>multiply_by_factor</code> are tested elsewhere, but the pipeline as a whole, which consists of composite transforms, is not.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>()</span> <span class=k>as</span> <span class=n>p2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>p2</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>ReadFromText</span><span class=p>(</span><span class=s2>&#34;/content/sample_data/california_housing_test.csv&#34;</span><span class=p>,</span><span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>median_house_value_per_bedroom</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>multiply_by_factor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>CombinePerKey</span><span class=p>(</span><span class=nb>sum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>WriteToText</span><span class=p>(</span><span class=s2>&#34;/content/example3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><p>The best practice for the previous code is to create a transform with all functions between <code>ReadFromText</code> and <code>WriteToText</code>. This step separates the transformation logic from the I/Os, allowing you to unit test the transformation logic. The following example is a refactoring of the previous code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>transform_data_set</span><span class=p>(</span><span class=n>pcoll</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=n>pcoll</span>
</span></span><span class=line><span class=cl>          <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>median_house_value_per_bedroom</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>multiply_by_factor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>CombinePerKey</span><span class=p>(</span><span class=nb>sum</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define a new class that inherits from beam.PTransform.</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MapAndCombineTransform</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>PTransform</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>expand</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pcoll</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>transform_data_set</span><span class=p>(</span><span class=n>pcoll</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>()</span> <span class=k>as</span> <span class=n>p2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=n>result</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>       <span class=n>p2</span>
</span></span><span class=line><span class=cl>       <span class=o>|</span> <span class=n>ReadFromText</span><span class=p>(</span><span class=s2>&#34;/content/sample_data/california_housing_test.csv&#34;</span><span class=p>,</span><span class=n>skip_header_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       <span class=o>|</span> <span class=n>MapAndCombineTransform</span><span class=p>()</span>
</span></span><span class=line><span class=cl>       <span class=o>|</span> <span class=n>WriteToText</span><span class=p>(</span><span class=s2>&#34;/content/example3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>)</span>
</span></span></code></pre></div><p>This code shows the corresponding unit test for the previous example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>unittest</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=k>as</span> <span class=nn>beam</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.testing.test_pipeline</span> <span class=kn>import</span> <span class=n>TestPipeline</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.testing.util</span> <span class=kn>import</span> <span class=n>assert_that</span><span class=p>,</span> <span class=n>equal_to</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestBeam</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This test corresponds to example 3, and is written to confirm the pipeline works as intended.</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>test_transform_data_set</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>expected</span><span class=o>=</span><span class=p>[(</span><span class=mi>1</span><span class=p>,</span> <span class=mf>10570.185786231425</span><span class=p>),</span> <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mf>13.375337533753376</span><span class=p>),</span> <span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mf>13.315649867374006</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>input_elements</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;-122.050000,37.370000,27.000000,3885.000000,661.000000,1537.000000,606.000000,6.608500,344700.000000&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;121.05,99.99,23.30,39.5,55.55,41.01,10,34,74.30,91.91&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;122.05,100.99,24.30,40.5,56.55,42.01,11,35,75.30,92.91&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;-120.05,39.37,29.00,4085.00,681.00,1557.00,626.00,6.8085,364700.00&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>()</span> <span class=k>as</span> <span class=n>p2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>p2</span>
</span></span><span class=line><span class=cl>                <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>(</span><span class=n>input_elements</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>MapAndCombineTransform</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>assert_that</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=n>equal_to</span><span class=p>(</span><span class=n>expected</span><span class=p>))</span>
</span></span></code></pre></div><h2 id=example-3>Example 3</h2><p>Suppose we write a pipeline that reads data from a JSON file, passes it through a custom function that makes external API calls for parsing, and then writes it to a custom destination (for example, if we need to do some custom data formatting to have data prepared for a downstream application).</p><p>The pipeline has the following structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># The following packages are used to run the example pipelines.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=k>as</span> <span class=nn>beam</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.io</span> <span class=kn>import</span> <span class=n>ReadFromText</span><span class=p>,</span> <span class=n>WriteToText</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>PipelineOptions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyDoFn</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=n>element</span><span class=p>):</span>
</span></span><span class=line><span class=cl>          <span class=n>returned_record</span> <span class=o>=</span> <span class=n>MyApiCall</span><span class=o>.</span><span class=n>get_data</span><span class=p>(</span><span class=s2>&#34;http://my-api-call.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>returned_record</span><span class=p>)</span><span class=o>!=</span><span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Length of record does not match expected length&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>yield</span> <span class=n>returned_record</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>()</span> <span class=k>as</span> <span class=n>p3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=n>p3</span>
</span></span><span class=line><span class=cl>          <span class=o>|</span> <span class=n>ReadFromText</span><span class=p>(</span><span class=s2>&#34;/content/sample_data/anscombe.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>MyDoFn</span><span class=p>())</span>
</span></span><span class=line><span class=cl>          <span class=o>|</span> <span class=n>WriteToText</span><span class=p>(</span><span class=s2>&#34;/content/example1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span></code></pre></div><p>This test checks whether the API response is a record of the wrong length and throws the expected error if the test fails.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>mock</span>  <span class=c1># Install the &#39;mock&#39; module.</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Import the mock package for mocking functionality.</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span><span class=p>,</span><span class=n>patch</span>
</span></span><span class=line><span class=cl><span class=c1># from MyApiCall import get_data</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># MyApiCall is a function that calls get_data to fetch some data by using an API call.</span>
</span></span><span class=line><span class=cl><span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;MyApiCall.get_data&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_error_message_wrong_length</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mock_get_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl> <span class=n>response</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;field1&#39;</span><span class=p>,</span><span class=s1>&#39;field2&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=n>mock_get_data</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=n>mock_get_data</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>json</span><span class=o>.</span><span class=n>return_value</span><span class=o>=</span><span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=n>input_elements</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;-122.050000,37.370000,27.000000,3885.000000,661.000000,1537.000000,606.000000,6.608500,344700.000000&#39;</span><span class=p>]</span> <span class=c1>#input length 9</span>
</span></span><span class=line><span class=cl> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>assertRaisesRegex</span><span class=p>(</span><span class=ne>ValueError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=s2>&#34;Length of record does not match expected length&#39;&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>     <span class=n>p3</span> <span class=o>=</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     <span class=n>result</span> <span class=o>=</span> <span class=n>p3</span> <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>input_elements</span><span class=p>)</span> <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>MyDoFn</span><span class=p>())</span>
</span></span><span class=line><span class=cl>     <span class=n>result</span>
</span></span></code></pre></div><h2 id=other-testing-best-practices>Other testing best practices:</h2><ol><li>Test all error messages that you raise.</li><li>Cover any edge cases that might exist in your data.</li><li>Example 1 could have written the <code>beam.Map</code> step with lambda functions instead of with <code>beam.Map(median_house_value_per_bedroom)</code>:</li></ol><pre tabindex=0><code>beam.Map(lambda x: x.strip().split(&#39;,&#39;)) | beam.Map(lambda x: float(x[8])/float(x[4])
</code></pre><p>Separating lambdas into a helper function by using <code>beam.Map(median_house_value_per_bedroom)</code> is the recommended approach for more testable code, because changes to the function would be modularized.</p><ol start=4><li>Use the <code>assert_that</code> statement to ensure that <code>PCollection</code> values match correctly, as in the previous example.</li></ol><p>For more guidance about testing on Beam and Dataflow, see the <a href=https://cloud.google.com/dataflow/docs/guides/develop-and-test-pipelines>Google Cloud documentation</a>. For more examples of unit testing in Beam, see the <code>base_test.py</code> <a href=https://github.com/apache/beam/blob/736cf50430b375d32093e793e1556567557614e9/sdks/python/apache_beam/ml/inference/base_test.py#L262>code</a>.</p><p>Special thanks to Robert Bradshaw, Danny McCormick, XQ Hu, Surjit Singh, and Rebecca Spzer, who helped refine the ideas in this post.</p></div></div><div class=blog-content><h2>Latest from the blog</h2></div><div class=posts-list><a class=post-card href=/blog/beam-2.67.0/ data-categories="blog release "><div class="post-info post-category"><p>blog & release
                    
   </p><p>2025/08/12</p></div><div class=post><p class=post-title>Apache Beam 2.67.0</p><p class=post-info>Vitalii Terentev</p></div></a><a class=post-card href=/blog/beam-summit-2025-hackathon-pcollectors-blog/ data-categories="blog "><div class="post-info post-category"><p>blog</p><p>2025/07/08</p></div><div class=post><p class=post-title>Our Experience at Beam College 2025: 1st Place Hackathon Winners</p><p class=post-info>Aditya Shukla &
Darshan Kanade</p></div></a><a class=post-card href=/blog/beam-2.66.0/ data-categories="blog release "><div class="post-info post-category"><p>blog & release
                    
   </p><p>2025/07/01</p></div><div class=post><p class=post-title>Apache Beam 2.66.0</p><p class=post-info>Vitalii Terentev</p></div></a></div></article></div><footer class=footer><div class=footer__contained><div class=footer__cols><div class="footer__cols__col footer__cols__col__logos"><div class=footer__cols__col__logo><img src=/images/beam_logo_circle.svg class=footer__logo alt="Beam logo"></div><div class=footer__cols__col__logo><img src=/images/apache_logo_circle.svg class=footer__logo alt="Apache logo"></div></div><div class=footer-wrapper><div class=wrapper-grid><div class=footer__cols__col><div class=footer__cols__col__title>Start</div><div class=footer__cols__col__link><a href=/get-started/beam-overview/>Overview</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-java/>Quickstart (Java)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-py/>Quickstart (Python)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-go/>Quickstart (Go)</a></div><div class=footer__cols__col__link><a href=/get-started/downloads/>Downloads</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Docs</div><div class=footer__cols__col__link><a href=/documentation/programming-guide/>Concepts</a></div><div class=footer__cols__col__link><a href=/documentation/pipelines/design-your-pipeline/>Pipelines</a></div><div class=footer__cols__col__link><a href=/documentation/runners/capability-matrix/>Runners</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Community</div><div class=footer__cols__col__link><a href=/contribute/>Contribute</a></div><div class=footer__cols__col__link><a href=https://projects.apache.org/committee.html?beam target=_blank>Team<img src=/images/external-link-icon.png width=14 height=14 alt="External link."></a></div><div class=footer__cols__col__link><a href=/community/presentation-materials/>Media</a></div><div class=footer__cols__col__link><a href=/community/in-person/>Events/Meetups</a></div><div class=footer__cols__col__link><a href=/community/contact-us/>Contact Us</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Resources</div><div class=footer__cols__col__link><a href=/blog/>Blog</a></div><div class=footer__cols__col__link><a href=https://github.com/apache/beam>GitHub</a></div></div></div><div class=footer__bottom>&copy;
<a href=https://www.apache.org>The Apache Software Foundation</a>
| <a href=/privacy_policy>Privacy Policy</a>
| <a href=/feed.xml>RSS Feed</a><br><br>Apache Beam, Apache, Beam, the Beam logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation. All other products or name brands are trademarks of their respective holders, including The Apache Software Foundation.</div></div><div class="footer__cols__col footer__cols__col__logos"><div class=footer__cols__col--group><div class=footer__cols__col__logo><a href=https://github.com/apache/beam><img src=/images/logos/social-icons/github-logo-150.png class=footer__logo alt="Github logo"></a></div><div class=footer__cols__col__logo><a href=https://www.linkedin.com/company/apache-beam/><img src=/images/logos/social-icons/linkedin-logo-150.png class=footer__logo alt="Linkedin logo"></a></div></div><div class=footer__cols__col--group><div class=footer__cols__col__logo><a href=https://twitter.com/apachebeam><img src=/images/logos/social-icons/twitter-logo-150.png class=footer__logo alt="Twitter logo"></a></div><div class=footer__cols__col__logo><a href=https://www.youtube.com/channel/UChNnb_YO_7B0HlW6FhAXZZQ><img src=/images/logos/social-icons/youtube-logo-150.png class=footer__logo alt="Youtube logo"></a></div></div></div></div></div></footer></body></html>