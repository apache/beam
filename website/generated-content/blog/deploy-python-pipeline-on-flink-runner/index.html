<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Deploy Python pipelines on Kubernetes using the Flink runner</title><meta name=description content="Apache Beam is an open source, unified model and set of language-specific SDKs for defining and executing data processing workflows, and also data ingestion and integration flows, supporting Enterprise Integration Patterns (EIPs) and Domain Specific Languages (DSLs). Dataflow pipelines simplify the mechanics of large-scale batch and streaming data processing and can run on a number of runtimes like Apache Flink, Apache Spark, and Google Cloud Dataflow (a cloud service). Beam also brings DSL in different languages, allowing users to easily implement their data integration processes."><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel=stylesheet><link rel=preload href=/scss/main.min.408fddfe3e8a45f87a5a8c9a839d77db667c1c534e5e5cd0d957ffc3dd6c14cf.css as=style><link href=/scss/main.min.408fddfe3e8a45f87a5a8c9a839d77db667c1c534e5e5cd0d957ffc3dd6c14cf.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-2.2.4.min.js></script><style>.body__contained img{max-width:100%}</style><script type=text/javascript src=/js/bootstrap.min.2979f9a6e32fc42c3e7406339ee9fe76b31d1b52059776a02b4a7fa6a4fd280a.js defer></script>
<script type=text/javascript src=/js/language-switch-v2.min.121952b7980b920320ab229551857669209945e39b05ba2b433a565385ca44c6.js defer></script>
<script type=text/javascript src=/js/fix-menu.min.039174b67107465f2090a493f91e126f7aa797f29420f9edab8a54d9dd4b3d2d.js defer></script>
<script type=text/javascript src=/js/section-nav.min.1405fd5e70fab5f6c54037c269b1d137487d8f3d1b3009032525f6db3fbce991.js defer></script>
<script type=text/javascript src=/js/page-nav.min.af231204c9c52c5089d53a4c02739eacbb7f939e3be1c6ffcc212e0ac4dbf879.js defer></script>
<script type=text/javascript src=/js/expandable-list.min.75a4526624a3b8898fe7fb9e3428c205b581f8b38c7926922467aef17eac69f2.js defer></script>
<script type=text/javascript src=/js/copy-to-clipboard.min.364c06423d7e8993fc42bb4abc38c03195bc8386db26d18774ce775d08d5b18d.js defer></script>
<script type=text/javascript src=/js/calendar.min.336664054fa0f52b08bbd4e3c59b5cb6d63dcfb2b4d602839746516b0817446b.js defer></script>
<script type=text/javascript src=/js/fix-playground-nested-scroll.min.0283f1037cb1b9d5074c6eaf041292b524a8148a7cdb803d5ccd6d1fc4eb3253.js defer></script>
<script type=text/javascript src=/js/anchor-content-jump-fix.min.22d3240f81632e4c11179b9d2aaf37a40da9414333c43aa97344e8b21a7df0e4.js defer></script>
<link rel=alternate type=application/rss+xml title="Apache Beam" href=/feed.xml><link rel=canonical href=/blog/deploy-python-pipeline-on-flink-runner/ data-proofer-ignore><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.4.1/css/all.css integrity=sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz crossorigin=anonymous><link rel=stylesheet href=https://unpkg.com/swiper@8/swiper-bundle.min.css><script async src=https://platform.twitter.com/widgets.js></script>
<script>(function(e,t,n,s,o,i){e.hj=e.hj||function(){(e.hj.q=e.hj.q||[]).push(arguments)},e._hjSettings={hjid:2182187,hjsv:6},o=t.getElementsByTagName("head")[0],i=t.createElement("script"),i.async=1,i.src=n+e._hjSettings.hjid+s+e._hjSettings.hjsv,o.appendChild(i)})(window,document,"https://static.hotjar.com/c/hotjar-",".js?sv=")</script></head><body class=body><nav class="navigation-bar-mobile header navbar navbar-fixed-top"><div class=navbar-header><a href=/ class=navbar-brand><img alt=Brand style=height:46px;width:43px src=/images/beam_logo_navbar_mobile.png></a>
<a class=navbar-link href=/get-started/>Get Started</a>
<a class=navbar-link href=/documentation/>Documentation</a>
<button type=button class="navbar-toggle menu-open" aria-expanded=false aria-controls=navbar onclick=openMenu()>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="navbar-mask closed"></div><div id=navbar class="navbar-container closed"><button type=button class=navbar-toggle aria-expanded=false aria-controls=navbar id=closeMenu>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button><ul class="nav navbar-nav"><li><div class=searchBar-mobile><script>(function(){var t,n="012923275103528129024:4emlchv9wzi",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><gcse:search></gcse:search></div></li><li><a class=navbar-link href=/about>About</a></li><li><a class=navbar-link href=/get-started/>Get Started</a></li><li><span class=navbar-link>Documentation</span><ul><li><a href=/documentation/>General</a></li><li><a href=/documentation/sdks/java/>Languages</a></li><li><a href=/documentation/runners/capability-matrix/>Runners</a></li><li><a href=/documentation/io/connectors/>I/O Connectors</a></li></ul></li><li><a class=navbar-link href=/roadmap/>Roadmap</a></li><li><a class=navbar-link href=/community/>Community</a></li><li><a class=navbar-link href=/contribute/>Contribute</a></li><li><a class=navbar-link href=/blog/>Blog</a></li><li><a class=navbar-link href=/case-studies/>Case Studies</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/deploy-python-pipeline-on-flink-runner.md data-proofer-ignore><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M4.543 20h4l10.5-10.5c.53-.53.828-1.25.828-2s-.298-1.47-.828-2-1.25-.828-2-.828-1.47.298-2 .828L4.543 16v4zm9.5-13.5 4 4"/></svg></a></li><li class=dropdown><a href=# class=dropdown-toggle id=apache-dropdown data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px>
&nbsp;Apache
<span class=arrow-icon><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#ff6d00"/><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.535 5.28l4.573 4.818-4.573 4.403"/></svg></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a target=_blank href=https://www.apache.org/>ASF Homepage</a></li><li><a target=_blank href=https://www.apache.org/licenses/>License</a></li><li><a target=_blank href=https://www.apache.org/security/>Security</a></li><li><a target=_blank href=https://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a target=_blank href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a target=_blank href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li></ul></div></nav><nav class=navigation-bar-desktop><a href=/ class=navbar-logo><img src=/images/beam_logo_navbar.png alt="Beam Logo"></a><div class=navbar-bar-left><div class=navbar-links><a class=navbar-link href=/about>About</a>
<a class=navbar-link href=/get-started/>Get Started</a><li class="dropdown navbar-dropdown navbar-dropdown-documentation"><a href=# class="dropdown-toggle navbar-link" role=button aria-haspopup=true aria-expanded=false>Documentation
<span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="11" fill="none" viewBox="0 0 12 11"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.666 4.535 5.847 9.108 1.444 4.535"/></svg></span></a><ul class=dropdown-menu><li><a class=navbar-dropdown-menu-link href=/documentation/>General</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/sdks/java/>Languages</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/runners/capability-matrix/>Runners</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/io/connectors/>I/O Connectors</a></li></ul></li><a class=navbar-link href=/roadmap/>Roadmap</a>
<a class=navbar-link href=/community/>Community</a>
<a class=navbar-link href=/contribute/>Contribute</a>
<a class=navbar-link href=/blog/>Blog</a>
<a class=navbar-link href=/case-studies/>Case Studies</a></div><div id=iconsBar><a type=button onclick=showSearch()><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M10.191 17c3.866.0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm11 4-6-6"/></svg></a><a target=_blank href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/deploy-python-pipeline-on-flink-runner.md data-proofer-ignore><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M4.543 20h4l10.5-10.5c.53-.53.828-1.25.828-2s-.298-1.47-.828-2-1.25-.828-2-.828-1.47.298-2 .828L4.543 16v4zm9.5-13.5 4 4"/></svg></a><li class="dropdown navbar-dropdown navbar-dropdown-apache"><a href=# class=dropdown-toggle role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px>
&nbsp;Apache
<span class=arrow-icon><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#ff6d00"/><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.535 5.28l4.573 4.818-4.573 4.403"/></svg></span></a><ul class=dropdown-menu><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/>ASF Homepage</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/licenses/>License</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/security/>Security</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li></div><div class="searchBar disappear"><script>(function(){var t,n="012923275103528129024:4emlchv9wzi",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><gcse:search></gcse:search>
<a type=button onclick=endSearch()><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M21.122 20.827 4.727 4.432M21.122 4.43 4.727 20.827"/></svg></a></div></div></nav><div class=header-push></div><div class="top-banners swiper"><div class=swiper-wrapper><div class=swiper-slide><a href=https://tour.beam.apache.org><img class=banner-img-desktop src=/images/banners/tour-of-beam/tour-of-beam-desktop.png alt="Start Tour of Beam">
<img class=banner-img-mobile src=/images/banners/tour-of-beam/tour-of-beam-mobile.png alt="Start Tour of Beam"></a></div><div class=swiper-slide><a href=https://beam.apache.org/documentation/ml/overview/><img class=banner-img-desktop src=/images/banners/machine-learning/machine-learning-desktop.jpg alt="Machine Learning">
<img class=banner-img-mobile src=/images/banners/machine-learning/machine-learning-mobile.jpg alt="Machine Learning"></a></div></div><div class=swiper-pagination></div><div class=swiper-button-prev></div><div class=swiper-button-next></div></div><script src=/js/swiper-bundle.min.min.e0e8f81b0b15728d35ff73c07f42ddbb17a108d6f23df4953cb3e60df7ade675.js></script>
<script src=/js/sliders/top-banners.min.afa7d0a19acf7a3b28ca369490b3d401a619562a2a4c9612577be2f66a4b9855.js></script>
<script>function showSearch(){addPlaceholder();var e,t=document.querySelector(".searchBar");t.classList.remove("disappear"),e=document.querySelector("#iconsBar"),e.classList.add("disappear")}function addPlaceholder(){$("input:text").attr("placeholder","What are you looking for?")}function endSearch(){var e,t=document.querySelector(".searchBar");t.classList.add("disappear"),e=document.querySelector("#iconsBar"),e.classList.remove("disappear")}function blockScroll(){$("body").toggleClass("fixedPosition")}function openMenu(){addPlaceholder(),blockScroll()}</script><div class="body__contained center no__padding content-up"><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class=post-content><div class=post-info><p>blog</p><p>2024/06/20</p></div><header class=post-header><h2 itemprop="name headline">Deploy Python pipelines on Kubernetes using the Flink runner</h1><div class=post-info><span>Jaehyeon Kim</span></div></header><div class="arrow-list header-top-margin" itemprop=articleBody><h1 id=deploy-python-pipelines-on-kubernetes-using-the-flink-runner>Deploy Python pipelines on Kubernetes using the Flink runner</h1><p>The <a href=https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-main/docs/concepts/overview/>Apache Flink Kubernetes Operator</a> acts as a control plane to manage the complete deployment lifecycle of Apache Flink applications. With the operator, we can simplify the deployment and management of Apache Beam pipelines.</p><p>In this post, we develop an <a href=https://beam.apache.org/>Apache Beam</a> pipeline using the <a href=https://beam.apache.org/documentation/sdks/python/>Python SDK</a> and deploy it on an <a href=https://flink.apache.org/>Apache Flink</a> cluster by using the <a href=https://beam.apache.org/documentation/runners/flink/>Apache Flink runner</a>. We first deploy an <a href=https://kafka.apache.org/>Apache Kafka</a> cluster on a <a href=https://minikube.sigs.k8s.io/docs/>minikube</a> cluster, because the pipeline uses Kafka topics for its data source and sink. Then, we develop the pipeline as a Python package and add the package to a custom Docker image so that Python user code can be executed externally. For deployment, we create a Flink session cluster using the Flink Kubernetes Operator, and deploy the pipeline using a Kubernetes job. Finally, we check the output of the application by sending messages to the input Kafka topic using a Python producer application.</p><nav id=TableOfContents><ul><li><a href=#resources-to-run-a-python-beam-pipeline-on-flink>Resources to run a Python Beam pipeline on Flink</a></li><li><a href=#set-up-the-kafka-cluster>Set up the Kafka cluster</a><ul><li><a href=#deploy-the-strimzi-operator>Deploy the Strimzi operator</a></li><li><a href=#deploy-the-kafka-cluster>Deploy the Kafka cluster</a></li><li><a href=#deploy-the-kafka-ui>Deploy the Kafka UI</a></li></ul></li><li><a href=#develop-a-stream-processing-app>Develop a stream processing app</a><ul><li><a href=#beam-pipeline-code>Beam pipeline code</a></li><li><a href=#build-docker-images>Build Docker images</a></li></ul></li><li><a href=#deploy-the-stream-processing-app>Deploy the stream processing app</a><ul><li><a href=#deploy-the-flink-kubernetes-operator>Deploy the Flink Kubernetes Operator</a></li><li><a href=#deploy-the-beam-pipeline>Deploy the Beam pipeline</a></li><li><a href=#kafka-producer>Kafka producer</a></li></ul></li></ul></nav><h2 id=resources-to-run-a-python-beam-pipeline-on-flink>Resources to run a Python Beam pipeline on Flink</h2><p>We develop an Apache Beam pipeline using the Python SDK and deploy it on an Apache Flink cluster using the Apache Flink runner. Although the Flink cluster is created by the Flink Kubernetes Operator, we need two components to run the pipeline on the <em>Flink runner</em>: the <strong>job service</strong> and the <a href=https://beam.apache.org/documentation/runtime/sdk-harness-config/><strong>SDK harness</strong></a>. Roughly speaking, the job service converts details about a Python pipeline into a format that the Flink runner can understand. The SDK harness executes the Python user code. The Python SDK provides convenience wrappers to manage those components, and you can use it by specifying <em>FlinkRunner</em> in the pipeline option, for example, <code>--runner=FlinkRunner</code>. The <em>job service</em> is managed automatically. We rely on our own <em>SDK harness</em> as a sidecar container for simplicity. Also, we need the <strong>Java IO Expansion Service</strong>, because the pipeline uses Apache Kafka topics for its data source and sink, and the Kafka Connector I/O is developed in Java. Simply put, the expansion service is used to serialize data for the Java SDK.</p><h2 id=set-up-the-kafka-cluster>Set up the Kafka cluster</h2><p>An Apache Kafka cluster is deployed using the <a href=https://strimzi.io/>Strimzi Operator</a> on a minikube cluster. We install Strimzi version 0.39.0 and Kubernetes version 1.25.3. After the <a href=https://minikube.sigs.k8s.io/docs/start/>minikube CLI</a> and <a href=https://www.docker.com/>Docker</a> are installed, you can create a minikube cluster by specifying the Kubernetes version. You can find the source code for this blog post in the <a href=https://github.com/jaehyeon-kim/beam-demos/tree/master/beam-deploy>GitHub repository</a>.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>minikube start --cpus<span class=o>=</span><span class=s1>&#39;max&#39;</span> --memory<span class=o>=</span><span class=m>20480</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --addons<span class=o>=</span>metrics-server --kubernetes-version<span class=o>=</span>v1.25.3</span></span></code></pre></div></div></div><h3 id=deploy-the-strimzi-operator>Deploy the Strimzi operator</h3><p>The GitHub repository keeps manifest files that you can use to deploy the Strimzi operator, Kafka cluster, and Kafka management application. To download a different version of the operator, download the relevant manifest file by specifying the version. By default, the manifest file assumes that the resources are deployed in the <em>myproject</em> namespace. However, because we deploy them in the <em>default</em> namespace, we need to change the resource namespace. We change the resource namespace using <a href=https://www.gnu.org/software/sed/manual/sed.html>sed</a>.</p><p>To deploy the operator, use the <code>kubectl create</code> command.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## Download and deploy the Strimzi operator.</span>
</span></span><span class=line><span class=cl><span class=nv>STRIMZI_VERSION</span><span class=o>=</span><span class=s2>&#34;0.39.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Optional: If downloading a different version, include this step.</span>
</span></span><span class=line><span class=cl><span class=nv>DOWNLOAD_URL</span><span class=o>=</span>https://github.com/strimzi/strimzi-kafka-operator/releases/download/<span class=nv>$STRIMZI_VERSION</span>/strimzi-cluster-operator-<span class=nv>$STRIMZI_VERSION</span>.yaml
</span></span><span class=line><span class=cl>curl -L -o kafka/manifests/strimzi-cluster-operator-<span class=nv>$STRIMZI_VERSION</span>.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=si>${</span><span class=nv>DOWNLOAD_URL</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Update the namespace from myproject to default.</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/namespace: .*/namespace: default/&#39;</span> kafka/manifests/strimzi-cluster-operator-<span class=nv>$STRIMZI_VERSION</span>.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Deploy the Strimzi cluster operator.</span>
</span></span><span class=line><span class=cl>kubectl create -f kafka/manifests/strimzi-cluster-operator-<span class=nv>$STRIMZI_VERSION</span>.yaml</span></span></code></pre></div></div></div><p>Verify that the Strimzi Operator runs as a Kubernetes <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/>deployment</a>.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deploy,rs,po
</span></span><span class=line><span class=cl><span class=c1># NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># deployment.apps/strimzi-cluster-operator   1/1     1            1           2m50s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                                                 DESIRED   CURRENT   READY   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># replicaset.apps/strimzi-cluster-operator-8d6d4795c   1         1         1       2m50s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                                           READY   STATUS    RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># pod/strimzi-cluster-operator-8d6d4795c-94t8c   1/1     Running   0          2m49s</span></span></span></code></pre></div></div></div><h3 id=deploy-the-kafka-cluster>Deploy the Kafka cluster</h3><p>We deploy a Kafka cluster with a single broker and Zookeeper node. It has both internal and external listeners on ports 9092 and 29092, respectively. The external listener is used to access the Kafka cluster outside the minikube cluster. Also, the cluster is configured to allow automatic creation of topics (<code>auto.create.topics.enable: "true"</code>), and the default number of partitions is set to 3 (<code>num.partitions: 3</code>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kafka/manifests/kafka-cluster.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kafka.strimzi.io/v1beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kafka</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kafka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>3.5.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>listeners</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>plain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>tls</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>external</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>29092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>nodeport</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>tls</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>jbod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>persistent-claim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>20Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>deleteClaim</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>offsets.topic.replication.factor</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>transaction.state.log.replication.factor</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>transaction.state.log.min.isr</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>default.replication.factor</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>min.insync.replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>inter.broker.protocol.version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>auto.create.topics.enable</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>num.partitions</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>zookeeper</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>persistent-claim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>deleteClaim</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>Deploy he Kafka cluster using the <code>kubectl create</code> command.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f kafka/manifests/kafka-cluster.yaml</span></span></code></pre></div></div></div><p>The Kafka and Zookeeper nodes are managed by the <a href=https://strimzi.io/docs/operators/latest/configuring.html#type-StrimziPodSet-reference><em>StrimziPodSet</em></a> custom resource. It also creates multiple Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/service/>services</a>. In this series, we use the following services:</p><ul><li>communication within the Kubernetes cluster<ul><li><code>demo-cluster-kafka-bootstrap</code> - to access Kafka brokers from the client and management apps</li><li><code>demo-cluster-zookeeper-client</code> - to access Zookeeper node from the management app</li></ul></li><li>communication from the host<ul><li><code>demo-cluster-kafka-external-bootstrap</code> - to access Kafka brokers from the producer app</li></ul></li></ul><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get po,strimzipodsets.core.strimzi.io,svc -l app.kubernetes.io/instance<span class=o>=</span>demo-cluster
</span></span><span class=line><span class=cl><span class=c1># NAME                           READY   STATUS    RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># pod/demo-cluster-kafka-0       1/1     Running   0          115s</span>
</span></span><span class=line><span class=cl><span class=c1># pod/demo-cluster-zookeeper-0   1/1     Running   0          2m20s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                                                   PODS   READY PODS   CURRENT PODS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># strimzipodset.core.strimzi.io/demo-cluster-kafka       1      1            1              115s</span>
</span></span><span class=line><span class=cl><span class=c1># strimzipodset.core.strimzi.io/demo-cluster-zookeeper   1      1            1              2m20s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                               AGE</span>
</span></span><span class=line><span class=cl><span class=c1># service/demo-cluster-kafka-bootstrap            ClusterIP   10.101.175.64    &lt;none&gt;        9091/TCP,9092/TCP                     115s</span>
</span></span><span class=line><span class=cl><span class=c1># service/demo-cluster-kafka-brokers              ClusterIP   None             &lt;none&gt;        9090/TCP,9091/TCP,8443/TCP,9092/TCP   115s</span>
</span></span><span class=line><span class=cl><span class=c1># service/demo-cluster-kafka-external-0           NodePort    10.106.155.20    &lt;none&gt;        29092:32475/TCP                       115s</span>
</span></span><span class=line><span class=cl><span class=c1># service/demo-cluster-kafka-external-bootstrap   NodePort    10.111.244.128   &lt;none&gt;        29092:32674/TCP                       115s</span>
</span></span><span class=line><span class=cl><span class=c1># service/demo-cluster-zookeeper-client           ClusterIP   10.100.215.29    &lt;none&gt;        2181/TCP                              2m20s</span>
</span></span><span class=line><span class=cl><span class=c1># service/demo-cluster-zookeeper-nodes            ClusterIP   None             &lt;none&gt;        2181/TCP,2888/TCP,3888/TCP            2m20s</span></span></span></code></pre></div></div></div><h3 id=deploy-the-kafka-ui>Deploy the Kafka UI</h3><p><a href=https://docs.kafka-ui.provectus.io/overview/readme>UI for Apache Kafka (<code>kafka-ui</code>)</a> is a free and open-source Kafka management application. It&rsquo;s deployed as a Kubernetes Deployment. The Deployment is configured to have a single instance, and the Kafka cluster access details are specified as environment variables.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kafka/manifests/kafka-ui.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>provectuslabs/kafka-ui:v0.7.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kafka-ui-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>KAFKA_CLUSTERS_0_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>demo-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>demo-cluster-kafka-bootstrap:9092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>KAFKA_CLUSTERS_0_ZOOKEEPER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>demo-cluster-zookeeper-client:2181</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span></code></pre></div><p>Deploy the Kafka management app (<code>kafka-ui</code>) using the <code>kubectl create</code> command.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f kafka/manifests/kafka-ui.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get all -l <span class=nv>app</span><span class=o>=</span>kafka-ui
</span></span><span class=line><span class=cl><span class=c1># NAME                            READY   STATUS    RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># pod/kafka-ui-65dbbc98dc-zl5gv   1/1     Running   0          35s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span>
</span></span><span class=line><span class=cl><span class=c1># service/kafka-ui   ClusterIP   10.109.14.33   &lt;none&gt;        8080/TCP   36s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># deployment.apps/kafka-ui   1/1     1            1           35s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                                  DESIRED   CURRENT   READY   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># replicaset.apps/kafka-ui-65dbbc98dc   1         1         1       35s</span></span></span></code></pre></div></div></div><p>We use <code>kubectl port-forward</code> to connect to the <code>kafka-ui</code> server running in the minikube cluster on port 8080.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl port-forward svc/kafka-ui <span class=m>8080</span></span></span></code></pre></div></div></div><p><img class=center-block src=/images/blog/deploy-python-pipeline-on-flink-runner/kafka-ui.png alt="Kafka UI"></p><h2 id=develop-a-stream-processing-app>Develop a stream processing app</h2><p>We develop an Apache Beam pipeline as a Python package and add it to a custom Docker image, which is used to execute Python user code (<em>SDK harness</em>). We also build another custom Docker image, which adds the Java SDK of Apache Beam to the official Flink base image. This image is used to deploy a Flink cluster and to execute Java user code of the <em>Kafka Connector I/O</em>.</p><h3 id=beam-pipeline-code>Beam pipeline code</h3><p>The application first reads text messages from an input Kafka topic. Next, it extracts words by splitting the messages (<code>ReadWordsFromKafka</code>). Then, the elements (words) are added to a fixed time window of 5 seconds, and their average length is calculated (<code>CalculateAvgWordLen</code>). Finally, we include the window start and end timestamps, and send the updated element to an output Kafka topic (<code>WriteWordLenToKafka</code>).</p><p>We create a custom <em>Java IO Expansion Service</em> (<code>get_expansion_service</code>) and add it to the <code>ReadFromKafka</code> and <code>WriteToKafka</code> transforms of the Kafka Connector I/O. Although the Kafka I/O provides a function to create that service, it did not work for me (or I do not understand how to make use of it yet). Instead, I created a custom service, as illustrated in <a href=https://www.packtpub.com/product/building-big-data-pipelines-with-apache-beam/9781800564930>Building Big Data Pipelines with Apache Beam by Jan Lukavský</a>. The expansion service Jar file (<code>beam-sdks-java-io-expansion-service.jar</code>) must exist in the Kubernetes <a href=https://kubernetes.io/docs/concepts/workloads/controllers/job/><em>job</em></a> that executes the pipeline, while the Java SDK (<code>/opt/apache/beam/boot</code>) must exist in the runner worker.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># beam/word_len/word_len.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>typing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=k>as</span> <span class=nn>beam</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam</span> <span class=kn>import</span> <span class=n>pvalue</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.io</span> <span class=kn>import</span> <span class=n>kafka</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.transforms.window</span> <span class=kn>import</span> <span class=n>FixedWindows</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>PipelineOptions</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>SetupOptions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.transforms.external</span> <span class=kn>import</span> <span class=n>JavaJarExpansionService</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_expansion_service</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>jar</span><span class=o>=</span><span class=s2>&#34;/opt/apache/beam/jars/beam-sdks-java-io-expansion-service.jar&#34;</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span> <span class=o>==</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>args</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;--defaultEnvironmentType=PROCESS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;--defaultEnvironmentConfig={&#34;command&#34;: &#34;/opt/apache/beam/boot&#34;}&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;--experiments=use_deprecated_read&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>JavaJarExpansionService</span><span class=p>(</span><span class=n>jar</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;{{PORT}}&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WordAccum</span><span class=p>(</span><span class=n>typing</span><span class=o>.</span><span class=n>NamedTuple</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>length</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>beam</span><span class=o>.</span><span class=n>coders</span><span class=o>.</span><span class=n>registry</span><span class=o>.</span><span class=n>register_coder</span><span class=p>(</span><span class=n>WordAccum</span><span class=p>,</span> <span class=n>beam</span><span class=o>.</span><span class=n>coders</span><span class=o>.</span><span class=n>RowCoder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decode_message</span><span class=p>(</span><span class=n>kafka_kv</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>kafka_kv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>kafka_kv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>tokenize</span><span class=p>(</span><span class=n>element</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;[A-Za-z\&#39;]+&#34;</span><span class=p>,</span> <span class=n>element</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_message</span><span class=p>(</span><span class=n>element</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>([</span><span class=s2>&#34;window_start&#34;</span><span class=p>,</span> <span class=s2>&#34;window_end&#34;</span><span class=p>,</span> <span class=s2>&#34;avg_len&#34;</span><span class=p>],</span> <span class=n>element</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>),</span> <span class=n>msg</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AverageFn</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>CombineFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_accumulator</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>WordAccum</span><span class=p>(</span><span class=n>length</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_input</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mutable_accumulator</span><span class=p>:</span> <span class=n>WordAccum</span><span class=p>,</span> <span class=n>element</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span><span class=p>,</span> <span class=n>count</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>mutable_accumulator</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>WordAccum</span><span class=p>(</span><span class=n>length</span><span class=o>=</span><span class=n>length</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=n>element</span><span class=p>),</span> <span class=n>count</span><span class=o>=</span><span class=n>count</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>merge_accumulators</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>accumulators</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>List</span><span class=p>[</span><span class=n>WordAccum</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=n>lengths</span><span class=p>,</span> <span class=n>counts</span> <span class=o>=</span> <span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=n>accumulators</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>WordAccum</span><span class=p>(</span><span class=n>length</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>lengths</span><span class=p>),</span> <span class=n>count</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>counts</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>extract_output</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>accumulator</span><span class=p>:</span> <span class=n>WordAccum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span><span class=p>,</span> <span class=n>count</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=n>accumulator</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>length</span> <span class=o>/</span> <span class=n>count</span> <span class=k>if</span> <span class=n>count</span> <span class=k>else</span> <span class=nb>float</span><span class=p>(</span><span class=s2>&#34;NaN&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_accumulator_coder</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>beam</span><span class=o>.</span><span class=n>coders</span><span class=o>.</span><span class=n>registry</span><span class=o>.</span><span class=n>get_coder</span><span class=p>(</span><span class=n>WordAccum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AddWindowTS</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>avg_len</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>win_param</span><span class=o>=</span><span class=n>beam</span><span class=o>.</span><span class=n>DoFn</span><span class=o>.</span><span class=n>WindowParam</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>win_param</span><span class=o>.</span><span class=n>start</span><span class=o>.</span><span class=n>to_rfc3339</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>win_param</span><span class=o>.</span><span class=n>end</span><span class=o>.</span><span class=n>to_rfc3339</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>avg_len</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ReadWordsFromKafka</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>PTransform</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap_servers</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>topics</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>group_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>expansion_service</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Any</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>label</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>label</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>boostrap_servers</span> <span class=o>=</span> <span class=n>bootstrap_servers</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>topics</span> <span class=o>=</span> <span class=n>topics</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>group_id</span> <span class=o>=</span> <span class=n>group_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>expansion_service</span> <span class=o>=</span> <span class=n>expansion_service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>expand</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>input</span><span class=p>:</span> <span class=n>pvalue</span><span class=o>.</span><span class=n>PBegin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>input</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;ReadFromKafka&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>&gt;&gt;</span> <span class=n>kafka</span><span class=o>.</span><span class=n>ReadFromKafka</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>consumer_config</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;bootstrap.servers&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>boostrap_servers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;auto.offset.reset&#34;</span><span class=p>:</span> <span class=s2>&#34;latest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=c1># &#34;enable.auto.commit&#34;: &#34;true&#34;,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;group.id&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>group_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>topics</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>topics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp_policy</span><span class=o>=</span><span class=n>kafka</span><span class=o>.</span><span class=n>ReadFromKafka</span><span class=o>.</span><span class=n>create_time_policy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>commit_offset_in_finalize</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>expansion_service</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>expansion_service</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;DecodeMessage&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>decode_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;Tokenize&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>FlatMap</span><span class=p>(</span><span class=n>tokenize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CalculateAvgWordLen</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>PTransform</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>expand</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>input</span><span class=p>:</span> <span class=n>pvalue</span><span class=o>.</span><span class=n>PCollection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>input</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;Windowing&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>WindowInto</span><span class=p>(</span><span class=n>FixedWindows</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;GetAvgWordLength&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>CombineGlobally</span><span class=p>(</span><span class=n>AverageFn</span><span class=p>())</span><span class=o>.</span><span class=n>without_defaults</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WriteWordLenToKafka</span><span class=p>(</span><span class=n>beam</span><span class=o>.</span><span class=n>PTransform</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bootstrap_servers</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>topic</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>expansion_service</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Any</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>label</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>label</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>boostrap_servers</span> <span class=o>=</span> <span class=n>bootstrap_servers</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>topic</span> <span class=o>=</span> <span class=n>topic</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>expansion_service</span> <span class=o>=</span> <span class=n>expansion_service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>expand</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>input</span><span class=p>:</span> <span class=n>pvalue</span><span class=o>.</span><span class=n>PCollection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>input</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;AddWindowTS&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>ParDo</span><span class=p>(</span><span class=n>AddWindowTS</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;CreateMessages&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>create_message</span><span class=p>)</span><span class=o>.</span><span class=n>with_output_types</span><span class=p>(</span><span class=n>typing</span><span class=o>.</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>bytes</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;WriteToKafka&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>&gt;&gt;</span> <span class=n>kafka</span><span class=o>.</span><span class=n>WriteToKafka</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>producer_config</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;bootstrap.servers&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>boostrap_servers</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>topic</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>topic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>expansion_service</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>expansion_service</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>save_main_session</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;Beam pipeline arguments&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--deploy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;deploy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=o>=</span><span class=s2>&#34;store_true&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;Flag to indicate whether to deploy to a cluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--bootstrap_servers&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;bootstrap&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;host.docker.internal:29092&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Kafka bootstrap server addresses&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--input_topic&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;input&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;input-topic&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Kafka input topic name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--output_topic&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;output&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;output-topic-beam&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Kafka output topic name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;--group_id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>dest</span><span class=o>=</span><span class=s2>&#34;group&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;beam-word-len&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Kafka output group ID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>known_args</span><span class=p>,</span> <span class=n>pipeline_args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_known_args</span><span class=p>(</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>known_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>pipeline_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># We use the save_main_session option because one or more DoFn elements in this</span>
</span></span><span class=line><span class=cl>    <span class=c1># workflow rely on global context. That is, a module imported at the module level.</span>
</span></span><span class=line><span class=cl>    <span class=n>pipeline_options</span> <span class=o>=</span> <span class=n>PipelineOptions</span><span class=p>(</span><span class=n>pipeline_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pipeline_options</span><span class=o>.</span><span class=n>view_as</span><span class=p>(</span><span class=n>SetupOptions</span><span class=p>)</span><span class=o>.</span><span class=n>save_main_session</span> <span class=o>=</span> <span class=n>save_main_session</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>expansion_service</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>known_args</span><span class=o>.</span><span class=n>deploy</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>expansion_service</span> <span class=o>=</span> <span class=n>get_expansion_service</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>pipeline_options</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;ReadWordsFromKafka&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>&gt;&gt;</span> <span class=n>ReadWordsFromKafka</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>bootstrap_servers</span><span class=o>=</span><span class=n>known_args</span><span class=o>.</span><span class=n>bootstrap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>topics</span><span class=o>=</span><span class=p>[</span><span class=n>known_args</span><span class=o>.</span><span class=n>input</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>group_id</span><span class=o>=</span><span class=n>known_args</span><span class=o>.</span><span class=n>group</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>expansion_service</span><span class=o>=</span><span class=n>expansion_service</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;CalculateAvgWordLen&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>CalculateAvgWordLen</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>|</span> <span class=s2>&#34;WriteWordLenToKafka&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>&gt;&gt;</span> <span class=n>WriteWordLenToKafka</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>bootstrap_servers</span><span class=o>=</span><span class=n>known_args</span><span class=o>.</span><span class=n>bootstrap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>topic</span><span class=o>=</span><span class=n>known_args</span><span class=o>.</span><span class=n>output</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>expansion_service</span><span class=o>=</span><span class=n>expansion_service</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>()</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Building pipeline ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span><span class=p>()</span>
</span></span></code></pre></div><p>The pipeline script is added to a Python package under a folder named <code>word_len</code>. A simple module named <code>run</code> is created, because it is executed as a module, for example, <code>python -m ...</code>. When I ran the pipeline as a script, I encountered an error. This packaging method is for demonstration only. For a recommended way of packaging a pipeline, see <a href=https://beam.apache.org/documentation/sdks/python-pipeline-dependencies/>Managing Python Pipeline Dependencies</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># beam/word_len/run.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>.</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></div><p>Overall, the pipeline package uses the following structure.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tree beam/word_len
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>beam/word_len
</span></span><span class=line><span class=cl>├── __init__.py
</span></span><span class=line><span class=cl>├── run.py
</span></span><span class=line><span class=cl>└── word_len.py</span></span></code></pre></div></div></div><h3 id=build-docker-images>Build Docker images</h3><p>As discussed previously, we build a custom Docker image (<em>beam-python-example:1.16</em>) and use it to deploy a Flink cluster and to run the Java user code of the Kafka Connector I/O.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=c># beam/Dockerfile</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> flink:1.16</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>apache/beam_java11_sdk:2.56.0 /opt/apache/beam/ /opt/apache/beam/<span class=err>
</span></span></span></code></pre></div><p>We also build a custom Docker image (<em>beam-python-harness:2.56.0</em>) to run Python user code (<em>SDK harness</em>). From the Python SDK Docker image, it first installs the Java Development Kit (JDK) and downloads the <em>Java IO Expansion Service</em> Jar file. Then, the Beam pipeline packages are copied to the <code>/app</code> folder. The app folder is added to the <code>PYTHONPATH</code> environment variable, which makes the packages searchable.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=c># beam/Dockerfile-python-harness</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> apache/beam_python3.10_sdk:2.56.0</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> BEAM_VERSION<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>BEAM_VERSION</span><span class=o>=</span><span class=si>${</span><span class=nv>BEAM_VERSION</span><span class=k>:-</span><span class=nv>2</span><span class=p>.56.0</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>REPO_BASE_URL</span><span class=o>=</span>https://repo1.maven.org/maven2/org/apache/beam<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y default-jdk<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p /opt/apache/beam/jars <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=o>&amp;&amp;</span> wget <span class=si>${</span><span class=nv>REPO_BASE_URL</span><span class=si>}</span>/beam-sdks-java-io-expansion-service/<span class=si>${</span><span class=nv>BEAM_VERSION</span><span class=si>}</span>/beam-sdks-java-io-expansion-service-<span class=si>${</span><span class=nv>BEAM_VERSION</span><span class=si>}</span>.jar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>          --progress<span class=o>=</span>bar:force:noscroll -O /opt/apache/beam/jars/beam-sdks-java-io-expansion-service.jar<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> word_len /app/word_len<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> word_count /app/word_count<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>PYTHONPATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$PYTHONPATH</span><span class=s2>:/app&#34;</span><span class=err>
</span></span></span></code></pre></div><p>Because the custom images need to be accessible in the minikube cluster, we point the terminal&rsquo;s <code>docker-cli</code> to the minikube&rsquo;s Docker engine. Then, we can build the images using the <code>docker build</code> command.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>eval</span> <span class=k>$(</span>minikube docker-env<span class=k>)</span>
</span></span><span class=line><span class=cl>docker build -t beam-python-example:1.16 beam/
</span></span><span class=line><span class=cl>docker build -t beam-python-harness:2.56.0 -f beam/Dockerfile-python-harness beam/</span></span></code></pre></div></div></div><h2 id=deploy-the-stream-processing-app>Deploy the stream processing app</h2><p>The Beam pipeline is executed on a <a href=https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-main/docs/custom-resource/overview/#session-cluster-deployments>Flink session cluster</a>, which is deployed by the Flink Kubernetes Operator. The <a href=https://nightlies.apache.org/flink/flink-kubernetes-operator-docs-main/docs/custom-resource/overview/#application-deployments>application deployment mode</a> where the Beam pipeline is deployed as a Flink job doesn&rsquo;t seem to work (or I don&rsquo;t understand how to do so yet) due to either a job submission timeout error or a failure to upload the job artifact. After the pipeline is deployed, we check the output of the application by sending text messages to the input Kafka topic.</p><h3 id=deploy-the-flink-kubernetes-operator>Deploy the Flink Kubernetes Operator</h3><p>First, to make it possible to add the webhook component, install the <a href=https://github.com/cert-manager/cert-manager>certificate manager</a> on the minikube cluster. Then, use a Helm chart to install the operator. Version 1.8.0 is installed in the post.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f https://github.com/jetstack/cert-manager/releases/download/v1.8.2/cert-manager.yaml
</span></span><span class=line><span class=cl>helm repo add flink-operator-repo https://downloads.apache.org/flink/flink-kubernetes-operator-1.8.0/
</span></span><span class=line><span class=cl>helm install flink-kubernetes-operator flink-operator-repo/flink-kubernetes-operator
</span></span><span class=line><span class=cl><span class=c1># NAME: flink-kubernetes-operator</span>
</span></span><span class=line><span class=cl><span class=c1># LAST DEPLOYED: Mon Jun 03 21:37:45 2024</span>
</span></span><span class=line><span class=cl><span class=c1># NAMESPACE: default</span>
</span></span><span class=line><span class=cl><span class=c1># STATUS: deployed</span>
</span></span><span class=line><span class=cl><span class=c1># REVISION: 1</span>
</span></span><span class=line><span class=cl><span class=c1># TEST SUITE: None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm list
</span></span><span class=line><span class=cl><span class=c1># NAME                            NAMESPACE       REVISION        UPDATED                                         STATUS          CHART                           APP VERSION</span>
</span></span><span class=line><span class=cl><span class=c1># flink-kubernetes-operator       default         1               2024-06-03 21:37:45.579302452 +1000 AEST        deployed        flink-kubernetes-operator-1.8.0 1.8.0</span></span></span></code></pre></div></div></div><h3 id=deploy-the-beam-pipeline>Deploy the Beam pipeline</h3><p>First, create a Flink session cluster. In the manifest file, configure common properties, such as the Docker image, Flink version, cluster configuration, and pod template. These properties are applied to the Flink job manager and task manager. In addition, specify the replica and resource. We add a sidecar container to the task manager, and this <em>SDK harness</em> container is configured to execute Python user code - see the following job configuration.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># beam/word_len_cluster.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>flink.apache.org/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>FlinkDeployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>word-len-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>beam-python-example:1.16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>flinkVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1_16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>flinkConfiguration</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>taskmanager.numberOfTaskSlots</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccount</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-main-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/flink/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobManager</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2048Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>taskManager</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2048Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>podTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>python-harness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>beam-python-harness:2.56.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-worker_pool&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>50000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>harness-port</span><span class=w>
</span></span></span></code></pre></div><p>The pipeline is deployed using a Kubernetes job, and the custom <em>SDK harness</em> image is used to execute the pipeline as a module. The first two arguments are application-specific. The rest of the arguments are for pipeline options. For more information about the pipeline arguments, see the <a href=https://github.com/apache/beam/blob/master/sdks/python/apache_beam/options/pipeline_options.py>pipeline options source</a> and <a href=https://beam.apache.org/documentation/runners/flink/>Flink Runner document</a>. To execute Python user code in the sidecar container, we set the environment type to <code>EXTERNAL</code> and the environment config to <code>localhost:50000</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># beam/word_len_job.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>word-len-job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>word-len-job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>beam-word-len-job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>beam-python-harness:2.56.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;python&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;-m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;word_len.run&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--deploy&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--bootstrap_servers=demo-cluster-kafka-bootstrap:9092&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--runner=FlinkRunner&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--flink_master=word-len-cluster-rest:8081&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--job_name=beam-word-len&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--streaming&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--parallelism=3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--flink_submit_uber_jar&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--environment_type=EXTERNAL&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--environment_config=localhost:50000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--checkpointing_interval=10000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span></code></pre></div><p>Deploy the session cluster and job using the <code>kubectl create</code> command. The session cluster is created by the <em>FlinkDeployment</em> custom resource, and it manages the job manager deployment, task manager pod, and associated services. When we check the log of the job&rsquo;s pod, we see that it does the following tasks:</p><ul><li>starts the <em>Job Service</em> after downloading the Jar file</li><li>uploads the pipeline artifact</li><li>submits the pipeline as a Flink job</li><li>continuously monitors the job status</li></ul><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f beam/word_len_cluster.yml
</span></span><span class=line><span class=cl><span class=c1># flinkdeployment.flink.apache.org/word-len-cluster created</span>
</span></span><span class=line><span class=cl>kubectl create -f beam/word_len_job.yml
</span></span><span class=line><span class=cl><span class=c1># job.batch/word-len-job created</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl logs word-len-job-p5rph -f
</span></span><span class=line><span class=cl><span class=c1># WARNING:apache_beam.options.pipeline_options:Unknown pipeline options received: --checkpointing_interval=10000. Ignore if flags are used for internal purposes.</span>
</span></span><span class=line><span class=cl><span class=c1># WARNING:apache_beam.options.pipeline_options:Unknown pipeline options received: --checkpointing_interval=10000. Ignore if flags are used for internal purposes.</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:root:Building pipeline ...</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:apache_beam.runners.portability.flink_runner:Adding HTTP protocol scheme to flink_master parameter: http://word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># WARNING:apache_beam.options.pipeline_options:Unknown pipeline options received: --checkpointing_interval=10000. Ignore if flags are used for internal purposes.</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:apache_beam.runners.portability.abstract_job_service:Got Prepare request.</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:http://word-len-cluster-rest:8081 &#34;GET /v1/config HTTP/1.1&#34; 200 240</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:apache_beam.utils.subprocess_server:Downloading job server jar from https://repo.maven.apache.org/maven2/org/apache/beam/beam-runners-flink-1.16-job-server/2.56.0/beam-runners-flink-1.16-job-server-2.56.0.jar</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:apache_beam.runners.portability.abstract_job_service:Artifact server started on port 43287</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:apache_beam.runners.portability.abstract_job_service:Prepared job &#39;job&#39; as &#39;job-edc1c2f1-80ef-48b7-af14-7e6fc86f338a&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:apache_beam.runners.portability.abstract_job_service:Running job &#39;job-edc1c2f1-80ef-48b7-af14-7e6fc86f338a&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:http://word-len-cluster-rest:8081 &#34;POST /v1/jars/upload HTTP/1.1&#34; 200 148</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:http://word-len-cluster-rest:8081 &#34;POST /v1/jars/e1984c45-d8bc-4aa1-9b66-369a23826921_beam.jar/run HTTP/1.1&#34; 200 44</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:apache_beam.runners.portability.flink_uber_jar_job_server:Started Flink job as a403cb2f92fecee65b8fd7cc8ac6e68a</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:apache_beam.runners.portability.portable_runner:Job state changed to STOPPED</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:http://word-len-cluster-rest:8081 &#34;GET /v1/jobs/a403cb2f92fecee65b8fd7cc8ac6e68a/execution-result HTTP/1.1&#34; 200 31</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:http://word-len-cluster-rest:8081 &#34;GET /v1/jobs/a403cb2f92fecee65b8fd7cc8ac6e68a/execution-result HTTP/1.1&#34; 200 31</span>
</span></span><span class=line><span class=cl><span class=c1># INFO:apache_beam.runners.portability.portable_runner:Job state changed to RUNNING</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:Starting new HTTP connection (1): word-len-cluster-rest:8081</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:http://word-len-cluster-rest:8081 &#34;GET /v1/jobs/a403cb2f92fecee65b8fd7cc8ac6e68a/execution-result HTTP/1.1&#34; 200 31</span>
</span></span><span class=line><span class=cl><span class=c1># DEBUG:urllib3.connectionpool:http://word-len-cluster-rest:8081 &#34;GET /v1/jobs/a403cb2f92fecee65b8fd7cc8ac6e68a/execution-result HTTP/1.1&#34; 200 31</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span></span></span></code></pre></div></div></div><p>After the deployment completes, we can see the following Flink session cluster and job related resources.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get all -l <span class=nv>app</span><span class=o>=</span>word-len-cluster
</span></span><span class=line><span class=cl><span class=c1># NAME                                    READY   STATUS    RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># pod/word-len-cluster-7c98f6f868-d4hbx   1/1     Running   0          5m32s</span>
</span></span><span class=line><span class=cl><span class=c1># pod/word-len-cluster-taskmanager-1-1    2/2     Running   0          4m3s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE</span>
</span></span><span class=line><span class=cl><span class=c1># service/word-len-cluster        ClusterIP   None           &lt;none&gt;        6123/TCP,6124/TCP   5m32s</span>
</span></span><span class=line><span class=cl><span class=c1># service/word-len-cluster-rest   ClusterIP   10.104.23.28   &lt;none&gt;        8081/TCP            5m32s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># deployment.apps/word-len-cluster   1/1     1            1           5m32s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                                          DESIRED   CURRENT   READY   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># replicaset.apps/word-len-cluster-7c98f6f868   1         1         1       5m32s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get all -l <span class=nv>app</span><span class=o>=</span>word-len-job
</span></span><span class=line><span class=cl><span class=c1># NAME                     READY   STATUS    RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># pod/word-len-job-24r6q   1/1     Running   0          5m24s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NAME                     COMPLETIONS   DURATION   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># job.batch/word-len-job   0/1           5m24s      5m24s</span></span></span></code></pre></div></div></div><p>You can access the Flink web UI using the <code>kubectl port-forward</code> command on port 8081. The job graph shows two tasks. The first task adds word elements into a fixed time window. The second task sends the average word length records to the output topic.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl port-forward svc/flink-word-len-rest <span class=m>8081</span></span></span></code></pre></div></div></div><p><img class=center-block src=/images/blog/deploy-python-pipeline-on-flink-runner/flink-ui.png alt="Flink UI"></p><p>The Kafka I/O automatically creates a topic if it doesn&rsquo;t exist, and we can see the input topic is created on <code>kafka-ui</code>.</p><p><img class=center-block src=/images/blog/deploy-python-pipeline-on-flink-runner/kafka-topics-1.png alt="Kafka Input Topic"></p><h3 id=kafka-producer>Kafka producer</h3><p>A simple Python Kafka producer is created to check the output of the application. By default, the producer app sends random text from the <a href=https://faker.readthedocs.io/en/master/>Faker</a> package to the input Kafka topic every one second.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># kafka/client/producer.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>faker</span> <span class=kn>import</span> <span class=n>Faker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kafka</span> <span class=kn>import</span> <span class=n>KafkaProducer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TextProducer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>bootstrap_servers</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span> <span class=n>topic_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_servers</span> <span class=o>=</span> <span class=n>bootstrap_servers</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>topic_name</span> <span class=o>=</span> <span class=n>topic_name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>kafka_producer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_producer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_producer</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Returns a KafkaProducer instance
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>KafkaProducer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>bootstrap_servers</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>bootstrap_servers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>value_serializer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>v</span><span class=p>:</span> <span class=n>v</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>send_to_kafka</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>timestamp_ms</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Sends text to a Kafka topic.
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>args</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;topic&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>topic_name</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=n>text</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>timestamp_ms</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>args</span> <span class=o>=</span> <span class=p>{</span><span class=o>**</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=p>{</span><span class=s2>&#34;timestamp_ms&#34;</span><span class=p>:</span> <span class=n>timestamp_ms</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>kafka_producer</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=o>**</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>kafka_producer</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;fails to send a message&#34;</span><span class=p>)</span> <span class=kn>from</span> <span class=nn>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>producer</span> <span class=o>=</span> <span class=n>TextProducer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;BOOTSTRAP_SERVERS&#34;</span><span class=p>,</span> <span class=s2>&#34;localhost:29092&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;TOPIC_NAME&#34;</span><span class=p>,</span> <span class=s2>&#34;input-topic&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fake</span> <span class=o>=</span> <span class=n>Faker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>num_events</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>num_events</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>fake</span><span class=o>.</span><span class=n>text</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>producer</span><span class=o>.</span><span class=n>send_to_kafka</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>num_events</span> <span class=o>%</span> <span class=mi>5</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;&lt;&lt;&lt;&lt;&lt;</span><span class=si>{</span><span class=n>num_events</span><span class=si>}</span><span class=s2> text sent... current&gt;&gt;&gt;&gt;</span><span class=se>\n</span><span class=si>{</span><span class=n>text</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;DELAY_SECONDS&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)))</span>
</span></span></code></pre></div><p>Expose the Kafka bootstrap server on port 29092 using the <code>kubectl port-forward</code> command. Execute the Python script to start the producer app.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl port-forward svc/demo-cluster-kafka-external-bootstrap <span class=m>29092</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python kafka/client/producer.py</span></span></code></pre></div></div></div><p>We can see the output topic (<code>output-topic-beam</code>) is created on <code>kafka-ui</code>.</p><p><img class=center-block src=/images/blog/deploy-python-pipeline-on-flink-runner/kafka-topics-2.png alt="Kafka Output Topic"></p><p>Also, we can check that the output messages are created as expected in the <strong>Topics</strong> tab.</p><p><img class=center-block src=/images/blog/deploy-python-pipeline-on-flink-runner/output-topic-messages.png alt="Kafka Output Topic Messages"></p><h1 id=delete-resources>Delete resources</h1><p>Delete the Kubernetes resources and the minikube cluster using the following steps.</p><div class='language-bash snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## Delete the Flink Operator and related resources.</span>
</span></span><span class=line><span class=cl>kubectl delete -f beam/word_len_cluster.yml
</span></span><span class=line><span class=cl>kubectl delete -f beam/word_len_job.yml
</span></span><span class=line><span class=cl>helm uninstall flink-kubernetes-operator
</span></span><span class=line><span class=cl>helm repo remove flink-operator-repo
</span></span><span class=line><span class=cl>kubectl delete -f https://github.com/jetstack/cert-manager/releases/download/v1.8.2/cert-manager.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Delete the Kafka cluster and related resources.</span>
</span></span><span class=line><span class=cl><span class=nv>STRIMZI_VERSION</span><span class=o>=</span><span class=s2>&#34;0.39.0&#34;</span>
</span></span><span class=line><span class=cl>kubectl delete -f kafka/manifests/kafka-cluster.yaml
</span></span><span class=line><span class=cl>kubectl delete -f kafka/manifests/kafka-ui.yaml
</span></span><span class=line><span class=cl>kubectl delete -f kafka/manifests/strimzi-cluster-operator-<span class=nv>$STRIMZI_VERSION</span>.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Delete the minikube.</span>
</span></span><span class=line><span class=cl>minikube delete</span></span></code></pre></div></div></div></div></div><div class=blog-content><h2>Latest from the blog</h2></div><div class=posts-list><a class=post-card href=/blog/gsoc-25-yaml-user-accessibility/ data-categories="blog gsoc "><div class="post-info post-category"><p>blog & gsoc
                    
      </p><p>2025/09/23</p></div><div class=post><p class=post-title>Google Summer of Code 2025 - Beam YAML, Kafka and Iceberg User Accessibility</p><p class=post-info>Charles Nguyen</p></div></a><a class=post-card href=/blog/beam-2.68.0/ data-categories="blog release "><div class="post-info post-category"><p>blog & release
                    
   </p><p>2025/09/22</p></div><div class=post><p class=post-title>Apache Beam 2.68.0</p><p class=post-info>Vitalii Terentev</p></div></a><a class=post-card href=/blog/gsoc-25-infra/ data-categories="blog gsoc "><div class="post-info post-category"><p>blog & gsoc
                    
      </p><p>2025/09/15</p></div><div class=post><p class=post-title>Google Summer of Code 25 - Improving Apache Beam's Infrastructure</p><p class=post-info>Enrique Calderon</p></div></a></div></article></div><footer class=footer><div class=footer__contained><div class=footer__cols><div class="footer__cols__col footer__cols__col__logos"><div class=footer__cols__col__logo><img src=/images/beam_logo_circle.svg class=footer__logo alt="Beam logo"></div><div class=footer__cols__col__logo><img src=/images/apache_logo_circle.svg class=footer__logo alt="Apache logo"></div></div><div class=footer-wrapper><div class=wrapper-grid><div class=footer__cols__col><div class=footer__cols__col__title>Start</div><div class=footer__cols__col__link><a href=/get-started/beam-overview/>Overview</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-java/>Quickstart (Java)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-py/>Quickstart (Python)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-go/>Quickstart (Go)</a></div><div class=footer__cols__col__link><a href=/get-started/downloads/>Downloads</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Docs</div><div class=footer__cols__col__link><a href=/documentation/programming-guide/>Concepts</a></div><div class=footer__cols__col__link><a href=/documentation/pipelines/design-your-pipeline/>Pipelines</a></div><div class=footer__cols__col__link><a href=/documentation/runners/capability-matrix/>Runners</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Community</div><div class=footer__cols__col__link><a href=/contribute/>Contribute</a></div><div class=footer__cols__col__link><a href=https://projects.apache.org/committee.html?beam target=_blank>Team<img src=/images/external-link-icon.png width=14 height=14 alt="External link."></a></div><div class=footer__cols__col__link><a href=/community/presentation-materials/>Media</a></div><div class=footer__cols__col__link><a href=/community/in-person/>Events/Meetups</a></div><div class=footer__cols__col__link><a href=/community/contact-us/>Contact Us</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Resources</div><div class=footer__cols__col__link><a href=/blog/>Blog</a></div><div class=footer__cols__col__link><a href=https://github.com/apache/beam>GitHub</a></div></div></div><div class=footer__bottom>&copy;
<a href=https://www.apache.org>The Apache Software Foundation</a>
| <a href=/privacy_policy>Privacy Policy</a>
| <a href=/feed.xml>RSS Feed</a><br><br>Apache Beam, Apache, Beam, the Beam logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation. All other products or name brands are trademarks of their respective holders, including The Apache Software Foundation.</div></div><div class="footer__cols__col footer__cols__col__logos"><div class=footer__cols__col--group><div class=footer__cols__col__logo><a href=https://github.com/apache/beam><img src=/images/logos/social-icons/github-logo-150.png class=footer__logo alt="Github logo"></a></div><div class=footer__cols__col__logo><a href=https://www.linkedin.com/company/apache-beam/><img src=/images/logos/social-icons/linkedin-logo-150.png class=footer__logo alt="Linkedin logo"></a></div></div><div class=footer__cols__col--group><div class=footer__cols__col__logo><a href=https://twitter.com/apachebeam><img src=/images/logos/social-icons/twitter-logo-150.png class=footer__logo alt="Twitter logo"></a></div><div class=footer__cols__col__logo><a href=https://www.youtube.com/channel/UChNnb_YO_7B0HlW6FhAXZZQ><img src=/images/logos/social-icons/youtube-logo-150.png class=footer__logo alt="Youtube logo"></a></div></div></div></div></div></footer></body></html>