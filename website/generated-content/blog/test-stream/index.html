<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Testing Unbounded Pipelines in Apache Beam</title><meta name=description content="Apache Beam is an open source, unified model and set of language-specific SDKs for defining and executing data processing workflows, and also data ingestion and integration flows, supporting Enterprise Integration Patterns (EIPs) and Domain Specific Languages (DSLs). Dataflow pipelines simplify the mechanics of large-scale batch and streaming data processing and can run on a number of runtimes like Apache Flink, Apache Spark, and Google Cloud Dataflow (a cloud service). Beam also brings DSL in different languages, allowing users to easily implement their data integration processes."><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700" rel=stylesheet><link rel=preload href=/scss/main.min.408fddfe3e8a45f87a5a8c9a839d77db667c1c534e5e5cd0d957ffc3dd6c14cf.css as=style><link href=/scss/main.min.408fddfe3e8a45f87a5a8c9a839d77db667c1c534e5e5cd0d957ffc3dd6c14cf.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-2.2.4.min.js></script><style>.body__contained img{max-width:100%}</style><script type=text/javascript src=/js/bootstrap.min.2979f9a6e32fc42c3e7406339ee9fe76b31d1b52059776a02b4a7fa6a4fd280a.js defer></script>
<script type=text/javascript src=/js/language-switch-v2.min.121952b7980b920320ab229551857669209945e39b05ba2b433a565385ca44c6.js defer></script>
<script type=text/javascript src=/js/fix-menu.min.039174b67107465f2090a493f91e126f7aa797f29420f9edab8a54d9dd4b3d2d.js defer></script>
<script type=text/javascript src=/js/section-nav.min.1405fd5e70fab5f6c54037c269b1d137487d8f3d1b3009032525f6db3fbce991.js defer></script>
<script type=text/javascript src=/js/page-nav.min.af231204c9c52c5089d53a4c02739eacbb7f939e3be1c6ffcc212e0ac4dbf879.js defer></script>
<script type=text/javascript src=/js/expandable-list.min.75a4526624a3b8898fe7fb9e3428c205b581f8b38c7926922467aef17eac69f2.js defer></script>
<script type=text/javascript src=/js/copy-to-clipboard.min.364c06423d7e8993fc42bb4abc38c03195bc8386db26d18774ce775d08d5b18d.js defer></script>
<script type=text/javascript src=/js/calendar.min.336664054fa0f52b08bbd4e3c59b5cb6d63dcfb2b4d602839746516b0817446b.js defer></script>
<script type=text/javascript src=/js/fix-playground-nested-scroll.min.0283f1037cb1b9d5074c6eaf041292b524a8148a7cdb803d5ccd6d1fc4eb3253.js defer></script>
<script type=text/javascript src=/js/anchor-content-jump-fix.min.22d3240f81632e4c11179b9d2aaf37a40da9414333c43aa97344e8b21a7df0e4.js defer></script>
<link rel=alternate type=application/rss+xml title="Apache Beam" href=/feed.xml><link rel=canonical href=/blog/test-stream/ data-proofer-ignore><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.4.1/css/all.css integrity=sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz crossorigin=anonymous><link rel=stylesheet href=https://unpkg.com/swiper@8/swiper-bundle.min.css><script async src=https://platform.twitter.com/widgets.js></script>
<script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-73650088-1","auto"),ga("send","pageview")</script><script>(function(e,t,n,s,o,i){e.hj=e.hj||function(){(e.hj.q=e.hj.q||[]).push(arguments)},e._hjSettings={hjid:2182187,hjsv:6},o=t.getElementsByTagName("head")[0],i=t.createElement("script"),i.async=1,i.src=n+e._hjSettings.hjid+s+e._hjSettings.hjsv,o.appendChild(i)})(window,document,"https://static.hotjar.com/c/hotjar-",".js?sv=")</script></head><body class=body><nav class="navigation-bar-mobile header navbar navbar-fixed-top"><div class=navbar-header><a href=/ class=navbar-brand><img alt=Brand style=height:46px;width:43px src=/images/beam_logo_navbar_mobile.png></a>
<a class=navbar-link href=/get-started/>Get Started</a>
<a class=navbar-link href=/documentation/>Documentation</a>
<button type=button class="navbar-toggle menu-open" aria-expanded=false aria-controls=navbar onclick=openMenu()>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="navbar-mask closed"></div><div id=navbar class="navbar-container closed"><button type=button class=navbar-toggle aria-expanded=false aria-controls=navbar id=closeMenu>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button><ul class="nav navbar-nav"><li><div class=searchBar-mobile><script>(function(){var t,n="012923275103528129024:4emlchv9wzi",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><gcse:search></gcse:search></div></li><li><a class=navbar-link href=/about>About</a></li><li><a class=navbar-link href=/get-started/>Get Started</a></li><li><span class=navbar-link>Documentation</span><ul><li><a href=/documentation/>General</a></li><li><a href=/documentation/sdks/java/>Languages</a></li><li><a href=/documentation/runners/capability-matrix/>Runners</a></li><li><a href=/documentation/io/connectors/>I/O Connectors</a></li></ul></li><li><a class=navbar-link href=/roadmap/>Roadmap</a></li><li><a class=navbar-link href=/community/>Community</a></li><li><a class=navbar-link href=/contribute/>Contribute</a></li><li><a class=navbar-link href=/blog/>Blog</a></li><li><a class=navbar-link href=/case-studies/>Case Studies</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/test-stream.md data-proofer-ignore><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M4.543 20h4l10.5-10.5c.53-.53.828-1.25.828-2s-.298-1.47-.828-2-1.25-.828-2-.828-1.47.298-2 .828L4.543 16v4zm9.5-13.5 4 4"/></svg></a></li><li class=dropdown><a href=# class=dropdown-toggle id=apache-dropdown data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px>
&nbsp;Apache
<span class=arrow-icon><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#ff6d00"/><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.535 5.28l4.573 4.818-4.573 4.403"/></svg></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a target=_blank href=https://www.apache.org/>ASF Homepage</a></li><li><a target=_blank href=https://www.apache.org/licenses/>License</a></li><li><a target=_blank href=https://www.apache.org/security/>Security</a></li><li><a target=_blank href=https://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a target=_blank href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a target=_blank href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li></ul></div></nav><nav class=navigation-bar-desktop><a href=/ class=navbar-logo><img src=/images/beam_logo_navbar.png alt="Beam Logo"></a><div class=navbar-bar-left><div class=navbar-links><a class=navbar-link href=/about>About</a>
<a class=navbar-link href=/get-started/>Get Started</a><li class="dropdown navbar-dropdown navbar-dropdown-documentation"><a href=# class="dropdown-toggle navbar-link" role=button aria-haspopup=true aria-expanded=false>Documentation
<span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="11" fill="none" viewBox="0 0 12 11"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.666 4.535 5.847 9.108 1.444 4.535"/></svg></span></a><ul class=dropdown-menu><li><a class=navbar-dropdown-menu-link href=/documentation/>General</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/sdks/java/>Languages</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/runners/capability-matrix/>Runners</a></li><li><a class=navbar-dropdown-menu-link href=/documentation/io/connectors/>I/O Connectors</a></li></ul></li><a class=navbar-link href=/roadmap/>Roadmap</a>
<a class=navbar-link href=/community/>Community</a>
<a class=navbar-link href=/contribute/>Contribute</a>
<a class=navbar-link href=/blog/>Blog</a>
<a class=navbar-link href=/case-studies/>Case Studies</a></div><div id=iconsBar><a type=button onclick=showSearch()><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M10.191 17c3.866.0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm11 4-6-6"/></svg></a><a target=_blank href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/test-stream.md data-proofer-ignore><svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" fill="none" viewBox="0 0 25 24"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M4.543 20h4l10.5-10.5c.53-.53.828-1.25.828-2s-.298-1.47-.828-2-1.25-.828-2-.828-1.47.298-2 .828L4.543 16v4zm9.5-13.5 4 4"/></svg></a><li class="dropdown navbar-dropdown navbar-dropdown-apache"><a href=# class=dropdown-toggle role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px>
&nbsp;Apache
<span class=arrow-icon><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="10" fill="#ff6d00"/><path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.535 5.28l4.573 4.818-4.573 4.403"/></svg></span></a><ul class=dropdown-menu><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/>ASF Homepage</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/licenses/>License</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/security/>Security</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a class=navbar-dropdown-menu-link target=_blank href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li></div><div class="searchBar disappear"><script>(function(){var t,n="012923275103528129024:4emlchv9wzi",e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx="+n,t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script><gcse:search></gcse:search>
<a type=button onclick=endSearch()><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25"><path stroke="#ff6d00" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.75" d="M21.122 20.827 4.727 4.432M21.122 4.43 4.727 20.827"/></svg></a></div></div></nav><div class=header-push></div><div class="top-banners swiper"><div class=swiper-wrapper><div class=swiper-slide><a href=https://tour.beam.apache.org><img class=banner-img-desktop src=/images/banners/tour-of-beam/tour-of-beam-desktop.png alt="Start Tour of Beam">
<img class=banner-img-mobile src=/images/banners/tour-of-beam/tour-of-beam-mobile.png alt="Start Tour of Beam"></a></div><div class=swiper-slide><a href=https://beam.apache.org/documentation/ml/overview/><img class=banner-img-desktop src=/images/banners/machine-learning/machine-learning-desktop.jpg alt="Machine Learning">
<img class=banner-img-mobile src=/images/banners/machine-learning/machine-learning-mobile.jpg alt="Machine Learning"></a></div></div><div class=swiper-pagination></div><div class=swiper-button-prev></div><div class=swiper-button-next></div></div><script src=/js/swiper-bundle.min.min.e0e8f81b0b15728d35ff73c07f42ddbb17a108d6f23df4953cb3e60df7ade675.js></script>
<script src=/js/sliders/top-banners.min.afa7d0a19acf7a3b28ca369490b3d401a619562a2a4c9612577be2f66a4b9855.js></script>
<script>function showSearch(){addPlaceholder();var e,t=document.querySelector(".searchBar");t.classList.remove("disappear"),e=document.querySelector("#iconsBar"),e.classList.add("disappear")}function addPlaceholder(){$("input:text").attr("placeholder","What are you looking for?")}function endSearch(){var e,t=document.querySelector(".searchBar");t.classList.add("disappear"),e=document.querySelector("#iconsBar"),e.classList.remove("disappear")}function blockScroll(){$("body").toggleClass("fixedPosition")}function openMenu(){addPlaceholder(),blockScroll()}</script><div class="body__contained center no__padding content-up"><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class=post-content><div class=post-info><p>blog</p><p>2016/10/20</p></div><header class=post-header><h2 itemprop="name headline">Testing Unbounded Pipelines in Apache Beam</h1><div class=post-info><span>Thomas Groh</span></div></header><div class="arrow-list header-top-margin" itemprop=articleBody><p>The Beam Programming Model unifies writing pipelines for Batch and Streaming
pipelines. We’ve recently introduced a new PTransform to write tests for
pipelines that will be run over unbounded datasets and must handle out-of-order
and delayed data.</p><p>Watermarks, Windows and Triggers form a core part of the Beam programming model
&ndash; they respectively determine how your data are grouped, when your input is
complete, and when to produce results. This is true for all pipelines,
regardless of if they are processing bounded or unbounded inputs. If you’re not
familiar with watermarks, windowing, and triggering in the Beam model,
<a href=https://www.oreilly.com/ideas/the-world-beyond-batch-streaming-101>Streaming 101</a>
and <a href=https://www.oreilly.com/ideas/the-world-beyond-batch-streaming-102>Streaming 102</a>
are an excellent place to get started. A key takeaway from
these articles: in realistic streaming scenarios with intermittent failures and
disconnected users, data can arrive out of order or be delayed. Beam’s
primitives provide a way for users to perform useful, powerful, and correct
computations in spite of these challenges.</p><p>As Beam pipeline authors, we need comprehensive tests that cover crucial
failure scenarios and corner cases to gain real confidence that a pipeline is
ready for production. The existing testing infrastructure within the Beam SDKs
permits tests to be written which examine the contents of a Pipeline at
execution time. However, writing unit tests for pipelines that may receive
late data or trigger multiple times has historically ranged from complex to
not possible, as pipelines that read from unbounded sources do not shut down
without external intervention, while pipelines that read from bounded sources
exclusively cannot test behavior with late data nor most speculative triggers.
Without additional tools, pipelines that use custom triggers and handle
out-of-order data could not be easily tested.</p><p>This blog post introduces our new framework for writing tests for pipelines that
handle delayed and out-of-order data in the context of the LeaderBoard pipeline
from the Mobile Gaming example series.</p><h2 id=leaderboard-and-the-mobile-gaming-example>LeaderBoard and the Mobile Gaming Example</h2><p><a href=https://github.com/apache/beam/blob/master/examples/java/src/main/java/org/apache/beam/examples/complete/game/LeaderBoard.java#L177>LeaderBoard</a>
is part of the <a href=https://github.com/apache/beam/tree/master/examples/java/src/main/java/org/apache/beam/examples/complete/game>Beam mobile gaming examples</a>
(and <a href=/get-started/mobile-gaming-example/>walkthroughs</a>)
which produces a continuous accounting of user and team scores. User scores are
calculated over the lifetime of the program, while team scores are calculated
within fixed windows with a default duration of one hour. The LeaderBoard
pipeline produces speculative and late panes as appropriate, based on the
configured triggering and allowed lateness of the pipeline. The expected outputs
of the LeaderBoard pipeline vary depending on when elements arrive in relation
to the watermark and the progress of processing time, which could not previously
be controlled within a test.</p><h2 id=writing-deterministic-tests-to-emulate-nondeterminism>Writing Deterministic Tests to Emulate Nondeterminism</h2><p>The Beam testing infrastructure provides the
<a href=https://beam.apache.org/releases/javadoc/2.59.0/org/apache/beam/sdk/testing/PAssert.html>PAssert</a>
methods, which assert properties about the contents of a PCollection from within
a pipeline. We have expanded this infrastructure to include
<a href=https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/TestStream.java>TestStream</a>,
which is a PTransform that performs a series of events, consisting of adding
additional elements to a pipeline, advancing the watermark of the TestStream,
and advancing the pipeline processing time clock. TestStream permits tests which
observe the effects of triggers on the output a pipeline produces.</p><p>While executing a pipeline that reads from a TestStream, the read waits for all
of the consequences of each event to complete before continuing on to the next
event, ensuring that when processing time advances, triggers that are based on
processing time fire as appropriate. With this transform, the effect of
triggering and allowed lateness can be observed on a pipeline, including
reactions to speculative and late panes and dropped data.</p><h2 id=element-timings>Element Timings</h2><p>Elements arrive either before, with, or after the watermark, which categorizes
them into the &ldquo;early&rdquo;, &ldquo;on-time&rdquo;, and &ldquo;late&rdquo; divisions. &ldquo;Late&rdquo; elements can be
further subdivided into &ldquo;unobservably&rdquo;, &ldquo;observably&rdquo;, and &ldquo;droppably&rdquo; late,
depending on the window to which they are assigned and the maximum allowed
lateness, as specified by the windowing strategy. Elements that arrive with
these timings are emitted into panes, which can be &ldquo;EARLY&rdquo;, &ldquo;ON-TIME&rdquo;, or
&ldquo;LATE&rdquo;, depending on the position of the watermark when the pane was emitted.</p><p>Using TestStream, we can write tests that demonstrate that speculative panes are
output after their trigger condition is met, that the advancing of the watermark
causes the on-time pane to be produced, and that late-arriving data produces
refinements when it arrives before the maximum allowed lateness, and is dropped
after.</p><p>The following examples demonstrate how you can use TestStream to provide a
sequence of events to the Pipeline, where the arrival of elements is interspersed
with updates to the watermark and the advance of processing time. Each of these
events runs to completion before additional events occur.</p><p>In the diagrams, the time at which events occurred in &ldquo;real&rdquo; (event) time
progresses as the graph moves to the right. The time at which the pipeline
receives them progresses as the graph goes upwards. The watermark is represented
by the squiggly red line, and each starburst is the firing of a trigger and the
associated pane.</p><img class=center-block src=/images/blog/test-stream/elements-all-on-time.png alt="Elements on the Event and Processing time axes, with the Watermark and produced panes" width=442><h3 id=everything-arrives-on-time>Everything arrives on-time</h3><p>For example, if we create a TestStream where all the data arrives before the
watermark and provide the result PCollection as input to the CalculateTeamScores
PTransform:</p><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>createEvents</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>))))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Move the watermark past the end the end of the window
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                       <span class=o>.</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></span></span></code></pre></div></div></div><p>we can then assert that the result PCollection contains elements that arrived:</p><img class=center-block src=/images/blog/test-stream/elements-all-on-time.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Only one value is emitted for the blue team
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>inWindow</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>18</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></span></span></code></pre></div></div></div><h3 id=some-elements-are-late-but-arrive-before-the-end-of-the-window>Some elements are late, but arrive before the end of the window</h3><p>We can also add data to the TestStream after the watermark, but before the end
of the window (shown below to the left of the red watermark), which demonstrates
&ldquo;unobservably late&rdquo; data - that is, data that arrives late, but is promoted by
the system to be on time, as it arrives before the watermark passes the end of
the window</p><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>createEvents</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>))))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Move the watermark up to &#34;near&#34; the end of the window
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                       <span class=o>.</span><span class=na>minus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>ZERO</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></span></span></code></pre></div></div></div><img class=center-block src=/images/blog/test-stream/elements-unobservably-late.png alt="An element arrives late, but before the watermark passes the end of the window, and is produced in the on-time pane" width=442><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Only one value is emitted for the blue team
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>inWindow</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>18</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></span></span></code></pre></div></div></div><h3 id=elements-are-late-and-arrive-after-the-end-of-the-window>Elements are late, and arrive after the end of the window</h3><p>By advancing the watermark farther in time before adding the late data, we can
demonstrate the triggering behavior that causes the system to emit an on-time
pane, and then after the late data arrives, a pane that refines the result.</p><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>createEvents</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>))))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Move the watermark up to &#34;near&#34; the end of the window
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                       <span class=o>.</span><span class=na>minus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>ZERO</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></span></span></code></pre></div></div></div><img class=center-block src=/images/blog/test-stream/elements-observably-late.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// An on-time pane is emitted with the events that arrived before the window closed
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>inOnTimePane</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>6</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=c1>// The final pane contains the late refinement
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>inFinalPane</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>18</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></span></span></code></pre></div></div></div><h3 id=elements-are-late-and-after-the-end-of-the-window-plus-the-allowed-lateness>Elements are late, and after the end of the window plus the allowed lateness</h3><p>If we push the watermark even further into the future, beyond the maximum
configured allowed lateness, we can demonstrate that the late element is dropped
by the system.</p><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>createEvents</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>ZERO</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Move the watermark up to &#34;near&#34; the end of the window
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>plus</span><span class=o>(</span><span class=n>ALLOWED_LATENESS</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                     <span class=s>&#34;sky&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                     <span class=s>&#34;blue&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                     <span class=n>12</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                     <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>).</span><span class=na>minus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>))))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></span></span></code></pre></div></div></div><img class=center-block src=/images/blog/test-stream/elements-droppably-late.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// An on-time pane is emitted with the events that arrived before the window closed
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>inWindow</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>6</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></span></span></code></pre></div></div></div><h3 id=elements-arrive-before-the-end-of-the-window-and-some-processing-time-passes>Elements arrive before the end of the window, and some processing time passes</h3><p>Using additional methods, we can demonstrate the behavior of speculative
triggers by advancing the processing time of the TestStream. If we add elements
to an input PCollection, occasionally advancing the processing time clock, and
apply <code>CalculateUserScores</code></p><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>createEvents</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>))))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>advanceProcessingTime</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>12</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;oxblood&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardSeconds</span><span class=o>(</span><span class=n>22</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>2</span><span class=o>))))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>advanceProcessingTime</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>15</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>userScores</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateUserScores</span><span class=o>(</span><span class=n>ALLOWED_LATENESS</span><span class=o>));</span></span></span></code></pre></div></div></div><img class=center-block src=/images/blog/test-stream/elements-processing-speculative.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class='language-java snippet'><div class="notebook-skip code-snippet"><a class=copy type=button data-bs-toggle=tooltip data-bs-placement=bottom title="Copy to clipboard"><img src=/images/copy-icon.svg></a><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>userScores</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>inEarlyGlobalWindowPanes</span><span class=o>()</span>
</span></span><span class=line><span class=cl>       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=n>5</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                           <span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=n>9</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                           <span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;oxblood&#34;</span><span class=o>,</span> <span class=n>2</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></span></span></code></pre></div></div></div><h2 id=teststream---under-the-hood>TestStream - Under the Hood</h2><p>TestStream relies on a pipeline concept we’ve introduced, called quiescence, to
utilize the existing runner infrastructure while providing guarantees about when
a root transform will called by the runner. This consists of properties about
pending elements and triggers, namely:</p><ul><li>No trigger is permitted to fire but has not fired</li><li>All elements are either buffered in state or cannot progress until a side input becomes available</li></ul><p>Simplified, this means that, in the absence of an advancement in input
watermarks or processing time, or additional elements being added to the
pipeline, the pipeline will not make progress. Whenever the TestStream PTransform
performs an action, the runner must not reinvoke the same instance until the
pipeline has quiesced. This ensures that the events specified by TestStream
happen &ldquo;in-order&rdquo;, which ensures that input watermarks and the system clock do
not advance ahead of the elements they hoped to hold up.</p><p>The DirectRunner has been modified to use quiescence as the signal that it
should add more work to the Pipeline, and the implementation of TestStream in
that runner uses this fact to perform a single output per event. The DirectRunner
implementation also directly controls the runner’s system clock, ensuring that
tests will complete promptly even if there is a multi-minute processing time
trigger located within the pipeline.</p><p>The TestStream transform is supported in the DirectRunner. For most users, tests
written using TestPipeline and PAsserts will automatically function while using
TestStream.</p><h2 id=summary>Summary</h2><p>The addition of TestStream alongside window and pane-specific matchers in PAssert
has enabled the testing of Pipelines which produce speculative and late panes.
This permits tests for all styles of pipeline to be expressed directly within the
Java SDK. If you have questions or comments, we’d love to hear them on the
<a href=/get-started/support/>mailing lists</a>.</p></div></div><div class=blog-content><h2>Latest from the blog</h2></div><div class=posts-list><a class=post-card href=/blog/unit-testing-in-beam/ data-categories="blog "><div class="post-info post-category"><p>blog</p><p>2024/09/13</p></div><div class=post><p class=post-title>Unit Testing in Beam: An opinionated guide</p><p class=post-info>Svetak Sundhar</p></div></a><a class=post-card href=/blog/beam-2.59.0/ data-categories="blog release "><div class="post-info post-category"><p>blog & release
                    
   </p><p>2024/09/11</p></div><div class=post><p class=post-title>Apache Beam 2.59.0</p><p class=post-info>Robert Burke</p></div></a><a class=post-card href=/blog/beam-2.58.1/ data-categories="blog release "><div class="post-info post-category"><p>blog & release
                    
   </p><p>2024/08/15</p></div><div class=post><p class=post-title>Apache Beam 2.58.1</p><p class=post-info>Danny McCormick</p></div></a></div></article></div><footer class=footer><div class=footer__contained><div class=footer__cols><div class="footer__cols__col footer__cols__col__logos"><div class=footer__cols__col__logo><img src=/images/beam_logo_circle.svg class=footer__logo alt="Beam logo"></div><div class=footer__cols__col__logo><img src=/images/apache_logo_circle.svg class=footer__logo alt="Apache logo"></div></div><div class=footer-wrapper><div class=wrapper-grid><div class=footer__cols__col><div class=footer__cols__col__title>Start</div><div class=footer__cols__col__link><a href=/get-started/beam-overview/>Overview</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-java/>Quickstart (Java)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-py/>Quickstart (Python)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-go/>Quickstart (Go)</a></div><div class=footer__cols__col__link><a href=/get-started/downloads/>Downloads</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Docs</div><div class=footer__cols__col__link><a href=/documentation/programming-guide/>Concepts</a></div><div class=footer__cols__col__link><a href=/documentation/pipelines/design-your-pipeline/>Pipelines</a></div><div class=footer__cols__col__link><a href=/documentation/runners/capability-matrix/>Runners</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Community</div><div class=footer__cols__col__link><a href=/contribute/>Contribute</a></div><div class=footer__cols__col__link><a href=https://projects.apache.org/committee.html?beam target=_blank>Team<img src=/images/external-link-icon.png width=14 height=14 alt="External link."></a></div><div class=footer__cols__col__link><a href=/community/presentation-materials/>Media</a></div><div class=footer__cols__col__link><a href=/community/in-person/>Events/Meetups</a></div><div class=footer__cols__col__link><a href=/community/contact-us/>Contact Us</a></div></div><div class=footer__cols__col><div class=footer__cols__col__title>Resources</div><div class=footer__cols__col__link><a href=/blog/>Blog</a></div><div class=footer__cols__col__link><a href=https://github.com/apache/beam>GitHub</a></div></div></div><div class=footer__bottom>&copy;
<a href=https://www.apache.org>The Apache Software Foundation</a>
| <a href=/privacy_policy>Privacy Policy</a>
| <a href=/feed.xml>RSS Feed</a><br><br>Apache Beam, Apache, Beam, the Beam logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation. All other products or name brands are trademarks of their respective holders, including The Apache Software Foundation.</div></div><div class="footer__cols__col footer__cols__col__logos"><div class=footer__cols__col--group><div class=footer__cols__col__logo><a href=https://github.com/apache/beam><img src=/images/logos/social-icons/github-logo-150.png class=footer__logo alt="Github logo"></a></div><div class=footer__cols__col__logo><a href=https://www.linkedin.com/company/apache-beam/><img src=/images/logos/social-icons/linkedin-logo-150.png class=footer__logo alt="Linkedin logo"></a></div></div><div class=footer__cols__col--group><div class=footer__cols__col__logo><a href=https://twitter.com/apachebeam><img src=/images/logos/social-icons/twitter-logo-150.png class=footer__logo alt="Twitter logo"></a></div><div class=footer__cols__col__logo><a href=https://www.youtube.com/channel/UChNnb_YO_7B0HlW6FhAXZZQ><img src=/images/logos/social-icons/youtube-logo-150.png class=footer__logo alt="Youtube logo"></a></div></div></div></div></div></footer></body></html>