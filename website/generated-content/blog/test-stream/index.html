<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Testing Unbounded Pipelines in Apache Beam</title><meta name=description content="Apache Beam is an open source, unified model and set of language-specific SDKs for defining and executing data processing workflows, and also data ingestion and integration flows, supporting Enterprise Integration Patterns (EIPs) and Domain Specific Languages (DSLs). Dataflow pipelines simplify the mechanics of large-scale batch and streaming data processing and can run on a number of runtimes like Apache Flink, Apache Spark, and Google Cloud Dataflow (a cloud service). Beam also brings DSL in different languages, allowing users to easily implement their data integration processes."><link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400" rel=stylesheet><link rel=preload href=/scss/main.min.7bfa213b38fe814e9a5d5af502d4d2e0d4e9e7dfe8a528843e32a858c6c92bc2.css as=style><link href=/scss/main.min.7bfa213b38fe814e9a5d5af502d4d2e0d4e9e7dfe8a528843e32a858c6c92bc2.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-2.2.4.min.js></script><style>.body__contained img{max-width:100%}</style><script src=/js/bootstrap.min.js></script><script src=/js/language-switch.js></script><script src=/js/fix-menu.js></script><script src=/js/section-nav.js></script><script src=/js/page-nav.js></script><link rel=alternate type=application/rss+xml title="Apache Beam" href=/feed.xml><link rel=canonical href=/blog/test-stream/ data-proofer-ignore><link rel="shortcut icon" type=image/x-icon href=/images/favicon.ico><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.4.1/css/all.css integrity=sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz crossorigin=anonymous><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-73650088-1','auto');ga('send','pageview');</script></head><body class=body><nav class="header navbar navbar-fixed-top"><div class=navbar-header><button type=button class=navbar-toggle aria-expanded=false aria-controls=navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a href=/ class=navbar-brand><img alt=Brand style=height:25px src=/images/beam_logo_navbar.png></a></div><div class="navbar-mask closed"></div><div id=navbar class="navbar-container closed"><ul class="nav navbar-nav"><li><a href=/get-started/beam-overview/>Get Started</a></li><li><a href=/documentation/>Documentation</a></li><li><a href=/documentation/sdks/java/>Languages</a></li><li><a href=/documentation/runners/capability-matrix/>RUNNERS</a></li><li><a href=/roadmap/>Roadmap</a></li><li><a href=/contribute/>Contribute</a></li><li><a href=/community/contact-us/>Community</a></li><li><a href=/blog/>Blog</a></li></ul><ul class="nav navbar-nav navbar-right"><li><div style=width:300px><script>(function(){var cx='012923275103528129024:4emlchv9wzi';var gcse=document.createElement('script');gcse.type='text/javascript';gcse.async=true;gcse.src='https://cse.google.com/cse.js?cx='+cx;var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(gcse,s);})();</script><gcse:search></gcse:search></div></li><li class=dropdown><a href=# class=dropdown-toggle data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false><img src=https://www.apache.org/foundation/press/kit/feather_small.png alt="Apache Logo" style=height:20px><span class=caret></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a href=http://www.apache.org/>ASF Homepage</a></li><li><a href=http://www.apache.org/licenses/>License</a></li><li><a href=http://www.apache.org/security/>Security</a></li><li><a href=http://www.apache.org/foundation/thanks.html>Thanks</a></li><li><a href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=https://www.apache.org/foundation/policies/conduct>Code of Conduct</a></li></ul></li><li><a href=https://github.com/apache/beam/edit/master/website/www/site/content/en/blog/test-stream.md data-proofer-ignore><i class="far fa-edit fa-lg" alt="Edit on GitHub" title="Edit on GitHub"></i></a></li></ul></div></nav><div class=body__contained><article class=post itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Testing Unbounded Pipelines in Apache Beam</h1><p class=post-meta><time datetime=2016-10-20T10:00:00-08:00 itemprop=datePublished>Oct 20, 2016</time>
•
Thomas Groh</p></header><div class=post-content itemprop=articleBody><p>The Beam Programming Model unifies writing pipelines for Batch and Streaming
pipelines. We’ve recently introduced a new PTransform to write tests for
pipelines that will be run over unbounded datasets and must handle out-of-order
and delayed data.</p><p>Watermarks, Windows and Triggers form a core part of the Beam programming model
&ndash; they respectively determine how your data are grouped, when your input is
complete, and when to produce results. This is true for all pipelines,
regardless of if they are processing bounded or unbounded inputs. If you’re not
familiar with watermarks, windowing, and triggering in the Beam model,
<a href=https://www.oreilly.com/ideas/the-world-beyond-batch-streaming-101>Streaming 101</a>
and <a href=https://www.oreilly.com/ideas/the-world-beyond-batch-streaming-102>Streaming 102</a>
are an excellent place to get started. A key takeaway from
these articles: in realistic streaming scenarios with intermittent failures and
disconnected users, data can arrive out of order or be delayed. Beam’s
primitives provide a way for users to perform useful, powerful, and correct
computations in spite of these challenges.</p><p>As Beam pipeline authors, we need comprehensive tests that cover crucial
failure scenarios and corner cases to gain real confidence that a pipeline is
ready for production. The existing testing infrastructure within the Beam SDKs
permits tests to be written which examine the contents of a Pipeline at
execution time. However, writing unit tests for pipelines that may receive
late data or trigger multiple times has historically ranged from complex to
not possible, as pipelines that read from unbounded sources do not shut down
without external intervention, while pipelines that read from bounded sources
exclusively cannot test behavior with late data nor most speculative triggers.
Without additional tools, pipelines that use custom triggers and handle
out-of-order data could not be easily tested.</p><p>This blog post introduces our new framework for writing tests for pipelines that
handle delayed and out-of-order data in the context of the LeaderBoard pipeline
from the Mobile Gaming example series.</p><h2 id=leaderboard-and-the-mobile-gaming-example>LeaderBoard and the Mobile Gaming Example</h2><p><a href=https://github.com/apache/beam/blob/master/examples/java/src/main/java/org/apache/beam/examples/complete/game/LeaderBoard.java#L177>LeaderBoard</a>
is part of the <a href=https://github.com/apache/beam/tree/master/examples/java/src/main/java/org/apache/beam/examples/complete/game>Beam mobile gaming examples</a>
(and <a href=/get-started/mobile-gaming-example/>walkthroughs</a>)
which produces a continuous accounting of user and team scores. User scores are
calculated over the lifetime of the program, while team scores are calculated
within fixed windows with a default duration of one hour. The LeaderBoard
pipeline produces speculative and late panes as appropriate, based on the
configured triggering and allowed lateness of the pipeline. The expected outputs
of the LeaderBoard pipeline vary depending on when elements arrive in relation
to the watermark and the progress of processing time, which could not previously
be controlled within a test.</p><h2 id=writing-deterministic-tests-to-emulate-nondeterminism>Writing Deterministic Tests to Emulate Nondeterminism</h2><p>The Beam testing infrastructure provides the
<a href=https://beam.apache.org/releases/javadoc/2.23.0/org/apache/beam/sdk/testing/PAssert.html>PAssert</a>
methods, which assert properties about the contents of a PCollection from within
a pipeline. We have expanded this infrastructure to include
<a href=https://github.com/apache/beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/testing/TestStream.java>TestStream</a>,
which is a PTransform that performs a series of events, consisting of adding
additional elements to a pipeline, advancing the watermark of the TestStream,
and advancing the pipeline processing time clock. TestStream permits tests which
observe the effects of triggers on the output a pipeline produces.</p><p>While executing a pipeline that reads from a TestStream, the read waits for all
of the consequences of each event to complete before continuing on to the next
event, ensuring that when processing time advances, triggers that are based on
processing time fire as appropriate. With this transform, the effect of
triggering and allowed lateness can be observed on a pipeline, including
reactions to speculative and late panes and dropped data.</p><h2 id=element-timings>Element Timings</h2><p>Elements arrive either before, with, or after the watermark, which categorizes
them into the &ldquo;early&rdquo;, &ldquo;on-time&rdquo;, and &ldquo;late&rdquo; divisions. &ldquo;Late&rdquo; elements can be
further subdivided into &ldquo;unobservably&rdquo;, &ldquo;observably&rdquo;, and &ldquo;droppably&rdquo; late,
depending on the window to which they are assigned and the maximum allowed
lateness, as specified by the windowing strategy. Elements that arrive with
these timings are emitted into panes, which can be &ldquo;EARLY&rdquo;, &ldquo;ON-TIME&rdquo;, or
&ldquo;LATE&rdquo;, depending on the position of the watermark when the pane was emitted.</p><p>Using TestStream, we can write tests that demonstrate that speculative panes are
output after their trigger condition is met, that the advancing of the watermark
causes the on-time pane to be produced, and that late-arriving data produces
refinements when it arrives before the maximum allowed lateness, and is dropped
after.</p><p>The following examples demonstrate how you can use TestStream to provide a
sequence of events to the Pipeline, where the arrival of elements is interspersed
with updates to the watermark and the advance of processing time. Each of these
events runs to completion before additional events occur.</p><p>In the diagrams, the time at which events occurred in &ldquo;real&rdquo; (event) time
progresses as the graph moves to the right. The time at which the pipeline
receives them progresses as the graph goes upwards. The watermark is represented
by the squiggly red line, and each starburst is the firing of a trigger and the
associated pane.</p><img class=center-block src=/images/blog/test-stream/elements-all-on-time.png alt="Elements on the Event and Processing time axes, with the Watermark and produced panes" width=442><h3 id=everything-arrives-on-time>Everything arrives on-time</h3><p>For example, if we create a TestStream where all the data arrives before the
watermark and provide the result PCollection as input to the CalculateTeamScores
PTransform:</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>infos</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>))))</span>
    <span class=c1>// Move the watermark past the end the end of the window
</span><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
                                       <span class=o>.</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>

<span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></code></pre></div></div><p>we can then assert that the result PCollection contains elements that arrived:</p><img class=center-block src=/images/blog/test-stream/elements-all-on-time.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=c1>// Only one value is emitted for the blue team
</span><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
       <span class=o>.</span><span class=na>inWindow</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>18</span><span class=o>));</span>
<span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></code></pre></div></div><h3 id=some-elements-are-late-but-arrive-before-the-end-of-the-window>Some elements are late, but arrive before the end of the window</h3><p>We can also add data to the TestStream after the watermark, but before the end
of the window (shown below to the left of the red watermark), which demonstrates
&ldquo;unobservably late&rdquo; data - that is, data that arrives late, but is promoted by
the system to be on time, as it arrives before the watermark passes the end of
the window</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>infos</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>))))</span>
    <span class=c1>// Move the watermark up to &#34;near&#34; the end of the window
</span><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
                                       <span class=o>.</span><span class=na>minus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>ZERO</span><span class=o>))</span>
    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>

<span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></code></pre></div></div><img class=center-block src=/images/blog/test-stream/elements-unobservably-late.png alt="An element arrives late, but before the watermark passes the end of the window, and is produced in the on-time pane" width=442><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=c1>// Only one value is emitted for the blue team
</span><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
       <span class=o>.</span><span class=na>inWindow</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>18</span><span class=o>));</span>
<span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></code></pre></div></div><h3 id=elements-are-late-and-arrive-after-the-end-of-the-window>Elements are late, and arrive after the end of the window</h3><p>By advancing the watermark farther in time before adding the late data, we can
demonstrate the triggering behavior that causes the system to emit an on-time
pane, and then after the late data arrives, a pane that refines the result.</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>infos</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>))))</span>
    <span class=c1>// Move the watermark up to &#34;near&#34; the end of the window
</span><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
                                       <span class=o>.</span><span class=na>minus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>12</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>ZERO</span><span class=o>))</span>
    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>

<span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></code></pre></div></div><img class=center-block src=/images/blog/test-stream/elements-observably-late.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=c1>// An on-time pane is emitted with the events that arrived before the window closed
</span><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
       <span class=o>.</span><span class=na>inOnTimePane</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>6</span><span class=o>));</span>
<span class=c1>// The final pane contains the late refinement
</span><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
       <span class=o>.</span><span class=na>inFinalPane</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>18</span><span class=o>));</span>
<span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></code></pre></div></div><h3 id=elements-are-late-and-after-the-end-of-the-window-plus-the-allowed-lateness>Elements are late, and after the end of the window plus the allowed lateness</h3><p>If we push the watermark even further into the future, beyond the maximum
configured allowed lateness, we can demonstrate that the late element is dropped
by the system.</p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>TestStream</span><span class=o>&lt;</span><span class=n>GameActionInfo</span><span class=o>&gt;</span> <span class=n>infos</span> <span class=o>=</span> <span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;sky&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>ZERO</span><span class=o>),</span>
                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;navy&#34;</span><span class=o>,</span> <span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>3</span><span class=o>)))</span>
    <span class=c1>// Move the watermark up to &#34;near&#34; the end of the window
</span><span class=c1></span>    <span class=o>.</span><span class=na>advanceWatermarkTo</span><span class=o>(</span><span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>)</span>
                                         <span class=o>.</span><span class=na>plus</span><span class=o>(</span><span class=n>ALLOWED_LATENESS</span><span class=o>)</span>
                                         <span class=o>.</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>)))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span>
                     <span class=s>&#34;sky&#34;</span><span class=o>,</span>
                     <span class=s>&#34;blue&#34;</span><span class=o>,</span>
                     <span class=n>12</span><span class=o>,</span>
                     <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>).</span><span class=na>minus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>))))</span>
    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>

<span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>teamScores</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>createEvents</span><span class=o>)</span>
    <span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateTeamScores</span><span class=o>(</span><span class=n>TEAM_WINDOW_DURATION</span><span class=o>,</span> <span class=n>ALLOWED_LATENESS</span><span class=o>));</span></code></pre></div></div><img class=center-block src=/images/blog/test-stream/elements-droppably-late.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=c1>// An on-time pane is emitted with the events that arrived before the window closed
</span><span class=c1></span><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>teamScores</span><span class=o>)</span>
       <span class=o>.</span><span class=na>inWindow</span><span class=o>(</span><span class=n>window</span><span class=o>)</span>
       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;blue&#34;</span><span class=o>,</span> <span class=n>6</span><span class=o>));</span>

<span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></code></pre></div></div><h3 id=elements-arrive-before-the-end-of-the-window-and-some-processing-time-passes>Elements arrive before the end of the window, and some processing time passes</h3><p>Using additional methods, we can demonstrate the behavior of speculative
triggers by advancing the processing time of the TestStream. If we add elements
to an input PCollection, occasionally advancing the processing time clock, and
apply <code>CalculateUserScores</code></p><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>TestStream</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>AvroCoder</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>GameActionInfo</span><span class=o>.</span><span class=na>class</span><span class=o>))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>3</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)),</span>
                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>1</span><span class=o>))))</span>
    <span class=o>.</span><span class=na>advanceProcessingTime</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>12</span><span class=o>))</span>
    <span class=o>.</span><span class=na>addElements</span><span class=o>(</span><span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;oxblood&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>)).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardSeconds</span><span class=o>(</span><span class=n>22</span><span class=o>)),</span>
                 <span class=k>new</span> <span class=n>GameActionInfo</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=s>&#34;red&#34;</span><span class=o>,</span> <span class=n>4</span><span class=o>,</span> <span class=k>new</span> <span class=n>Instant</span><span class=o>(</span><span class=n>0L</span><span class=o>).</span><span class=na>plus</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>2</span><span class=o>))))</span>
    <span class=o>.</span><span class=na>advanceProcessingTime</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>standardMinutes</span><span class=o>(</span><span class=n>15</span><span class=o>))</span>
    <span class=o>.</span><span class=na>advanceWatermarkToInfinity</span><span class=o>();</span>

<span class=n>PCollection</span><span class=o>&lt;</span><span class=n>KV</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Integer</span><span class=o>&gt;&gt;</span> <span class=n>userScores</span> <span class=o>=</span>
    <span class=n>p</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>infos</span><span class=o>).</span><span class=na>apply</span><span class=o>(</span><span class=k>new</span> <span class=n>CalculateUserScores</span><span class=o>(</span><span class=n>ALLOWED_LATENESS</span><span class=o>));</span></code></pre></div></div><img class=center-block src=/images/blog/test-stream/elements-processing-speculative.png alt="Elements all arrive before the watermark, and are produced in the on-time pane" width=442><div class=language-java><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>PAssert</span><span class=o>.</span><span class=na>that</span><span class=o>(</span><span class=n>userScores</span><span class=o>)</span>
       <span class=o>.</span><span class=na>inEarlyGlobalWindowPanes</span><span class=o>()</span>
       <span class=o>.</span><span class=na>containsInAnyOrder</span><span class=o>(</span><span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=n>5</span><span class=o>),</span>
                           <span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;scarlet&#34;</span><span class=o>,</span> <span class=n>9</span><span class=o>),</span>
                           <span class=n>KV</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;oxblood&#34;</span><span class=o>,</span> <span class=n>2</span><span class=o>));</span>

<span class=n>p</span><span class=o>.</span><span class=na>run</span><span class=o>();</span></code></pre></div></div><h2 id=teststream---under-the-hood>TestStream - Under the Hood</h2><p>TestStream relies on a pipeline concept we’ve introduced, called quiescence, to
utilize the existing runner infrastructure while providing guarantees about when
a root transform will called by the runner. This consists of properties about
pending elements and triggers, namely:</p><ul><li>No trigger is permitted to fire but has not fired</li><li>All elements are either buffered in state or cannot progress until a side input becomes available</li></ul><p>Simplified, this means that, in the absence of an advancement in input
watermarks or processing time, or additional elements being added to the
pipeline, the pipeline will not make progress. Whenever the TestStream PTransform
performs an action, the runner must not reinvoke the same instance until the
pipeline has quiesced. This ensures that the events specified by TestStream
happen &ldquo;in-order&rdquo;, which ensures that input watermarks and the system clock do
not advance ahead of the elements they hoped to hold up.</p><p>The DirectRunner has been modified to use quiescence as the signal that it
should add more work to the Pipeline, and the implementation of TestStream in
that runner uses this fact to perform a single output per event. The DirectRunner
implementation also directly controls the runner’s system clock, ensuring that
tests will complete promptly even if there is a multi-minute processing time
trigger located within the pipeline.</p><p>The TestStream transform is supported in the DirectRunner. For most users, tests
written using TestPipeline and PAsserts will automatically function while using
TestStream.</p><h2 id=summary>Summary</h2><p>The addition of TestStream alongside window and pane-specific matchers in PAssert
has enabled the testing of Pipelines which produce speculative and late panes.
This permits tests for all styles of pipeline to be expressed directly within the
Java SDK. If you have questions or comments, we’d love to hear them on the
<a href=/get-started/support/>mailing lists</a>.</p></div></article></div><footer class=footer><div class=footer__contained><div class=footer__cols><div class=footer__cols__col><div class=footer__cols__col__logo><img src=/images/beam_logo_circle.svg class=footer__logo alt="Beam logo"></div><div class=footer__cols__col__logo><img src=/images/apache_logo_circle.svg class=footer__logo alt="Apache logo"></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Start</div><div class=footer__cols__col__link><a href=/get-started/beam-overview/>Overview</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-java/>Quickstart (Java)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-py/>Quickstart (Python)</a></div><div class=footer__cols__col__link><a href=/get-started/quickstart-go/>Quickstart (Go)</a></div><div class=footer__cols__col__link><a href=/get-started/downloads/>Downloads</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Docs</div><div class=footer__cols__col__link><a href=/documentation/programming-guide/>Concepts</a></div><div class=footer__cols__col__link><a href=/documentation/pipelines/design-your-pipeline/>Pipelines</a></div><div class=footer__cols__col__link><a href=/documentation/runners/capability-matrix/>Runners</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Community</div><div class=footer__cols__col__link><a href=/contribute/>Contribute</a></div><div class=footer__cols__col__link><a href=https://projects.apache.org/committee.html?beam target=_blank>Team<img src=/images/external-link-icon.png width=14 height=14 alt="External link."></a></div><div class=footer__cols__col__link><a href=/community/presentation-materials/>Media</a></div><div class=footer__cols__col__link><a href=/community/in-person/>Events/Meetups</a></div></div><div class="footer__cols__col footer__cols__col--md"><div class=footer__cols__col__title>Resources</div><div class=footer__cols__col__link><a href=/blog/>Blog</a></div><div class=footer__cols__col__link><a href=/community/contact-us/>Contact Us</a></div><div class=footer__cols__col__link><a href=https://github.com/apache/beam>GitHub</a></div></div></div></div><div class=footer__bottom>&copy;
<a href=http://www.apache.org>The Apache Software Foundation</a>
| <a href=/privacy_policy>Privacy Policy</a>
| <a href=/feed.xml>RSS Feed</a><br><br>Apache Beam, Apache, Beam, the Beam logo, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation. All other products or name brands are trademarks of their respective holders, including The Apache Software Foundation.</div></footer></body></html>